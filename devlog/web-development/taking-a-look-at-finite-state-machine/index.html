<!doctype html><html lang=en><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1,viewport-fit=cover" name=viewport><meta content="interest-cohort=()" http-equiv=Permissions-Policy><title>
  Taking a look at finite state machines | Devlog
</title><link href=https://vonheikemen.github.io/devlog/print.css media=print rel=stylesheet><link href=https://vonheikemen.github.io/devlog/styles.css rel=stylesheet><link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" rel=stylesheet><link href=https://vonheikemen.github.io/devlog/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://hachyderm.io/@vonheikemen rel=me><link href=https://twitter.com/VonHeikemen_ rel=me><meta content="javascript, learning, beginners, software, coding, development" name=keywords><meta content="Let's see if finite state machines are useful" name=description><link href=https://dev.to/vonheikemen/taking-a-look-at-finite-state-machines-2g9i rel=canonical><body class=theme-base-custom><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vonheikemen.github.io/devlog/><h1>Devlog</h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>whoami</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/tags/>Explore tags</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/es/>Devlog en español</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/atom.xml>RSS</a></ul> © 2020-2026 Heiker Curiel</div></div><div class="content container"><div class=post><h1 class=post-title>Taking a look at finite state machines</h1><span class=post-date>2019-11-07 | Originally published at <a href=https://dev.to/vonheikemen/taking-a-look-at-finite-state-machines-2g9i> dev.to </a> | 6 min read | <a href=https://vonheikemen.github.io/devlog/es/web-development/taking-a-look-at-finite-state-machine/> Leer en español </a> </span><h2 id=the-finite-who-what>The finite who-- what?</h2><p>It is a way of modeling the behavior of a system. The idea is that your "system" can only be in one state at any given time, and an input (or event) can trigger the transition to another state.<h2 id=what-kind-of-problems-does-it-solve>What kind of problems does it solve?</h2><p>Invalid state. How many times have you used a flag or attribute like "disabled" to prevent a user from doing something they shouldn't do? By setting the rules of our system we can avoid these kind of problems.<h2 id=how-does-that-look-like-in-javascript>How does that look like in javascript?</h2><p>I'm very glad you asked. The real reason I'm writing this is to show you a library that I saw the other day. We are going to use <a rel="noopener external" href=https://thisrobot.life/ target=_blank>robot3</a> to built a random quote machine.<p>We will make a card that displays a quote and below that we'll have a button that will fetch another quote.<p>We'll do it one step at a time. Let's first prepare the states.<p>Our card will be either <code>idle</code> or <code>loading</code>. Create a machine with that.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#ffa066>import</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span>  createMachine</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span>  state</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span>  interpret</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span><span style=color:#957fb8> from</span><span style=color:#98bb6c> 'https://unpkg.com/robot3@0.2.9/machine.js'</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>const</span><span> mr_robot</span><span style=color:#e6c384> =</span><span style=color:#7e9cd8> createMachine</span><span style=color:#9cabca>({</span></span>
<span class=giallo-l><span>  idle</span><span style=color:#9cabca>:</span><span style=color:#7e9cd8> state</span><span style=color:#9cabca>(),</span></span>
<span class=giallo-l><span>  loading</span><span style=color:#9cabca>:</span><span style=color:#7e9cd8> state</span><span style=color:#9cabca>()</span></span>
<span class=giallo-l><span style=color:#9cabca>});</span></span></code></pre><p>In here each <code>state</code> is a key in the "setup object" that we pass to <code>createMachine</code>, but also notice that it needs to be a <code>state</code> object, which we create with the <code>state</code> function.<p>Now we need transitions. Our <code>idle</code> state will switch to <code>loading</code> if a <code>fetch</code> event happens, <code>loading</code> will go back to <code>idle</code> if a <code>done</code> is dispatched.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span> import {</span></span>
<span class=giallo-l><span>  createMachine,</span></span>
<span class=giallo-l><span>  state,</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a> transition,</span></span>
<span class=giallo-l><span>  interpret</span></span>
<span class=giallo-l><span> } from 'https://unpkg.com/robot3@0.2.9/machine.js';</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>const mr_robot = createMachine({</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  idle: state(),</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  loading: state()</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  idle: state(transition('fetch', 'loading')),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  loading: state(transition('done', 'idle'))</span></span>
<span class=giallo-l><span> });</span></span></code></pre><p><code>transition</code> is the thing that connects our states. It's first parameter is the name of the event that will trigger the transition, the second parameter is the "destination" state it will switch to. The rest of <code>transition</code>'s parameters can be a list of function that will be executed when this transition is triggered.<p>Looks lovely, but uhm... how do we test it? The machine by itself doesn't do anything. We need to give our new machine to the <code>interpret</code> function which will give us a "service" that can dispatch events. To prove that we are actually doing something we'll also give a handler to <code>interpret</code>, it will be like a 'onchange', it will listen to state changes.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#957fb8>const</span><span style=color:#7e9cd8> handler</span><span style=color:#e6c384> =</span><span style=color:#9cabca> ({</span><span> machine</span><span style=color:#9cabca> })</span><span style=color:#957fb8> =></span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span>  console</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>log</span><span style=color:#9cabca>(</span><span>machine</span><span style=color:#9cabca>.</span><span style=color:#e6c384>current</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>const</span><span style=color:#9cabca> {</span><span> send</span><span style=color:#9cabca> }</span><span style=color:#e6c384> =</span><span style=color:#7e9cd8> interpret</span><span style=color:#9cabca>(</span><span>mr_robot</span><span style=color:#9cabca>,</span><span> handler</span><span style=color:#9cabca>);</span></span></code></pre><p>Now you can see if it's alive.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'fetch'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'fetch'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'fetch'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'done'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#727169>// You should see in the console</span></span>
<span class=giallo-l><span style=color:#727169>// loading (3)</span></span>
<span class=giallo-l><span style=color:#727169>// idle</span></span></code></pre><p>Dispatching <code>fetch</code> will turn the current state to <code>loading</code> and <code>done</code> will get it back to <code>idle</code>. I see you're not impressed. That's fine. Let's try something, let's add another state <code>end</code> and make <code>loading</code> switch to that, then dispatch <code>done</code> and see what happens.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span> const mr_robot = createMachine({</span></span>
<span class=giallo-l><span>   idle: state(transition('fetch', 'loading')),</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>   loading: state(transition('done', 'idle'))</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>   loading: state(transition('done', 'end')),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>   end: state()</span></span>
<span class=giallo-l><span> });</span></span></code></pre><pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'done'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#727169>// You should see in the console</span></span>
<span class=giallo-l><span style=color:#727169>// idle</span></span></code></pre><p>Sending <code>done</code> while <code>idle</code> doesn't trigger a <code>loading</code> state, it stays in <code>idle</code> because that state doesn't have a <code>done</code> event. And now...<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#727169>// We do the usual flow.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'fetch'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'done'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#727169>// You should have</span></span>
<span class=giallo-l><span style=color:#727169>// loading</span></span>
<span class=giallo-l><span style=color:#727169>// end</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#727169>// Now try again `fetch`</span></span>
<span class=giallo-l><span style=color:#7e9cd8>send</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'fetch'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#727169>// You should have</span></span>
<span class=giallo-l><span style=color:#727169>// end</span></span></code></pre><p>If you send <code>fetch</code> (or any other event) while in <code>end</code> state will give you <code>end</code> every single time. Why? Because you can't go anywhere, <code>end</code> doesn't have transitions.<p>I hope you see why this is useful. If not, I apologize for all the <code>console.log</code>ing.<p>Going back to our current machine. This what we got so far.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#ffa066> import</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span>  createMachine</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span>  state</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span>  transition</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span>  interpret</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span><span style=color:#957fb8> from</span><span style=color:#98bb6c> 'https://unpkg.com/robot3@0.2.9/machine.js'</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>const</span><span> mr_robot</span><span style=color:#e6c384> =</span><span style=color:#7e9cd8> createMachine</span><span style=color:#9cabca>({</span></span>
<span class=giallo-l><span>  idle</span><span style=color:#9cabca>:</span><span style=color:#7e9cd8> state</span><span style=color:#9cabca>(</span><span style=color:#7e9cd8>transition</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'fetch'</span><span style=color:#9cabca>,</span><span style=color:#98bb6c> 'loading'</span><span style=color:#9cabca>)),</span></span>
<span class=giallo-l><span>  loading</span><span style=color:#9cabca>:</span><span style=color:#7e9cd8> state</span><span style=color:#9cabca>(</span><span style=color:#7e9cd8>transition</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'done'</span><span style=color:#9cabca>,</span><span style=color:#98bb6c> 'idle'</span><span style=color:#9cabca>))</span></span>
<span class=giallo-l><span style=color:#9cabca>});</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>const</span><span style=color:#7e9cd8> handler</span><span style=color:#e6c384> =</span><span style=color:#9cabca> ({</span><span> machine</span><span style=color:#9cabca> })</span><span style=color:#957fb8> =></span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span>  console</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>log</span><span style=color:#9cabca>(</span><span>machine</span><span style=color:#9cabca>.</span><span style=color:#e6c384>current</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>const</span><span style=color:#9cabca> {</span><span> send</span><span style=color:#9cabca> }</span><span style=color:#e6c384> =</span><span style=color:#7e9cd8> interpret</span><span style=color:#9cabca>(</span><span>mr_robot</span><span style=color:#9cabca>,</span><span> handler</span><span style=color:#9cabca>);</span></span></code></pre><p>But this is still not enough, now we need to get some data when we enter the <code>loading</code> state. Let's first fake our quote fetching function.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#957fb8>function</span><span style=color:#7e9cd8> get_quote</span><span style=color:#9cabca>() {</span></span>
<span class=giallo-l><span style=color:#727169>  // make a random delay, 3 to 5 seconds.</span></span>
<span class=giallo-l><span style=color:#957fb8>  const</span><span> delay</span><span style=color:#e6c384> =</span><span style=color:#7e9cd8> random_number</span><span style=color:#9cabca>(</span><span style=color:#d27e99>3</span><span style=color:#9cabca>,</span><span style=color:#d27e99> 5</span><span style=color:#9cabca>)</span><span style=color:#e6c384> *</span><span style=color:#d27e99> 1000</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>  const</span><span> promise</span><span style=color:#e6c384> = new</span><span style=color:#7aa89f> Promise</span><span style=color:#9cabca>(</span><span>res</span><span style=color:#957fb8> =></span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7e9cd8>    setTimeout</span><span style=color:#9cabca>(()</span><span style=color:#957fb8> =></span><span style=color:#7e9cd8> res</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'&lt;quote>'</span><span style=color:#9cabca>),</span><span> delay</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#9cabca>  });</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#727169>  // sanity check</span></span>
<span class=giallo-l><span>  promise</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>then</span><span style=color:#9cabca>(</span><span>res</span><span style=color:#957fb8> =></span><span style=color:#9cabca> (</span><span>console</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>log</span><span style=color:#9cabca>(</span><span>res</span><span style=color:#9cabca>),</span><span> res</span><span style=color:#9cabca>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8;font-weight:700>  return</span><span> promise</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span></code></pre><p>To make it work with our state machine we will use a function called <code>invoke</code>, this utility calls an "async function" (a function that returns a promise) when you enter a <code>state</code> then when the promise resolves it sends a <code>done</code> event (if it fails it sends a <code>error</code> event).<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span>  import {</span></span>
<span class=giallo-l><span>   createMachine,</span></span>
<span class=giallo-l><span>   state,</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  invoke,</span></span>
<span class=giallo-l><span>   transition,</span></span>
<span class=giallo-l><span>   interpret</span></span>
<span class=giallo-l><span> } from 'https://unpkg.com/robot3@0.2.9/machine.js';</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span> const mr_robot = createMachine({</span></span>
<span class=giallo-l><span>   idle: state(transition('fetch', 'loading')),</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  loading: state(transition('done', 'idle')),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  loading: invoke(get_quote, transition('done', 'idle')),</span></span>
<span class=giallo-l><span> });</span></span></code></pre><p>If you test <code>send('fetch')</code> you should see in the console.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=plain><span class=giallo-l><span>loading</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>// wait a few seconds...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>&lt;quote></span></span>
<span class=giallo-l><span>idle</span></span></code></pre><p>By now I hope you're all wondering where do we actually keep the data? There is a handy feature in <code>createMachine</code> that let us define a "context" object that will be available to us in the function that we attach to our <code>transitions</code>.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#957fb8>const</span><span style=color:#7e9cd8> context</span><span style=color:#e6c384> =</span><span> ev</span><span style=color:#957fb8> =></span><span style=color:#9cabca> ({</span></span>
<span class=giallo-l><span>  data</span><span style=color:#9cabca>: {},</span></span>
<span class=giallo-l><span style=color:#9cabca>});</span></span></code></pre><pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span>  const mr_robot = createMachine({</span></span>
<span class=giallo-l><span>    idle: state(transition('fetch', 'loading')),</span></span>
<span class=giallo-l><span>    loading: invoke(get_quote, transition('done', 'idle')),</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043> });</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a> }, context);</span></span></code></pre><p>Next we'll use another utility. We will pass a third parameter to <code>loading</code>'s transition, a hook of some sort that will modify the context object. This utility is called <code>reduce</code> and it looks like this.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#7e9cd8>reduce</span><span style=color:#9cabca>((</span><span>ctx</span><span style=color:#9cabca>,</span><span> ev</span><span style=color:#9cabca>)</span><span style=color:#957fb8> =></span><span style=color:#9cabca> ({</span><span style=color:#e6c384> ...</span><span>ctx</span><span style=color:#9cabca>,</span><span> data</span><span style=color:#9cabca>:</span><span> ev</span><span style=color:#9cabca>.</span><span style=color:#e6c384>data</span><span style=color:#9cabca> }))</span></span></code></pre><p>It takes the current context, a payload (here named <code>ev</code>) and whatever you return from it becomes your new context. We add that to the <code>loading</code> state.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span>  import {</span></span>
<span class=giallo-l><span>   createMachine,</span></span>
<span class=giallo-l><span>   state,</span></span>
<span class=giallo-l><span>   invoke,</span></span>
<span class=giallo-l><span>   transition,</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  reduce,</span></span>
<span class=giallo-l><span>   interpret</span></span>
<span class=giallo-l><span> } from 'https://unpkg.com/robot3@0.2.9/machine.js';</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span> const mr_robot = createMachine({</span></span>
<span class=giallo-l><span>   idle: state(transition('fetch', 'loading')),</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  loading: invoke(get_quote, transition('done', 'idle')), </span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  loading: invoke(</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    get_quote, </span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    transition(</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>      'done',</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>      'idle',</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>      reduce((ctx, ev) => ({ ...ctx, data: ev.data }))</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    )</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  ),</span></span>
<span class=giallo-l><span> }, context);</span></span></code></pre><p>Sanity check time. How do we know that works? We modify <code>interpret</code>'s handler.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#957fb8>const</span><span style=color:#7e9cd8> handler</span><span style=color:#e6c384> =</span><span style=color:#9cabca> ({</span><span> machine</span><span style=color:#9cabca>,</span><span> context</span><span style=color:#9cabca> })</span><span style=color:#957fb8> =></span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span>  console</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>log</span><span style=color:#9cabca>(</span><span>JSON</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>stringify</span><span style=color:#9cabca>({</span><span> </span></span>
<span class=giallo-l><span>    state</span><span style=color:#9cabca>:</span><span> machine</span><span style=color:#9cabca>.</span><span style=color:#e6c384>current</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span>    context</span></span>
<span class=giallo-l><span style=color:#9cabca>  }));</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span></code></pre><p>You should see this.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=plain><span class=giallo-l><span>{'state':'loading','context':{'data':{}}}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>// wait a few seconds...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>{'state':'idle','context':{'data':'&lt;quote>'}}</span></span></code></pre><p>We are ready. Let's show something in the browser.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=html><span class=giallo-l><span style=color:#9cabca>&lt;</span><span style=color:#e6c384>main</span><span style=color:#957fb8> id</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"app"</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"card"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>  &lt;</span><span style=color:#e6c384>section</span><span style=color:#957fb8> id</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"card"</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"card__content"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>     &lt;</span><span style=color:#e6c384>div</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"card__body"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;</span><span style=color:#e6c384>div</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"card__quote"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span>          quote</span></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;/</span><span style=color:#e6c384>div</span><span style=color:#9cabca>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;</span><span style=color:#e6c384>div</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"card__author"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span>          -- author</span></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;/</span><span style=color:#e6c384>div</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>      &lt;/</span><span style=color:#e6c384>div</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>      &lt;</span><span style=color:#e6c384>div</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"card__footer"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;</span><span style=color:#e6c384>button</span><span style=color:#957fb8> id</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"load_btn"</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"btn btn--new"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span>          More</span></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;/</span><span style=color:#e6c384>button</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;</span><span style=color:#e6c384>a</span><span style=color:#957fb8> href</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"#"</span><span style=color:#957fb8> target</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"_blank"</span><span style=color:#957fb8> class</span><span style=color:#9cabca>=</span><span style=color:#98bb6c>"btn btn--tweet"</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span>          Tweet</span></span>
<span class=giallo-l><span style=color:#9cabca>        &lt;/</span><span style=color:#e6c384>a</span><span style=color:#9cabca>></span></span>
<span class=giallo-l><span style=color:#9cabca>      &lt;/</span><span style=color:#e6c384>div</span><span style=color:#9cabca>></span><span> </span></span>
<span class=giallo-l><span style=color:#9cabca>  &lt;/</span><span style=color:#e6c384>section</span><span style=color:#9cabca>></span><span> </span></span>
<span class=giallo-l><span style=color:#9cabca>&lt;/</span><span style=color:#e6c384>main</span><span style=color:#9cabca>></span></span></code></pre><pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=css><span class=giallo-l><span style=color:#e6c384>body</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  display</span><span style=color:#9cabca>:</span><span style=color:#ffa066> flex</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  justify-content</span><span style=color:#9cabca>:</span><span style=color:#ffa066> center</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  align-items</span><span style=color:#9cabca>:</span><span style=color:#ffa066> center</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  min-height</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 95</span><span style=color:#e6c384>vh</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  background</span><span style=color:#9cabca>: #</span><span style=color:#957fb8>ddd</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  font-size</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 1</span><span style=color:#e6c384>em</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  color</span><span style=color:#9cabca>: #</span><span style=color:#957fb8>212121</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>card</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  width</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 600</span><span style=color:#e6c384>px</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  background</span><span style=color:#9cabca>:</span><span style=color:#ffa066> white</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  box-shadow</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 0 2</span><span style=color:#e6c384>px</span><span style=color:#d27e99> 5</span><span style=color:#e6c384>px</span><span style=color:#d27e99> 0</span><span style=color:#7e9cd8> rgba</span><span style=color:#9cabca>(</span><span style=color:#d27e99>0</span><span style=color:#9cabca>,</span><span style=color:#d27e99> 0</span><span style=color:#9cabca>,</span><span style=color:#d27e99> 0</span><span style=color:#9cabca>,</span><span style=color:#d27e99> 0.16</span><span style=color:#9cabca>),</span><span style=color:#d27e99> 0 2</span><span style=color:#e6c384>px</span><span style=color:#d27e99> 10</span><span style=color:#e6c384>px</span><span style=color:#d27e99> 0</span><span style=color:#7e9cd8> rgba</span><span style=color:#9cabca>(</span><span style=color:#d27e99>0</span><span style=color:#9cabca>,</span><span style=color:#d27e99> 0</span><span style=color:#9cabca>,</span><span style=color:#d27e99> 0</span><span style=color:#9cabca>,</span><span style=color:#d27e99> 0.12</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>card__content</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  color</span><span style=color:#9cabca>: #</span><span style=color:#957fb8>212121</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  padding</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 20</span><span style=color:#e6c384>px</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>card__content--loader</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  height</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 95</span><span style=color:#e6c384>px</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  display</span><span style=color:#9cabca>:</span><span style=color:#ffa066> flex</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  align-items</span><span style=color:#9cabca>:</span><span style=color:#ffa066> center</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  justify-content</span><span style=color:#9cabca>:</span><span style=color:#ffa066> center</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>card__body</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f> padding-bottom</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 15</span><span style=color:#e6c384>px</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>card__author</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  padding-top</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 10</span><span style=color:#e6c384>px</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  font-style</span><span style=color:#9cabca>:</span><span style=color:#ffa066> italic</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>card__footer</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  width</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 100</span><span style=color:#e6c384>%</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  display</span><span style=color:#9cabca>:</span><span style=color:#ffa066> flex</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  justify-content</span><span style=color:#9cabca>:</span><span style=color:#ffa066> space-between</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>btn</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  color</span><span style=color:#9cabca>: #</span><span style=color:#957fb8>fff</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  cursor</span><span style=color:#9cabca>:</span><span style=color:#ffa066> pointer</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  margin-top</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 10</span><span style=color:#e6c384>px</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  margin-left</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 10</span><span style=color:#e6c384>px</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  border-radius</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 0.4</span><span style=color:#e6c384>rem</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  text-decoration</span><span style=color:#9cabca>:</span><span style=color:#ffa066> none</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  display</span><span style=color:#9cabca>:</span><span style=color:#ffa066> inline-block</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  padding</span><span style=color:#9cabca>:</span><span style=color:#d27e99> .3</span><span style=color:#e6c384>rem</span><span style=color:#d27e99> .9</span><span style=color:#e6c384>rem</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>btn--new</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  background-color</span><span style=color:#9cabca>: #</span><span style=color:#957fb8>2093be</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  border</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 0.1</span><span style=color:#e6c384>rem</span><span style=color:#ffa066> solid</span><span style=color:#9cabca> #</span><span style=color:#957fb8>2093be</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>btn--tweet</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  background-color</span><span style=color:#9cabca>: #</span><span style=color:#957fb8>0074d9</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  border</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 0.1</span><span style=color:#e6c384>rem</span><span style=color:#ffa066> solid</span><span style=color:#9cabca> #</span><span style=color:#957fb8>0074d9</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>btn</span><span style=color:#9cabca>:</span><span style=color:#957fb8>hover</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  background</span><span style=color:#9cabca>: #</span><span style=color:#957fb8>3cb0fd</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  border</span><span style=color:#9cabca>:</span><span style=color:#d27e99> 0.1</span><span style=color:#e6c384>rem</span><span style=color:#ffa066> solid</span><span style=color:#9cabca> #</span><span style=color:#957fb8>3cb0fd</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#7aa89f>  text-decoration</span><span style=color:#9cabca>:</span><span style=color:#ffa066> none</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#9cabca>.</span><span style=color:#e6c384>hide</span><span style=color:#9cabca> {</span></span>
<span class=giallo-l><span style=color:#7aa89f>  display</span><span style=color:#9cabca>:</span><span style=color:#ffa066> none</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span></code></pre><p>Now the last piece of the puzzle, the side effects. We need to attach another function to our transitions so we can update the DOM. We could use <code>reduce</code> again but is just rude to have side effects on something called <code>reduce</code> (just don't) We will bring another utility made for that, <code>action</code>.<p>But first we must prepare. Update the context object with the necessary dependencies. (This step is not necessary, this is just me being allergic to global variables)<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span> const context = ev => ({</span></span>
<span class=giallo-l><span>   data: {},</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  dom: {</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    quote: document.querySelector('.card__quote'),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    author: document.querySelector('.card__author'),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    load_btn: window.load_btn,</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    tweet_btn: document.querySelector('.btn--tweet'),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    card: window.card</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  }</span></span>
<span class=giallo-l><span> });</span></span></code></pre><p>Create the side effects. At this point you should make sure that <code>get_quote</code> actually returns an object with a <code>quote</code> and <code>author</code> property.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#957fb8>function</span><span style=color:#7e9cd8> update_card</span><span style=color:#9cabca>({</span><span> dom</span><span style=color:#9cabca>,</span><span> data</span><span style=color:#9cabca> }) {</span></span>
<span class=giallo-l><span>  dom</span><span style=color:#9cabca>.</span><span>load_btn</span><span style=color:#9cabca>.</span><span style=color:#e6c384>textContent =</span><span style=color:#98bb6c> 'More'</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span>  dom</span><span style=color:#9cabca>.</span><span>quote</span><span style=color:#9cabca>.</span><span style=color:#e6c384>textContent =</span><span> data</span><span style=color:#9cabca>.</span><span style=color:#e6c384>quote</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span>  dom</span><span style=color:#9cabca>.</span><span>author</span><span style=color:#9cabca>.</span><span style=color:#e6c384>textContent =</span><span> data</span><span style=color:#9cabca>.</span><span style=color:#e6c384>author</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>  const</span><span> web_intent</span><span style=color:#e6c384> =</span><span style=color:#98bb6c> 'https://twitter.com/intent/tweet?text='</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#957fb8>  const</span><span> tweet</span><span style=color:#e6c384> =</span><span style=color:#98bb6c> `</span><span style=color:#9cabca>${</span><span>data</span><span style=color:#9cabca>.</span><span style=color:#e6c384>quote</span><span style=color:#9cabca>}</span><span style=color:#98bb6c> -- </span><span style=color:#9cabca>${</span><span>data</span><span style=color:#9cabca>.</span><span style=color:#e6c384>author</span><span style=color:#9cabca>}</span><span style=color:#98bb6c>`</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span>  dom</span><span style=color:#9cabca>.</span><span>tweet_btn</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>setAttribute</span><span style=color:#9cabca>(</span></span>
<span class=giallo-l><span style=color:#98bb6c>    'href'</span><span style=color:#9cabca>,</span><span> web_intent</span><span style=color:#e6c384> +</span><span style=color:#7e9cd8> encodeURIComponent</span><span style=color:#9cabca>(</span><span>tweet</span><span style=color:#9cabca>)</span></span>
<span class=giallo-l><span style=color:#9cabca>  );</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#957fb8>function</span><span style=color:#7e9cd8> show_loading</span><span style=color:#9cabca>({</span><span> dom</span><span style=color:#9cabca> }) {</span></span>
<span class=giallo-l><span>  dom</span><span style=color:#9cabca>.</span><span>load_btn</span><span style=color:#9cabca>.</span><span style=color:#e6c384>textContent =</span><span style=color:#98bb6c> 'Loading...'</span><span style=color:#9cabca>;</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span></code></pre><p>Put everything together.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span>  import {</span></span>
<span class=giallo-l><span>   createMachine,</span></span>
<span class=giallo-l><span>   state,</span></span>
<span class=giallo-l><span>   invoke,</span></span>
<span class=giallo-l><span>   transition,</span></span>
<span class=giallo-l><span>   reduce,</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  action,</span></span>
<span class=giallo-l><span>   interpret</span></span>
<span class=giallo-l><span> } from 'https://unpkg.com/robot3@0.2.9/machine.js';</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span> const mr_robot = createMachine({</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  idle: state(transition('fetch', 'loading')),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  idle: state(transition('fetch', 'loading', action(show_loading))),</span></span>
<span class=giallo-l><span>   loading: invoke(</span></span>
<span class=giallo-l><span>     get_quote, </span></span>
<span class=giallo-l><span>     transition(</span></span>
<span class=giallo-l><span>       'done',</span></span>
<span class=giallo-l><span>       'idle',</span></span>
<span class=giallo-l><span>       reduce((ctx, ev) => ({ ...ctx, data: ev.data })),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>      action(update_card)</span></span>
<span class=giallo-l><span>     )</span></span>
<span class=giallo-l><span>   ),</span></span>
<span class=giallo-l><span> }, context);</span></span></code></pre><p>By now everything kinda works but it looks bad when it loads for the first time. Let's make another loader, one that hides the card while we fetch the first quote.<p>Let's start with the HTML.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span> &lt;main id="app" class="card"></span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  &lt;section id="card" class="card__content"></span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  &lt;section class="card__content card__content--loader"> </span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    &lt;p>Loading&lt;/p> </span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  &lt;/section></span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  &lt;section id="card" class="hide card__content"></span></span>
<span class=giallo-l><span>     &lt;div class="card__body"></span></span>
<span class=giallo-l><span>       &lt;div class="card__quote"></span></span>
<span class=giallo-l><span>         quote</span></span>
<span class=giallo-l><span>       &lt;/div></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>       &lt;div class="card__author"></span></span>
<span class=giallo-l><span>          -- author</span></span>
<span class=giallo-l><span>       &lt;/div></span></span>
<span class=giallo-l><span>     &lt;/div></span></span>
<span class=giallo-l><span>     &lt;div class="card__footer"></span></span>
<span class=giallo-l><span>       &lt;button id="load_btn" class="btn btn--new"></span></span>
<span class=giallo-l><span>         More</span></span>
<span class=giallo-l><span>       &lt;/button></span></span>
<span class=giallo-l><span>       &lt;a href="#" target="_blank" class="btn btn--tweet"></span></span>
<span class=giallo-l><span>         Tweet</span></span>
<span class=giallo-l><span>       &lt;/a></span></span>
<span class=giallo-l><span>     &lt;/div> </span></span>
<span class=giallo-l><span>   &lt;/section> </span></span>
<span class=giallo-l><span> &lt;/main></span></span></code></pre><p>We'll make another state, <code>empty</code>. We can reuse our original <code>loading</code> state for this. Make a factory function that returns the loading transition.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#957fb8>const</span><span style=color:#7e9cd8> load_quote</span><span style=color:#e6c384> =</span><span style=color:#9cabca> (</span><span style=color:#e6c384>...</span><span>args</span><span style=color:#9cabca>)</span><span style=color:#957fb8> =></span></span>
<span class=giallo-l><span style=color:#7e9cd8>  invoke</span><span style=color:#9cabca>(</span></span>
<span class=giallo-l><span>    get_quote</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span style=color:#7e9cd8>    transition</span><span style=color:#9cabca>(</span></span>
<span class=giallo-l><span style=color:#98bb6c>      'done'</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span style=color:#98bb6c>      'idle'</span><span style=color:#9cabca>,</span></span>
<span class=giallo-l><span style=color:#7e9cd8>      reduce</span><span style=color:#9cabca>((</span><span>ctx</span><span style=color:#9cabca>,</span><span> ev</span><span style=color:#9cabca>)</span><span style=color:#957fb8> =></span><span style=color:#9cabca> ({</span><span style=color:#e6c384> ...</span><span>ctx</span><span style=color:#9cabca>,</span><span> data</span><span style=color:#9cabca>:</span><span> ev</span><span style=color:#9cabca>.</span><span style=color:#e6c384>data</span><span style=color:#9cabca> })),</span></span>
<span class=giallo-l><span style=color:#e6c384>      ...</span><span>args</span></span>
<span class=giallo-l><span style=color:#9cabca>    ),</span></span>
<span class=giallo-l><span style=color:#7e9cd8>    transition</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'error'</span><span style=color:#9cabca>,</span><span style=color:#98bb6c> 'idle'</span><span style=color:#9cabca>)</span></span>
<span class=giallo-l><span style=color:#9cabca>  );</span></span></code></pre><pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span> const mr_robot = createMachine({</span></span>
<span class=giallo-l><span>   idle: state(transition('fetch', 'loading', action(show_loading))),</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  loading: invoke(</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>    get_quote, </span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>    transition(</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>      'done',</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>      'idle',</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>      reduce((ctx, ev) => ({ ...ctx, data: ev.data })),</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>      action(update_card)</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>    )</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  ),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  loading: load_quote(action(update_card))</span></span>
<span class=giallo-l><span> }, context);</span></span></code></pre><p>Now we use this to hide the first loader and show the quote when it's ready.<pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span> const context = ev => ({</span></span>
<span class=giallo-l><span>   data: {},</span></span>
<span class=giallo-l><span>   dom: {</span></span>
<span class=giallo-l><span>     quote: document.querySelector('.card__quote'),</span></span>
<span class=giallo-l><span>     author: document.querySelector('.card__author'),</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>    loader: document.querySelector('.card__content--loader'),</span></span>
<span class=giallo-l><span>     load_btn: window.load_btn,</span></span>
<span class=giallo-l><span>     tweet_btn: document.querySelector('.btn--tweet'),</span></span>
<span class=giallo-l><span>     card: window.card</span></span>
<span class=giallo-l><span>   }</span></span>
<span class=giallo-l><span> });</span></span></code></pre><pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=javascript><span class=giallo-l><span style=color:#957fb8>function</span><span style=color:#7e9cd8> hide_loader</span><span style=color:#9cabca>({</span><span> dom</span><span style=color:#9cabca> }) {</span></span>
<span class=giallo-l><span>  dom</span><span style=color:#9cabca>.</span><span>loader</span><span style=color:#9cabca>.</span><span>classList</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>add</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'hide'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span>  dom</span><span style=color:#9cabca>.</span><span>card</span><span style=color:#9cabca>.</span><span>classList</span><span style=color:#9cabca>.</span><span style=color:#7e9cd8>remove</span><span style=color:#9cabca>(</span><span style=color:#98bb6c>'hide'</span><span style=color:#9cabca>);</span></span>
<span class=giallo-l><span style=color:#9cabca>}</span></span></code></pre><pre class=giallo style=color:#dcd7ba;background-color:#1f1f28><code data-lang=diff><span class=giallo-l><span> const mr_robot = createMachine({</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a>  empty: load_quote(action(update_card), action(hide_loader)),</span></span>
<span class=giallo-l><span>   idle: state(transition('fetch', 'loading', action(show_loading))),</span></span>
<span class=giallo-l><span>   loading: load_quote(action(update_card))</span></span>
<span class=giallo-l><span> }, context);</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043> const handler = ({ machine, context }) => {</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  console.log(JSON.stringify({ </span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>    state: machine.current,</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>    context</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043>  }));</span></span>
<span class=giallo-l><span style=color:#9cabca>-</span><span style=color:#c34043> }</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a> const handler = () => {};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span> const { send } = interpret(mr_robot, handler);</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a> const fetch_quote = () => send('fetch');</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span></span>
<span class=giallo-l><span style=color:#9cabca>+</span><span style=color:#76946a> window.load_btn.addEventListener('click', fetch_quote);</span></span></code></pre><p>Let's see it work.<p data-pen-title="Finite Random Quote Machine" style="box-sizing:border-box;border:2px solid;justify-content:center;align-items:center;height:600px;margin:1em 0;padding:1em;display:flex" class=codepen data-default-tab=js,result data-height=600 data-preview=true data-slug-hash=OJJvQzR data-theme-id=dark data-user=VonHeikemen><span> See the Pen <a href=https://codepen.io/VonHeikemen/pen/OJJvQzR>Finite Random Quote Machine</a> by Heiker (<a href=https://codepen.io/VonHeikemen>@VonHeikemen</a>) on <a href=https://codepen.io>CodePen</a>. </span></p><script async src=https://static.codepen.io/assets/embed/ei.js></script><h2 id=so-is-this-state-machine-thing-helpful>So is this state machine thing helpful?</h2><p>I hope so. Did you notice we made a bunch of test and created the blueprint of the quote machine even before writing any HTML? I think that's cool.<p>Did you try to click the 'loading' button while loading? Did it triggered a bunch of call to <code>get_quote</code>? That is because we made (sort of) impossible that a <code>fetch</code> event can happen during <code>loading</code>.<p>Not only that, the behavior of the machine and the effects on the outside world are separated. Depending on how you like to write code that may be a good or a bad thing.<h2 id=want-to-know-more>Want to know more?</h2><ul><li><a rel="noopener external" href=https://xstate.js.org/docs/about/concepts.html target=_blank>XState (concepts)</a><li><a rel="noopener external" href=https://thisrobot.life/ target=_blank>robot3 - docs</a><li><a rel="noopener external" href=https://www.freecodecamp.org/news/state-machines-basics-of-computer-science-d42855debc66/ target=_blank>Understanding State Machines</a></ul><hr><p>Have any question? Feel free to leave a comment in one of these platform where I have shared this:<ul><li><a href=https://dev.to/vonheikemen/taking-a-look-at-finite-state-machines-2g9i rel=noopener target=_blank>dev.to</a><li><a href=https://vonheikemen.hashnode.dev/taking-a-look-at-finite-state-machines rel=noopener target=_blank>Hashnode</a></ul><p>You can reach out to me on social media:<ul><li>Twitter <a rel="noopener me" href=https://twitter.com/VonHeikemen_ target=_blank> @VonHeikemen_ </a><li>Bluesky <a rel="noopener me" href=https://bsky.app/profile/vonheikemen.bsky.social target=_blank> @vonheikemen.bsky.social </a><li>Mastodon <a rel="noopener me" href=https://hachyderm.io/@vonheikemen target=_blank> @vonheikemen@hachyderm.io </a></ul><p>Thank you for reading. If you find this article useful and want to support my efforts, buy me a coffee ☕</p><a href=https://ko-fi.com/vonheikemen style=justify-content:center;display:flex target=_blank> <img alt="Buy Me A Coffee" src="https://storage.ko-fi.com/cdn/kofi2.png?v=3" style=width:217px!important;height:60px!important> </a></div></div>