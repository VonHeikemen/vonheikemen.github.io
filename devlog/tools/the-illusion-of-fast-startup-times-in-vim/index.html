<!doctype html><html lang=en><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1,viewport-fit=cover" name=viewport><meta content="interest-cohort=()" http-equiv=Permissions-Policy><title>
  The illusion of fast startup times in vim | Devlog
</title><link href=https://vonheikemen.github.io/devlog/print.css media=print rel=stylesheet><link href=https://vonheikemen.github.io/devlog/styles.css rel=stylesheet><link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" rel=stylesheet><link href=https://hachyderm.io/@vonheikemen rel=me><link href=https://twitter.com/VonHeikemen_ rel=me><meta content="vim, neovim, shell, software, coding, development" name=keywords><meta content="Speed up vim's startup times with this one weird 'trick'" name=description><body class=theme-base-custom><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vonheikemen.github.io/devlog/><h1>Devlog</h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>whoami</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/tags/>Explore tags</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/es/>Devlog en español</a></ul> © 2020-2023 Heiker Curiel</div></div><div class="content container"><div class=post><h1 class=post-title>The illusion of fast startup times in vim</h1><span class=post-date>2021-08-22 | 5 min read | <a href=https://vonheikemen.github.io/devlog/es/tools/the-illusion-of-fast-startup-times-in-vim/> Leer en español </a> </span><p>With an emphasis on the word "Illusion". What I'm going to show you is not a "magic trick" that will make vim go faster. Don't get your hopes up. The only thing we'll do here is delay the inevitable.<h2 id=what-do-we-want-to-achieve>What do we want to achieve?</h2><p>I want to load my optional plugins after vim interface is fully loaded and ready to go.<h2 id=why>Why?</h2><p>Because when I open vim there is a little timeframe of maybe 2 or 3 seconds where my mind goes from "what was I going to do?" to "Yeah, that thing". That's when I want to load the plugins. This way we only the deal with necessary stuff at startup, and then rest of the "nice to have" can happen in this timeframe where <strong>I</strong> am not doing anything in the editor.<h2 id=let-s-get-to-it>Let's get to it</h2><p>In vim we have an <a href=https://vimhelp.org/autocmd.txt.html#autocmd-events rel=noopener target=_blank>event</a> called <code>VimEnter</code>, it gets emitted when is done executing all the initial scripts and plugins. In theory this should be enough, but not for me, I really want to be sure. So what I'd like to do is wait 20 miliseconds after this event is dispatched, it should be enough time for vim to load the interface, and then load the plugins.<p>For this we will need an autocommand and the <code>timer_start</code> function. So let's make a test.We'll print a message 5 seconds after vim has started. We'll put this in our <code>.vimrc</code>.<pre class=language-vim data-lang=vim style=background:#2b2c2f;color:#cccece><code class=language-vim data-lang=vim><span>function! </span><span style=color:#6699cc>s:load_plugins</span><span style=color:#5fb3b3>(</span><span>t) abort
</span><span>  echom </span><span style=color:#99c794>"vim is ready"
</span><span>endfunction
</span><span>
</span><span style=color:#c594c5>augroup</span><span> user_cmds
</span><span>  </span><span style=color:#6699cc>autocmd</span><span>!
</span><span>  </span><span style=color:#6699cc>autocmd</span><span> VimEnter * call </span><span style=color:#6699cc>timer_start</span><span>(</span><span style=color:#f99157>5000</span><span>, </span><span style=color:#6699cc>function</span><span>(</span><span style=color:#99c794>'s:load_plugins'</span><span>))
</span><span style=color:#c594c5>augroup</span><span> END
</span></code></pre><p>Next time we open vim we should see the message <code>vim is ready</code>, after a few seconds. If you missed it you can check with command <code>:messages</code>.<p>Now we know it works. Change the delay time from <code>5000</code> to <code>20</code>. And in <code>s:load_plugins</code> put all the necessary commands to load your plugins.<p>This next part will depend a lot on how you manage your plugins. I'm going to use a built-in feature known as <a href=https://vimhelp.org/repeat.txt.html#packages rel=noopener target=_blank>packages</a>. Some plugins managers don't use it, so make sure it does by reading the docs.<p>The last piece of the puzzle is the <code>packadd</code> command, is what we'll use to load all our "optional plugins". So our function should be something like this.<pre class=language-vim data-lang=vim style=background:#2b2c2f;color:#cccece><code class=language-vim data-lang=vim><span>function! </span><span style=color:#6699cc>s:load_plugins</span><span style=color:#5fb3b3>(</span><span>t) abort
</span><span style=color:#5f6364>  " list of plugins
</span><span>  packadd vim-surround
</span><span>  packadd vim-obsession
</span><span>
</span><span style=color:#5f6364>  "(optional) run all the scripts in the `after` folder
</span><span>  runtime! OPT after</span><span style=color:#5fb3b3>/plugin/</span><span>*.vim
</span><span>
</span><span style=color:#5f6364>  "(optional) emit a user 'event'
</span><span style=color:#5f6364>  " so we can call other autocommands in this moment
</span><span>  doautocmd User PluginsLoaded
</span><span>endfunction
</span><span>
</span><span style=color:#c594c5>augroup</span><span> user_cmds
</span><span>  </span><span style=color:#6699cc>autocmd</span><span>!
</span><span>  </span><span style=color:#6699cc>autocmd</span><span> VimEnter * call </span><span style=color:#6699cc>timer_start</span><span>(</span><span style=color:#f99157>20</span><span>, </span><span style=color:#6699cc>function</span><span>(</span><span style=color:#99c794>'s:load_plugins'</span><span>))
</span><span style=color:#c594c5>augroup</span><span> END
</span></code></pre><p>That's it. But I'm not done.<h2 id=what-about-lua>What about lua?</h2><p>Neovim (version 0.5) makes it possible to write our config file entirely in lua, and a lot of people are doing just that. It's possible to write this in your lua config, but the current limitations of the API will force you to write a lot of vimscript.<p>Here is what you'll need to do in lua.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#c594c5>function </span><span style=color:#6699cc>load_plugins</span><span style=color:#5fb3b3>()
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>cmd </span><span style=color:#5fb3b3>[[
</span><span style=color:#99c794>    packadd vim-surround
</span><span style=color:#99c794>    packadd vim-obsession
</span><span style=color:#99c794>
</span><span style=color:#99c794>    runtime! OPT after/plugin/*.vim
</span><span style=color:#99c794>    doautocmd User PluginsLoaded
</span><span style=color:#99c794>  </span><span style=color:#5fb3b3>]]
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>cmd </span><span style=color:#5fb3b3>[[
</span><span style=color:#99c794>  augroup user_cmds
</span><span style=color:#99c794>    autocmd!
</span><span style=color:#99c794>    autocmd VimEnter * lua vim.defer_fn(load_plugins, 20)
</span><span style=color:#99c794>  augroup END
</span><span style=color:#5fb3b3>]]
</span></code></pre><p>I'm using a global function just because is the easiest way to write it. In general I advice against it. If you know how to create and use a lua module, use that instead.<h2 id=fair-warning>Fair warning</h2><p>You should consider what plugins you're going to load using this method.<p>Let's take <code>NERDTree</code> (a file manager) as an example. If you open up a folder in the terminal, something like <code>vim .</code>, <code>NERDTree</code> can show you the files in the folder automatically. But that specific feature will not work if you load it after <code>VimEnter</code>.<p>Syntax plugins can also be affected by this. If you load them late in the process you might actually see when the default colors change to the ones declared by the plugin. Is not a nice experience.<h2 id=conclusion>Conclusion</h2><p>We learned about <code>VimEnter</code>, an event that vim emits when the startup process is done. We learned about <code>timer_start</code> and <code>vim.defer_fn</code>, how we can use them to execute a function at a later time. Finally, we pieced together all of this to load all optional plugins in a specific moment when we as users are not interacting with the editor.<p>But we should also be careful with this. Loading a plugin outside the startup process can have unexpected side effects. So we should first decide what plugins can be optional.<h2 id=sources>Sources</h2><ul><li><a href=https://vimhelp.org/eval.txt.html#timers rel=noopener target=_blank>:help timers</a><li><a href=https://vimhelp.org/autocmd.txt.html#%3Adoautocmd rel=noopener target=_blank>:help :doautocmd</a><li><a href=https://vimhelp.org/autocmd.txt.html#User rel=noopener target=_blank>:help User</a><li><a href=https://vimhelp.org/repeat.txt.html#%3Apackadd rel=noopener target=_blank>:help :packadd</a><li><a href=https://vimhelp.org/repeat.txt.html#%3Aruntime rel=noopener target=_blank>:help :runtime</a><li><a href=https://neovim.io/doc/user/lua.html#vim.defer_fn() rel=noopener target=_blank>:help vim.defer_fn</a></ul><hr><p>Have any question? Feel free to leave a comment in one of these platform where I have shared this:<ul><li><a href=https://dev.to/vonheikemen/the-illusion-of-fast-startup-times-in-vim-bfo rel=noopener target=_blank>dev.to</a><li><a href=https://vonheikemen.hashnode.dev/the-illusion-of-fast-startup-times-in-vim rel=noopener target=_blank>Hashnode</a></ul><p>You can reach out to me on social media:<ul><li>Twitter <a rel="noopener me" href=https://twitter.com/VonHeikemen_ target=_blank> @VonHeikemen_ </a><li>Mastodon <a rel="noopener me" href=https://hachyderm.io/@vonheikemen target=_blank> @vonheikemen@hachyderm.io </a></ul><p>Thank you for reading. If you find this article useful and want to support my efforts, buy me a coffee ☕</p><a href=https://www.buymeacoffee.com/vonheikemen style=display:flex;justify-content:center target=_blank> <img alt="Buy Me A Coffee" src=https://cdn.buymeacoffee.com/buttons/v2/default-blue.png style=height:60px!important;width:217px!important> </a></div></div>