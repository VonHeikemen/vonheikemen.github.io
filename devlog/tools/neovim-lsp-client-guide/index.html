<!doctype html><html lang=en><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1,viewport-fit=cover" name=viewport><meta content="interest-cohort=()" http-equiv=Permissions-Policy><title>
  A guide on Neovim's LSP client | Devlog
</title><link href=https://vonheikemen.github.io/devlog/print.css media=print rel=stylesheet><link href=https://vonheikemen.github.io/devlog/styles.css rel=stylesheet><link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" rel=stylesheet><link href=https://vonheikemen.github.io/devlog/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://hachyderm.io/@vonheikemen rel=me><link href=https://twitter.com/VonHeikemen_ rel=me><meta content="neovim, shell, software, coding, development" name=keywords><meta content="Enable IDE-like features in Neovim without installing any additional plugins" name=description><body class=theme-base-custom><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vonheikemen.github.io/devlog/><h1>Devlog</h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>whoami</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/tags/>Explore tags</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/es/>Devlog en español</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/atom.xml>RSS</a></ul> © 2020-2025 Heiker Curiel</div></div><div class="content container"><div class=post><h1 class=post-title>A guide on Neovim's LSP client</h1><span class=post-date>2023-12-25 | 17 min read | <a href=https://vonheikemen.github.io/devlog/es/tools/neovim-lsp-client-guide/> Leer en español </a> </span><blockquote>Last updated: 2024-11-13</blockquote><p>Maybe I should have called this "How to enable IDE-like features without third party plugins." Sounds interesting, right? That's basically what I want to show you here.<p>I'm going to explain how to use the new configuration method that was introduced in Neovim v0.11. And I want to show it works because it's basically a layer on top of existing features. This way you can make your own setup even on older Neovim versions.<h2 id=requirements>Requirements</h2><ol><li>Neovim v0.8 or greater.<li>A language server.<li>Patience/Energy to write some lua code for each language server.</ol><p>If you don't know anything about lua here are a couple of links that can help you learn the basics:<ul><li><a href="https://www.youtube.com/watch?v=NneB6GX1Els" rel=noopener target=_blank>Lua crash course (11 min video)</a><li><a href=https://learnxinyminutes.com/docs/lua/ rel=noopener target=_blank>Learn X in Y minutes: Where X = lua</a><li><a href=https://neovim.io/doc/user/lua-guide.html rel=noopener target=_blank>Neovim's official lua guide</a></ul><h2 id=let-s-start-with-the-language-server>Let's start with the language server</h2><p>A language server is an external program that follows the <a href=https://microsoft.github.io/language-server-protocol/ rel=noopener target=_blank>Language Server Protocol</a>. The LSP specification defines what type of messages a language server can receive and also how it should respond. The idea here is that <a href=https://microsoft.github.io/language-server-protocol/implementors/tools/ rel=noopener target=_blank>any tool that follows the LSP specification</a> can communicate with a language server.<p>And so the language server is the thing that analyzes our source code and it can tell the editor what to do.<p><em>Where can we find these language servers?</em><p>The website for the LSP specification <a href=https://microsoft.github.io/language-server-protocol/implementors/servers/ rel=noopener target=_blank>has a list</a>.<h3 id=in-this-particular-case>In this particular case...</h3><p>I want to use <a href=https://gleam.run/ rel=noopener target=_blank>Gleam</a> and <a href=https://github.com/LuaLS/lua-language-server rel=noopener target=_blank>LuaLS</a> as examples.<p>Gleam is a toolchain. It has a compiler, a formatter and a language server. Install instructions are in the official documentation: <a href=https://gleam.run/getting-started/installing/ rel=noopener target=_blank>Getting started</a>.<p>LuaLS is a language server for lua. You can download it from <a href=https://github.com/LuaLS/lua-language-server/releases/latest rel=noopener target=_blank>github releases</a> or <a href=https://luals.github.io/wiki/build/ rel=noopener target=_blank>build it from source</a>.<p>Once you have a language server installed it's a good idea to check if Neovim "knows" where it is. You can check that using the function <a href=https://neovim.io/doc/user/builtin.html#exepath() rel=noopener target=_blank>exepath()</a>.<p>For Gleam you want to search for the <code>gleam</code> executable.<pre class=language-vim data-lang=vim style=color:#cccece;background-color:#2b2c2f><code class=language-vim data-lang=vim><span>:</span><span style=color:#69c>echo exepath</span><span>(</span><span style=color:#99c794>'gleam'</span><span>)
</span></code></pre><p>LuaLS' executable is called <code>lua-language-server</code>.<pre class=language-vim data-lang=vim style=color:#cccece;background-color:#2b2c2f><code class=language-vim data-lang=vim><span>:</span><span style=color:#69c>echo exepath</span><span>(</span><span style=color:#99c794>'lua-language-server'</span><span>)
</span></code></pre><p>This should show you the path to the executable. If it doesn't, it means something went wrong during the installation.<h2 id=basic-usage>Basic Usage</h2><p>Before we write any code we should learn how to use the language server. This should be in the official documentation of said server.<p>If we can't find the basic usage in the documentation we can go to <a href=https://github.com/neovim/nvim-lspconfig rel=noopener target=_blank>nvim-lspconfig</a>'s github repository. In there we look for a folder called <a href=https://github.com/neovim/nvim-lspconfig/tree/master/lsp rel=noopener target=_blank>lsp</a>, this contains configuration files for a bunch of language servers.<p>Say we are interested in Gleam, we should go and inspect the contents of <a href=https://github.com/neovim/nvim-lspconfig/blob/ac1dfbe3b60e5e23a2cff90e3bd6a3bc88031a57/lsp/gleam.lua#L8 rel=noopener target=_blank>gleam.lua</a>.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#c594c5>return </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= { '</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>lsp</span><span style=color:#5fb3b3>' },
</span><span>  </span><span style=color:#99c794>filetypes </span><span style=color:#5fb3b3>= { '</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>' },
</span><span>  </span><span style=color:#99c794>root_markers </span><span style=color:#5fb3b3>= { '</span><span style=color:#99c794>gleam.toml</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>.git</span><span style=color:#5fb3b3>' },
</span><span style=color:#5fb3b3>}
</span></code></pre><p>This shows the minimum amount of information we need to make a language server work.<p>The <code>cmd</code> property has the command we need to start the language server. Remember, language servers are external programs so <code>gleam lsp</code> is a valid command you can type on the terminal. And funny enough, if you do that it'll give you this message.<pre style=color:#cccece;background-color:#2b2c2f><code><span>This command is intended to be run by language server clients such
</span><span>as a text editor rather than being run directly in the console.
</span></code></pre><p><code>filetypes</code> is the list of languages the server can handle. These must be valid filetype names that Neovim supports.<p><code>root_markers</code> should be a list of files or folders. We will use this to determine the root of the project.<h2 id=the-lsp-folder>The lsp folder</h2><p>This <code>lsp</code> folder is not something unique only <code>nvim-lspconfig</code> can have. Since <strong>Neovim v0.11</strong> it is now part of the <code>runtimepath</code>. This means we can have an <code>lsp</code> folder inside our own personal configuration.<p>Imagine a Neovim config folder with this structure:<pre style=color:#cccece;background-color:#2b2c2f><code><span>nvim
</span><span>├── init.vim
</span><span>├── .nvim.lua
</span><span>└── lsp
</span><span>    ├── gleam.lua
</span><span>    └── luals-nvim.lua
</span></code></pre><p>The configuration inside <code>nvim/lsp/gleam.lua</code> can be the exact same thing <code>nvim-lspconfig</code> has.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- nvim/lsp/gleam.lua
</span><span>
</span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>lsp</span><span style=color:#5fb3b3>'},
</span><span>  </span><span style=color:#99c794>filetypes </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>'},
</span><span>  </span><span style=color:#99c794>root_markers </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam.toml</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>.git</span><span style=color:#5fb3b3>'},
</span><span style=color:#5fb3b3>}
</span></code></pre><p>We do have some amount of freedom here. So in <code>luals-nvim</code> I want to have a configuration made specifically for a Neovim config with an <code>.nvim.lua</code> script at the root.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- nvim/lsp/luals-nvim.lua
</span><span>
</span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>lua-language-server</span><span style=color:#5fb3b3>'},
</span><span>  </span><span style=color:#99c794>filetypes </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>lua</span><span style=color:#5fb3b3>'},
</span><span>  </span><span style=color:#99c794>root_markers </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>.nvim.lua</span><span style=color:#5fb3b3>'},
</span><span>  </span><span style=color:#99c794>settings </span><span style=color:#5fb3b3>= {
</span><span>    </span><span style=color:#99c794>Lua </span><span style=color:#5fb3b3>= {
</span><span>      </span><span style=color:#99c794>runtime </span><span style=color:#5fb3b3>= {
</span><span>        </span><span style=color:#99c794>version </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>LuaJIT</span><span style=color:#5fb3b3>',
</span><span>        </span><span style=color:#99c794>path </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>lua/?.lua</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>lua/?/init.lua</span><span style=color:#5fb3b3>'},
</span><span>      </span><span style=color:#5fb3b3>},
</span><span>      </span><span style=color:#99c794>diagnostics </span><span style=color:#5fb3b3>= {
</span><span>        </span><span style=color:#99c794>globals </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>vim</span><span style=color:#5fb3b3>'},
</span><span>      </span><span style=color:#5fb3b3>},
</span><span>      </span><span style=color:#99c794>telemetry </span><span style=color:#5fb3b3>= {
</span><span>        </span><span style=color:#99c794>enable </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span>      </span><span style=color:#5fb3b3>},
</span><span>      </span><span style=color:#99c794>workspace </span><span style=color:#5fb3b3>= {
</span><span>        </span><span style=color:#99c794>checkThirdParty </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span>        </span><span style=color:#99c794>library </span><span style=color:#5fb3b3>= {
</span><span>          vim</span><span style=color:#5fb3b3>.</span><span>env</span><span style=color:#5fb3b3>.</span><span>VIMRUNTIME</span><span style=color:#5fb3b3>,
</span><span>        </span><span style=color:#5fb3b3>},
</span><span>      </span><span style=color:#5fb3b3>},
</span><span>    </span><span style=color:#5fb3b3>},
</span><span>  </span><span style=color:#5fb3b3>},
</span><span style=color:#5fb3b3>}
</span></code></pre><p>Inside the <code>lsp</code> folder the files can have any name. So I made this <code>luals-nvim</code> instead of something generic like <code>lua</code> or <code>luals</code>. And the return value can be anything that the <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.config() rel=noopener target=_blank>vim.lsp.config()</a> function expects.<p>Notice in this one we have a <code>settings</code> property. That's reserved for server specific options. You'll have to search the documentation of the language server to know what options you can add there.<p>Now, having a configuration in the <code>lsp</code> folder doesn't mean Neovim will use it. We have to be explicit. To use a language server we must call the function <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.enable() rel=noopener target=_blank>vim.lsp.enable()</a>.<p>So in this example the <code>init.vim</code> looks like this.<pre class=language-vim data-lang=vim style=color:#cccece;background-color:#2b2c2f><code class=language-vim data-lang=vim><span style=color:#5f6364>" nvim/init.vim
</span><span>
</span><span style=color:#69c>set</span><span> exrc
</span><span>
</span><span style=color:#69c>lua</span><span> vim.lsp.</span><span style=color:#69c>enable</span><span>(</span><span style=color:#99c794>'gleam'</span><span>)
</span></code></pre><p><em>But why init.vim? What year is it, 2010?!</em><p>I just wanted an excuse to show is possible to execute lua code inside vimscript. Some Vim users think they have to delete their vimscript config to use lua. That's just not true.<p>Anyway, next time we open Neovim it will look for a file that matches the pattern <code>lsp/gleam.lua</code> inside the <code>runtimepath</code>. Then it will create an autocommand using the list we provided in the <code>filetypes</code> property. So whenever we open a file with the type <code>gleam</code> Neovim will try to enable the language server.<p><em>What about LuaLS?</em><p>The config we have for LuaLS only makes sense for Neovim. So I think this is a good oportunity to use an <a href="https://neovim.io/doc/user/options.html#'exrc'" rel=noopener target=_blank>exrc</a> file. Vim's version of a project local config. When the <code>exrc</code> option is enabled Vim/Neovim will execute a script located in the current working directory. This is both convenient and dangerous. So Neovim's <code>exrc</code> is slightly different from Vim. Neovim will ask you if you "trust" the file, and if you say yes it'll be executed. If the content of the file remains the same Neovim won't ask again, it'll just execute it automatically.<p>Personally, I would create an alias to enable <code>exrc</code> instead of having it in the <code>init</code> file. Something like this.<pre class=language-sh data-lang=sh style=color:#cccece;background-color:#2b2c2f><code class=language-sh data-lang=sh><span style=color:#69c>alias code</span><span style=color:#5fb3b3>='</span><span style=color:#99c794>nvim --cmd "set exrc"</span><span style=color:#5fb3b3>'
</span></code></pre><p>Let's go back to LuaLS. After Neovim is done executing the <code>init</code> file it will search for an <code>.nvim.lua</code> in the current working directory. The one in our Neovim folder will have this.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- nvim/.nvim.lua
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>enable</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>luals-nvim</span><span style=color:#5fb3b3>')
</span></code></pre><p>So Neovim will not even try to use <code>lsp/luals-nvim.lua</code> if we are not inside the config folder. The downside of this approach (right now) is that we have to open Neovim in the exact location where <code>.nvim.lua</code> is stored.<h2 id=single-file-setup>Single file setup?</h2><p>If you are the kind of person that has a very simple config that fits in one file, I have good news for you. You are not forced to use the <code>lsp</code> folder to configure a language server.<p>The configurations inside the <code>lsp</code> folder can be extended using the function <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.config() rel=noopener target=_blank>vim.lsp.config()</a>. But this can also be used to create an entire new config, without needing to create a new file.<p>Here's an example:<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- nvim/init.lua
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>config</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>lsp</span><span style=color:#5fb3b3>'},
</span><span style=color:#69c>  </span><span style=color:#99c794>filetypes </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>'},
</span><span style=color:#69c>  </span><span style=color:#99c794>root_markers </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam.toml</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>.git</span><span style=color:#5fb3b3>'},
</span><span style=color:#5fb3b3>})
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>enable</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>')
</span></code></pre><h2 id=where-to-look-if-something-goes-wrong>Where to look if something goes wrong?</h2><p>If Neovim wasn't able to start the language server, you can take a look at the log file, execute this command inside Neovim:<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5fb3b3>:</span><span>lua vim</span><span style=color:#5fb3b3>.</span><span>cmd</span><span style=color:#5fb3b3>.</span><span style=color:#69c>edit</span><span style=color:#5fb3b3>(</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>get_log_path</span><span style=color:#5fb3b3>())
</span></code></pre><p>Look for the lines that start with <code>[ERROR]</code>. Maybe there is an error message with some useful information.<p>If you want the logs to have more details, increase the log level using this function.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set_log_level</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>debug</span><span style=color:#5fb3b3>')
</span></code></pre><h2 id=execute-on-filetype>Execute on filetype</h2><p>Turns out <code>vim.lsp.enable()</code> is actually a layer on top of things we already had. We can still use a language server without plugins on older Neovim versions, we just need to know how to put the pieces together.<p>If the server we want to use only supports one language it makes sense to use a "filetype plugin."<p>We create a filetype plugin in our Neovim configuration simply by adding a script in the folder <code>ftplugin</code>. Note that the name of the script needs to be the same as a valid filetype.<p>We can navigate to Neovim's configuration folder, open Neovim and then create the <code>ftplugin</code> folder.<pre class=language-vim data-lang=vim style=color:#cccece;background-color:#2b2c2f><code class=language-vim data-lang=vim><span>:call </span><span style=color:#69c>mkdir</span><span>(</span><span style=color:#99c794>'./ftplugin'</span><span>, </span><span style=color:#99c794>'p'</span><span>)
</span></code></pre><p>If we want a filetype plugin for Gleam we create a new file called <code>gleam.lua</code>.<pre class=language-vim data-lang=vim style=color:#cccece;background-color:#2b2c2f><code class=language-vim data-lang=vim><span>:edit ftplugin/gleam.</span><span style=color:#69c>lua</span><span> | write
</span></code></pre><p>On the other hand, if we have a language server that can work on multiple filetypes we can use an autocommand on the event <code>FileType</code>.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>FileType</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  </span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>css</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>less</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>sass</span><span style=color:#5fb3b3>'},
</span><span style=color:#69c>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>    </span><span style=color:#5f6364>---
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- In here you can do whatever you want
</span><span style=color:#69c>    </span><span style=color:#5f6364>---
</span><span style=color:#69c>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><p>The <code>pattern</code> of the <code>FileType</code> event is a list of filetypes. The same thing you would provide in the <code>filetypes</code> property of an lsp config file.<p>Inside the filetype plugin or the autocommand we are going to execute the function that enables the language server. But first, we need to know how recreate the logic behind <code>root_markers</code>.<h2 id=root-directory>Root directory</h2><p>Language servers need to know what is the path of our project folder and this is a problem Neovim needs to solve.<p>On <strong>Neovim v0.10</strong> we can use a function called <a href=https://neovim.io/doc/user/lua.html#vim.fs.root() rel=noopener target=_blank>vim.fs.root()</a>. We will give it a list of files and it will return the parent directory of the first match.<p>What do we look for? We search for common configuration files that projects have in the root folder. So, in a Gleam project there is always a <code>gleam.toml</code> file. Javascript projects usually have a <code>package.json</code>. Rust projects have a <code>cargo.toml</code>. We feed this information to <code>vim.fs.root()</code> and it should give us a path we can use.<p>We can make a test already by adding this piece of code in a <code>gleam</code> filetype plugin.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- nvim/ftplugin/gleam.lua
</span><span style=color:#5f6364>-- NOTE: vim.fs.root() is only available on Neovim v0.10 or greater
</span><span>
</span><span style=color:#c594c5>local </span><span>root_markers </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam.toml</span><span style=color:#5fb3b3>'}
</span><span style=color:#c594c5>local </span><span>root_dir </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#69c>root</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span>root_markers</span><span style=color:#5fb3b3>)
</span><span>
</span><span style=color:#69c>print</span><span style=color:#5fb3b3>(</span><span>root_dir</span><span style=color:#5fb3b3>)
</span></code></pre><p>On <strong>Neovim v0.9</strong> or lower we would have to recreate the behavior of <code>vim.fs.root()</code>. For this we can use <a href=https://neovim.io/doc/user/lua.html#vim.fs.find() rel=noopener target=_blank>vim.fs.find()</a>.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- nvim/ftplugin/gleam.lua
</span><span style=color:#5f6364>-- NOTE: this code is for Neovim v0.9.5 or lower
</span><span>
</span><span style=color:#c594c5>local </span><span>root_markers </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam.toml</span><span style=color:#5fb3b3>'}
</span><span style=color:#c594c5>local </span><span>buffer </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_buf_get_name</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>)
</span><span style=color:#c594c5>local </span><span>paths </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#69c>find</span><span style=color:#5fb3b3>(</span><span>root_markers</span><span style=color:#5fb3b3>, {
</span><span style=color:#69c>  </span><span style=color:#99c794>upward </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#99c794>path </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>fnamemodify</span><span style=color:#5fb3b3>(</span><span>buffer</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>:p:h</span><span style=color:#5fb3b3>'),
</span><span style=color:#5fb3b3>})
</span><span>
</span><span style=color:#c594c5>local </span><span>root_dir </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#69c>dirname</span><span style=color:#5fb3b3>(</span><span>paths</span><span style=color:#5fb3b3>[</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>])
</span><span>
</span><span style=color:#69c>print</span><span style=color:#5fb3b3>(</span><span>root_dir</span><span style=color:#5fb3b3>)
</span></code></pre><h2 id=start-the-client>Start the client</h2><p>We are ready to enable the language server. Now we call the function <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.start() rel=noopener target=_blank>vim.lsp.start()</a>, which is the same thing <code>vim.lsp.enable()</code> uses under the hood.<p>The first time this is executed it will launch the language server as an external process. When called again with the same root directory it will only send information to the existing process.<p>Our gleam filetype plugin can look like this.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- nvim/ftplugin/gleam.lua
</span><span style=color:#5f6364>-- NOTE: vim.fs.root() is only available on Neovim v0.10 or greater
</span><span>
</span><span style=color:#c594c5>local </span><span>root_markers </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam.toml</span><span style=color:#5fb3b3>'}
</span><span style=color:#c594c5>local </span><span>root_dir </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#69c>root</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span>root_markers</span><span style=color:#5fb3b3>)
</span><span>
</span><span style=color:#c594c5>if </span><span>root_dir </span><span style=color:#c594c5>then
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>start</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>    </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>gleam</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>lsp</span><span style=color:#5fb3b3>'},
</span><span style=color:#69c>    </span><span style=color:#99c794>root_dir </span><span style=color:#5fb3b3>= </span><span>root_dir</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span></code></pre><p>With this setup we should get "diagnostics" out the box. If there is an error in a gleam file Neovim will show what line has the error.<h2 id=about-the-diagnostics>About the diagnostics</h2><p>So the diagnostics signs, the thing Neovim uses to tell us there is an error in our source code... by default the space needed to render that sign is hidden and when there is a sign the whole screen shifts to the right. That behavior can be configured.<p>If you set the option <code>signcolumn</code> to the string <code>yes</code> Neovim will reserve the space for the sign. You will have a whitespace reserved for any type of signs in the gutter.<p>In your <code>init.vim</code> you can have this.<pre class=language-vim data-lang=vim style=color:#cccece;background-color:#2b2c2f><code class=language-vim data-lang=vim><span style=color:#69c>set</span><span> signcolumn=yes
</span></code></pre><p>Or, if you have an <code>init.lua</code>.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>o</span><span style=color:#5fb3b3>.</span><span>signcolumn </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>yes</span><span style=color:#5fb3b3>'
</span></code></pre><p>If you set <code>signcolumn</code> to the string <code>no</code>, Neovim will hide the column altogether. Don't do that unless you are fully aware of the consequences. There is a better way to hide the diagnostic signs.<h3 id=vim-diagnostic>vim.diagnostic</h3><p>There is a lua module dedicated specifically to diagnostics: <a href=https://neovim.io/doc/user/diagnostic.html rel=noopener target=_blank>vim.diagnostic</a>. This has a <a href=https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.config() rel=noopener target=_blank>.config()</a> function we can use to configure the interface of the diagnostics.<ul><li>Hide diagnostic signs</ul><p>This is the safe way to disable the diagnostics sign.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>config</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>  </span><span style=color:#99c794>signs </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><ul><li>Virtual text</ul><p>There is an option to show the error message inline. This is called "virtual text." This used to be enabled by default, but now on <strong>Neovim v0.11</strong> is disabled.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>config</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>  </span><span style=color:#99c794>virtual_text </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><p>If you have <strong>Neovim v0.10 or greater</strong> you can read the diagnostic message under the cursor with the keybinding <code>&LTC-w>d</code> (control + w then d). This will trigger the function <a href=https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.open_float() rel=noopener target=_blank>vim.diagnostic.open_float()</a>.<p>When using <strong>Neovim v0.9.5 or lower</strong> you'll have to create that keybinding yourself.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTC-w>d</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.open_float()&LTcr></span><span style=color:#5fb3b3>')
</span></code></pre><p>Now, I would love to explain all the options <code>vim.diagnostic.config()</code> supports but we don't have time for that. If you want to know more you can <a href=https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.config() rel=noopener target=_blank>read the documentation</a>.<h2 id=what-else-do-we-get-for-free>What else do we get for free?</h2><p>These are things Neovim does when a language server active in the buffer.<p><strong>Since Neovim v0.8</strong><ul><li><p>There is an LSP powered <code>tagfunc</code>. That means we can jump to the definition of a function or class using the keybinding <code>&LTC-]></code> (control + ]). And can jump back to where we were using <code>&LTC-t></code>.</p><li><p>The <code>formatexpr</code> option is set to a function that uses the language server. This means the <code>gq</code> operator can format a piece of code. We can enter visual mode, select a piece of text, press <code>gq</code> and Neovim will request the language server to format the code.</p><li><p>The <code>omnifunc</code> option is also set. This one enables smart code completions. In insert mode the keybinding <code>&LTC-x>&LTC-o></code> (control + x then control + o) will trigger the completion menu with suggestions that the language server think are relevant.</p></ul><p><strong>Since Neovim v0.9</strong><ul><li>Semantic highlight is supported. Some language servers can provide information about the tokens in the source code, this allows for a more accurate syntax highlight.</ul><p><strong>Since Neovim v0.10</strong><ul><li><p>In normal mode, if we don't have a custom keybinding for <code>K</code> then it will display the available documentation for the symbol under the cursor.</p><li><p>In normal mode, <code>&LTC-w>d</code> opens a floating window showing the diagnostics in the line under the cursor.</p><li><p>In normal mode, <code>[d</code> and <code>]d</code> can be used to move the cursor to the previous and next diagnostic of the current file.</p></ul><p><strong>Since Neovim v0.11</strong><ul><li><p>In normal mode, <code>grn</code> renames all references of the symbol under the cursor.</p><li><p>In normal mode, <code>gra</code> shows a list of code actions available in the line under the cursor.</p><li><p>In normal mode, <code>grr</code> lists all the references of the symbol under the cursor.</p><li><p>In normal mode, <code>gri</code> lists all the implementations for the symbol under the cursor.</p><li><p>In normal mode, <code>gO</code> lists all symbols in the current buffer.</p><li><p>In insert mode, <code>&LTCtrl-s></code> displays the function signature of the symbol under the cursor.</p></ul><h2 id=lsp-keymaps>LSP keymaps</h2><p>Neovim v0.11 has defaults keymaps for almost everything now. The good news is that older versions of Neovim have the same features as v0.11, so the only thing we have to do is create keymaps for them.<p>So here's the code you can add in your personal configuration.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- you can add this in your init.lua
</span><span>
</span><span style=color:#5f6364>-- These keymaps are the defaults in Neovim v0.10
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>[d</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.goto_prev()&LTcr></span><span style=color:#5fb3b3>')
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>]d</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.goto_next()&LTcr></span><span style=color:#5fb3b3>')
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTC-w>d</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.open_float()&LTcr></span><span style=color:#5fb3b3>')
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTC-w>&LTC-d></span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.open_float()&LTcr></span><span style=color:#5fb3b3>')
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>local </span><span style=color:#69c>bufmap </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>mode</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>rhs</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>lhs</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>(</span><span>mode</span><span style=color:#5fb3b3>, </span><span>rhs</span><span style=color:#5fb3b3>, </span><span>lhs</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>})
</span><span style=color:#69c>    </span><span style=color:#c594c5>end
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- These keymaps are the defaults in Neovim v0.11
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>K</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.hover()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>grr</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.references()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gri</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.implementation()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>grn</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.rename()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gra</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.code_action()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gO</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.document_symbol()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>'}, '</span><span style=color:#99c794>&LTC-s></span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.signature_help()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- These are custom keymaps
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gd</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.definition()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>grt</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.type_definition()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>grd</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.declaration()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>x</span><span style=color:#5fb3b3>'}, '</span><span style=color:#99c794>gq</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.format({async = true})&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><p>And here is the vimscript equivalent:<pre class=language-vim data-lang=vim style=color:#cccece;background-color:#2b2c2f><code class=language-vim data-lang=vim><span style=color:#5f6364>" you can add this in your init.vim
</span><span>
</span><span style=color:#5f6364>" These keymaps are the defaults in Neovim v0.10
</span><span style=color:#69c>nnoremap</span><span> [d </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.diagnostic.</span><span style=color:#69c>goto_prev</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span style=color:#69c>nnoremap</span><span> ]d </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.diagnostic.</span><span style=color:#69c>goto_next</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTC-w></span><span>d </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.diagnostic.</span><span style=color:#69c>open_float</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTC-w>&LTC-d> &LTcmd></span><span style=color:#69c>lua</span><span> vim.diagnostic.</span><span style=color:#69c>open_float</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>
</span><span>function! </span><span style=color:#69c>LspAttached</span><span style=color:#5fb3b3>(</span><span>) abort
</span><span style=color:#5f6364>  " These keymaps are the defaults in Neovim v0.11
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> K </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>hover</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> grr </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>references</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> gri </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>implementation</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> grn </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>rename</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer> </span><span style=color:#69c>gra </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>code_action</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> gO </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>document_symbol</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>inoremap </span><span style=color:#fac863>&LTbuffer> &LTC-s> &LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>signature_help</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>snoremap </span><span style=color:#fac863>&LTbuffer> &LTC-s> &LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>signature_help</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>
</span><span style=color:#5f6364>  " These are custom keymaps
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> gd </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>definition</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> gq </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>format</span><span>({async = true})</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>xnoremap </span><span style=color:#fac863>&LTbuffer></span><span> gq </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>format</span><span>({async = true})</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> grd </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>declaration</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>  </span><span style=color:#69c>nnoremap </span><span style=color:#fac863>&LTbuffer></span><span> grt </span><span style=color:#fac863>&LTcmd></span><span style=color:#69c>lua</span><span> vim.lsp.buf.</span><span style=color:#69c>type_definition</span><span>()</span><span style=color:#fac863>&LTcr>
</span><span>endfunction
</span><span>
</span><span style=color:#69c>autocmd</span><span> LspAttach * call </span><span style=color:#69c>LspAttached</span><span>()
</span></code></pre><h2 id=fair-warning>Fair warning</h2><p>Not every language server implements the entire LSP specification. The features may not be consistent between servers.<p>For example, Gleam can show diagnostics in real time, there is no need to save the file to get new diagnostics. But <a href=https://github.com/rust-lang/rust-analyzer rel=noopener target=_blank>rust-analyzer</a>, the language server for rust, can only update diagnostics after saving the file.<p>Here's another example: <a href=https://github.com/astral-sh/ruff-lsp rel=noopener target=_blank>ruff-lsp</a>, a language server for python. It describes itself as a linter and code formatter. As far as I can tell <code>ruff-lsp</code> does not provide code completions or semantic highlights.<p>What I want say is this: read the documentation of the language server so you know what it can do.<h2 id=bonus-content>Bonus content</h2><p>At this point I'd say you have all the essential knowledge needed to be productive. What follows are tips, configurations, and features you can implement by adding some boilerplate code in your Neovim configuration.<h3 id=format-on-save>Format on save</h3><p>What we do here is trigger the function <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.buf.format() rel=noopener target=_blank>vim.lsp.buf.format()</a> before Neovim saves a file. And of course, we only do it when there is an active language server.<p>Important note: most language servers with formatting capabilities have their own style settings. For example, we can have 2 space indent in our Neovim config but maybe the language server formats the code with 4 space indent. So it's a good idea to check the documentation of the language server to see how to configure that.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>
</span><span style=color:#c594c5>local </span><span>fmt_group </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_augroup</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>autoformat_cmds</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>clear </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#69c>setup_autoformat</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>local </span><span>id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span>  </span><span style=color:#c594c5>local </span><span>client </span><span style=color:#5fb3b3>= </span><span>id </span><span style=color:#5fb3b3>and </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>get_client_by_id</span><span style=color:#5fb3b3>(</span><span>id</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>if </span><span>client </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_clear_autocmds</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>fmt_group</span><span style=color:#5fb3b3>, </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>})
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span style=color:#69c>buf_format </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>e</span><span style=color:#5fb3b3>)
</span><span>    vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span>buf</span><span style=color:#5fb3b3>.</span><span style=color:#69c>format</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>      </span><span style=color:#99c794>bufnr </span><span style=color:#5fb3b3>= </span><span>e</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>      </span><span style=color:#99c794>async </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>      </span><span style=color:#99c794>timeout_ms </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>10000</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>})
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>BufWritePre</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>    </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>fmt_group</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Format current buffer</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>    </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>buf_format</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Setup format on save</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>  </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>setup_autoformat</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=change-diagnostics-sign-text>Change diagnostics sign text</h3><p>When using <strong>Neovim v0.9.5 or lower</strong> we need to call the function <a href=https://neovim.io/doc/user/builtin.html#sign_define() rel=noopener target=_blank>vim.fn.sign_define()</a>.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#69c>sign_define</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>args</span><span style=color:#5fb3b3>)
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>sign_define</span><span style=color:#5fb3b3>(</span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#69c>name</span><span style=color:#5fb3b3>, {
</span><span style=color:#69c>    </span><span style=color:#99c794>texthl </span><span style=color:#5fb3b3>= </span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#69c>name</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= </span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#69c>text</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>numhl </span><span style=color:#5fb3b3>= ''
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span style=color:#69c>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignError</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>✘</span><span style=color:#5fb3b3>'})
</span><span style=color:#69c>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignWarn</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>▲</span><span style=color:#5fb3b3>'})
</span><span style=color:#69c>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignHint</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>⚑</span><span style=color:#5fb3b3>'})
</span><span style=color:#69c>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignInfo</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>»</span><span style=color:#5fb3b3>'})
</span></code></pre><p>When using <strong>Neovim v0.10 or greater</strong> we should do this with <code>vim.diagnostic.config()</code>.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>config</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>  </span><span style=color:#99c794>signs </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>    </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>severity</span><span style=color:#5fb3b3>.</span><span style=color:#69c>ERROR</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>✘</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>severity</span><span style=color:#5fb3b3>.</span><span style=color:#69c>WARN</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>▲</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>severity</span><span style=color:#5fb3b3>.</span><span style=color:#69c>HINT</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>⚑</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>severity</span><span style=color:#5fb3b3>.</span><span style=color:#69c>INFO</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>»</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>},
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>},
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=disable-semantic-highlights>Disable semantic highlights</h3><p>To opt-out of this feature Neovim's documentation suggest that we "delete" a property from the LSP client instance.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Disable LSP semantic highlights</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>local </span><span>id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    </span><span style=color:#c594c5>local </span><span>client </span><span style=color:#5fb3b3>= </span><span>id </span><span style=color:#5fb3b3>and </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>get_client_by_id</span><span style=color:#5fb3b3>(</span><span>id</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>if </span><span>client </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#c594c5>then
</span><span style=color:#69c>      </span><span style=color:#c594c5>return
</span><span style=color:#69c>    </span><span style=color:#c594c5>end
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span>client</span><span style=color:#5fb3b3>.</span><span style=color:#69c>server_capabilities</span><span style=color:#5fb3b3>.</span><span style=color:#69c>semanticTokensProvider </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>nil
</span><span style=color:#69c>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=highlight-symbol-under-cursor>Highlight symbol under cursor</h3><p>What we want to do here is call the function <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.buf.document_highlight() rel=noopener target=_blank>vim.lsp.buf.document_highlight()</a> when the cursor spends some amount of time on top of a symbol. And then clear the highlight when the cursor moves.<p>Note, for this to work properly the colorscheme needs to support the following highlight groups:<ul><li>LspReferenceRead<li>LspReferenceText<li>LspReferenceWrite</ul><p>If the colorscheme does not support these highlight groups, we can "link" them to an existing group. Here's an example using the <code>Search</code> highlight group.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_set_hl</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>LspReferenceRead</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>link </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Search</span><span style=color:#5fb3b3>'})
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_set_hl</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>LspReferenceText</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>link </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Search</span><span style=color:#5fb3b3>'})
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_set_hl</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>LspReferenceWrite</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>link </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Search</span><span style=color:#5fb3b3>'})
</span></code></pre><pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>
</span><span style=color:#5f6364>-- time it takes to trigger the `CursorHold` event
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>updatetime </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>400
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#69c>highlight_symbol</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>local </span><span>id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span>  </span><span style=color:#c594c5>local </span><span>client </span><span style=color:#5fb3b3>= </span><span>id </span><span style=color:#5fb3b3>and </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>get_client_by_id</span><span style=color:#5fb3b3>(</span><span>id</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>if </span><span>client </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#5fb3b3>or not </span><span>client</span><span style=color:#5fb3b3>.</span><span style=color:#69c>supports_method</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>textDocument/documentHighlight</span><span style=color:#5fb3b3>') </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span>group </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_augroup</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>highlight_symbol</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>clear </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>})
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_clear_autocmds</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>, </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>group</span><span style=color:#5fb3b3>})
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>CursorHold</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>CursorHoldI</span><span style=color:#5fb3b3>'}, {
</span><span style=color:#69c>    </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>group</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>.</span><span style=color:#69c>document_highlight</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>})
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>CursorMoved</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>CursorMovedI</span><span style=color:#5fb3b3>'}, {
</span><span style=color:#69c>    </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>group</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>.</span><span style=color:#69c>clear_references</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Setup highlight symbol</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>  </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>highlight_symbol</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=simple-tab-complete>Simple tab complete</h3><p>In this one we will use the <code>Tab</code> (and shift tab) key to navigate between the items in the completion menu. When the completion menu is not visible and the cursor is in a whitespace character, it will insert a tab character. Else, it will trigger the completion menu.<p>When the language server can provide code completion it'll use that. Otherwise, it will try to suggest words found in the current buffer.<p>Note that you can use the Enter key or <code>&LTC-y></code> to confirm the current item in the completion menu<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>completeopt </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>menuone</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noselect</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noinsert</span><span style=color:#5fb3b3>'}
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>shortmess</span><span style=color:#5fb3b3>:</span><span style=color:#69c>append</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>c</span><span style=color:#5fb3b3>')
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#69c>tab_complete</span><span style=color:#5fb3b3>()
</span><span>  </span><span style=color:#c594c5>if </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>pumvisible</span><span style=color:#5fb3b3>() == </span><span style=color:#f99157>1 </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- navigate to next item in completion menu
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTDown></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span>c </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>col</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>') - </span><span style=color:#f99157>1
</span><span>  </span><span style=color:#c594c5>local </span><span>is_whitespace </span><span style=color:#5fb3b3>= </span><span>c </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>0 </span><span style=color:#5fb3b3>or </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>getline</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>'):</span><span style=color:#69c>sub</span><span style=color:#5fb3b3>(</span><span>c</span><span style=color:#5fb3b3>, </span><span>c</span><span style=color:#5fb3b3>):</span><span style=color:#69c>match</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>%s</span><span style=color:#5fb3b3>')
</span><span>
</span><span>  </span><span style=color:#c594c5>if </span><span>is_whitespace </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- insert tab
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTTab></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span>lsp_completion </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>bo</span><span style=color:#5fb3b3>.</span><span>omnifunc </span><span style=color:#5fb3b3>== '</span><span style=color:#99c794>v:lua.vim.lsp.omnifunc</span><span style=color:#5fb3b3>'
</span><span>
</span><span>  </span><span style=color:#c594c5>if </span><span>lsp_completion </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- trigger lsp code completion
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTC-x>&LTC-o></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#5f6364>-- suggest words in current buffer
</span><span>  </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTC-x>&LTC-n></span><span style=color:#5fb3b3>'
</span><span style=color:#c594c5>end
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#69c>tab_prev</span><span style=color:#5fb3b3>()
</span><span>  </span><span style=color:#c594c5>if </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>pumvisible</span><span style=color:#5fb3b3>() == </span><span style=color:#f99157>1 </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- navigate to previous item in completion menu
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTUp></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#5f6364>-- insert tab
</span><span>  </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTTab></span><span style=color:#5fb3b3>'
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTTab></span><span style=color:#5fb3b3>', </span><span>tab_complete</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>expr </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTS-Tab></span><span style=color:#5fb3b3>', </span><span>tab_prev</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>expr </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=expand-snippets>Expand snippets</h3><blockquote><p>Neovim v0.11 or greater is required.</blockquote><p>For this we use a new module called <a href=https://neovim.io/doc/user/lsp.html#lsp-completion rel=noopener target=_blank>vim.lsp.completion</a>, this will extend the behavior of the builtin completion so it can support "additional text edits" a language server can provide. Additional edits can be things like adding missing import statements or expanding code snippets.<p>Right now you have to opt-in to the features <code>vim.lsp.completion</code> provides. So, when a language server is active you have to call the <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.completion.enable() rel=noopener target=_blank>vim.lsp.completion.enable()</a> function.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>completeopt </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>menuone</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noinsert</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noselect</span><span style=color:#5fb3b3>'}
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Enable vim.lsp.completion</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>local </span><span>client_id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    </span><span style=color:#c594c5>if </span><span>client_id </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#c594c5>then
</span><span style=color:#69c>      </span><span style=color:#c594c5>return
</span><span style=color:#69c>    </span><span style=color:#c594c5>end
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>completion</span><span style=color:#5fb3b3>.</span><span style=color:#69c>enable</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>true</span><span style=color:#5fb3b3>, </span><span>client_id</span><span style=color:#5fb3b3>, </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>autotrigger </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>})
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Trigger lsp completion manually using Ctrl + Space
</span><span style=color:#69c>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTC-Space></span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.completion.trigger()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#69c>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Notice in the last argument to <code>.enable()</code> there is a property called <code>autotrigger</code>. <code>false</code> is the default value so I just leave it like that. If you set it to <code>true</code> Neovim will trigger the completion menu when it finds a trigger character. Trigger characters change depending on the language server. In lua for example, the completion will be triggered automatically after a <code>.</code> or <code>:</code> character.<h3 id=enable-inlay-hints>Enable inlay hints</h3><blockquote><p>Neovim v0.10 or greater is required.</blockquote><p>For this we can use the function <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.inlay_hint.enable() rel=noopener target=_blank>vim.lsp.inlay_hint.enable()</a>.<p>Note that some language servers may have inlay hints disabled by default. The settings needed to enable hints should be in the documentation of the language server.<pre class=language-lua data-lang=lua style=color:#cccece;background-color:#2b2c2f><code class=language-lua data-lang=lua><span style=color:#5f6364>-- You can add this in your init.lua
</span><span style=color:#5f6364>-- or a global plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#69c>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Enable inlay hints</span><span style=color:#5fb3b3>',
</span><span style=color:#69c>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>local </span><span>id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span style=color:#69c>    </span><span style=color:#c594c5>local </span><span>client </span><span style=color:#5fb3b3>= </span><span>id </span><span style=color:#5fb3b3>and </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>get_client_by_id</span><span style=color:#5fb3b3>(</span><span>id</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>if </span><span>client </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#5fb3b3>or not </span><span>client</span><span style=color:#5fb3b3>.</span><span style=color:#69c>supports_method</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>textDocument/inlayHint</span><span style=color:#5fb3b3>') </span><span style=color:#c594c5>then
</span><span style=color:#69c>      </span><span style=color:#c594c5>return
</span><span style=color:#69c>    </span><span style=color:#c594c5>end
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>inlay_hint</span><span style=color:#5fb3b3>.</span><span style=color:#69c>enable</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>true</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>bufnr </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#69c>buf</span><span style=color:#5fb3b3>})
</span><span style=color:#69c>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><h2 id=conclusion>Conclusion</h2><p>Hopefully I showed is not difficult to "connect" a language server with Neovim. The hard part is gathering all the context inside your head. What does LSP even mean? What's a language server? Filetype plugin? I hardly know her. But once you know about the moving pieces and where to find the information you need, it gets easier.<p>One last thing, don't ignore the basics. Take your time and learn lua, read <a href=https://neovim.io/doc/user/lua-guide.html rel=noopener target=_blank>Neovim's lua guide</a> and learn how to navigate Neovim's documentation with the <code>:help</code> command.<hr><p>If you have a question you can reach out to me on social media:<ul><li>Twitter <a rel="noopener me" href=https://twitter.com/VonHeikemen_ target=_blank> @VonHeikemen_ </a><li>Bluesky <a rel="noopener me" href=https://bsky.app/profile/vonheikemen.bsky.social target=_blank> @vonheikemen.bsky.social </a><li>Mastodon <a rel="noopener me" href=https://hachyderm.io/@vonheikemen target=_blank> @vonheikemen@hachyderm.io </a></ul><p>Thank you for reading. If you find this article useful and want to support my efforts, buy me a coffee ☕</p><a href=https://ko-fi.com/vonheikemen style=justify-content:center;display:flex target=_blank> <img alt="Buy Me A Coffee" src="https://storage.ko-fi.com/cdn/kofi2.png?v=3" style=width:217px!important;height:60px!important> </a></div></div>