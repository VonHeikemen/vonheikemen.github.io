<!doctype html><html lang=en><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"><meta http-equiv=permissions-policy content="interest-cohort=()"><title>Setup nvim-lspconfig + nvim-cmp | Devlog</title><link rel=stylesheet href=https://vonheikemen.github.io/devlog/print.css media=print><link rel=stylesheet href=https://vonheikemen.github.io/devlog/styles.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><meta name=keywords content="vim,neovim,shell,software,coding,development"><meta name=monetization content="$ilp.uphold.com/dFQbFZ49nJdQ"><meta name=description content="Let's configure neovim's builtin LSP client with nvim-lspconfig and nvim-cmp"><body class=theme-base-custom><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vonheikemen.github.io/devlog/><h1>Devlog</h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>whoami</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/tags/>Explore tags</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/es/>Devlog en español</a></ul>© 2020-2022 Heiker Curiel</div></div><div class="content container"><div class=post><h1 class=post-title>Setup nvim-lspconfig + nvim-cmp</h1><span class=post-date>2022-05-23
| 14 min read
| <a href=https://vonheikemen.github.io/devlog/es/tools/setup-nvim-lspconfig-plus-nvim-cmp/>Leer en español</a></span><blockquote>Last updated: 2022-07-31</blockquote><p>Neovim includes a lua framework that allows the editor to communicate with a language server. What does that mean for us? Means we can have some IDE-like features such as rename variables, smart jump to definition, list references, etc. But of course we need to configure all of this first.<h2 id=wait-why-do-we-need-all-these-plugins>Wait, why do we need all these plugins?</h2><p>Out of the box neovim offers the tools to start and query a language server but it doesn't have any opinion on how we should use them. Enter <a rel=noopener target=_blank href=https://github.com/neovim/nvim-lspconfig>nvim-lspconfig</a>, with it neovim can scan the "root directory" of a project and choose which language server you configured should be initialiazed.<p>And then we have <a rel=noopener target=_blank href=https://github.com/hrsh7th/nvim-cmp>nvim-cmp</a>, the autocompletion plugin. I think the completions provided by neovim are good enough but the thing is it requires a fair amount of manual intervention. Modern code editors have all this automated in a way that feels more intuitive, this is what nvim-cmp offers. We can have that smart autocompletion in neovim.<p>Now you know the why, let's move on to the how.<h2 id=requirements>Requirements</h2><ul><li>Neovim v0.7 or greater.<li>An LSP server.<li>Install <a rel=noopener target=_blank href=https://github.com/neovim/nvim-lspconfig>nvim-lspconfig</a>.<li>Install plugins for autocompletion:<ul><li><a rel=noopener target=_blank href=https://github.com/hrsh7th/nvim-cmp>nvim-cmp</a><li><a rel=noopener target=_blank href=https://github.com/hrsh7th/cmp-buffer>cmp-buffer</a><li><a rel=noopener target=_blank href=https://github.com/hrsh7th/cmp-path>cmp-path</a><li><a rel=noopener target=_blank href=https://github.com/saadparwaiz1/cmp_luasnip>cmp_luasnip</a><li><a rel=noopener target=_blank href=https://github.com/hrsh7th/cmp-nvim-lsp>cmp-nvim-lsp</a><li><a rel=noopener target=_blank href=https://github.com/L3MON4D3/LuaSnip>LuaSnip</a><li><a rel=noopener target=_blank href=https://github.com/rafamadriz/friendly-snippets>friendly-snippets</a></ul></ul><p>In <code>nvim-lspconfig</code> documentation you'll find instructions to install the language servers it supports: <a rel=noopener target=_blank href=https://github.com/neovim/nvim-lspconfig/blob/master/doc/server_configurations.md>server_configurations.md</a><h2 id=lsp-config>LSP Config</h2><p>First thing you would want to do is declare a global configuration, options that you can share between all the servers.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#c594c5>local </span><span>lsp_defaults </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#99c794>flags </span><span style=color:#5fb3b3>= {
</span><span>    </span><span style=color:#99c794>debounce_text_changes </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>150</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#5fb3b3>},
</span><span>  </span><span style=color:#99c794>capabilities </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>cmp_nvim_lsp</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>update_capabilities</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>protocol</span><span style=color:#5fb3b3>.</span><span style=color:#69c>make_client_capabilities</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>),
</span><span>  </span><span style=color:#69c>on_attach </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>client</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>bufnr</span><span style=color:#5fb3b3>)
</span><span>    vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_exec_autocmds</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>User</span><span style=color:#5fb3b3>&#39;, {</span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>LspAttached</span><span style=color:#5fb3b3>&#39;})
</span><span>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>}
</span></code></pre><p>What do we have here?<ul><li><p><code>flags.debounce_text_changes</code>: Amount of miliseconds neovim will wait to send the next document update notification.<li><p><code>capabilities</code>: The data on this option is send to the server, to announce what features the editor can support. We use <code>vim.lsp.protocol.make_client_capabilities()</code> to build the default capabilities. Since <code>nvim-cmp</code> can add features to neovim we need to send an updated version of these capabilities.<li><p><code>on_attach</code>: Callback function that will be executed when a language server is attached to a buffer. It is recommended that we set our keybindings and commands in this function. Personally, I like to use <code>nvim_exec_autocmds</code> to trigger an "event", that way I can declare my keybindings anywhere I want.</ul><p>Now, <code>lsp_defaults</code> it's just a variable, there is nothing special about it. We need to merge this with <code>lspconfig</code>'s global config. We can find it in <code>util.default_config</code>. We will be using <code>vim.tbl_deep_extend</code> to merge those two variables in a safe way.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#c594c5>local </span><span>lspconfig </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>lspconfig</span><span style=color:#5fb3b3>&#39;)
</span><span>
</span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span>util</span><span style=color:#5fb3b3>.</span><span>default_config </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_deep_extend</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>force</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>  </span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span style=color:#69c>util</span><span style=color:#5fb3b3>.</span><span style=color:#69c>default_config</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span>lsp_defaults
</span><span style=color:#5fb3b3>)
</span></code></pre><p>Next step is to call the language servers we have installed. The way we do this with <code>lspconfig</code> is by calling the <code>.setup()</code> of the language server we want to configure.<p>How do we know which one we have available? Again, lspconfig's documentation has the answer. You can find the list of valid names using <code>:help lspconfig-server-configurations</code>.<p>For the language <code>lua</code> we can use a server called <code>sumneko_lua</code>. Install it and then call it in your config like this.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>lspconfig</span><span style=color:#5fb3b3>.</span><span>sumneko_lua</span><span style=color:#5fb3b3>.</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>({})
</span></code></pre><p>If you need to customize its behavior you need to add some keys to <code>.setup()</code>'s argument.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>lspconfig</span><span style=color:#5fb3b3>.</span><span>sumneko_lua</span><span style=color:#5fb3b3>.</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>  </span><span style=color:#99c794>single_file_support </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  on_attach </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>client</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>bufnr</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    print</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>hello</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>    </span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span style=color:#69c>util</span><span style=color:#5fb3b3>.</span><span style=color:#69c>default_config</span><span style=color:#5fb3b3>.</span><span style=color:#69c>on_attach</span><span style=color:#5fb3b3>(</span><span>client</span><span style=color:#5fb3b3>, </span><span>bufnr</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Notice here the new <code>on_attach</code> calls the <code>on_attach</code> on <code>default_config</code>. We must do this because the options we set on <code>.setup()</code> will override the ones on our global configuration. We could also use <code>lsp_defaults.on_attach</code> if its in the scope of the function.<p>At this point to take advantage of some "LSP features" we need to create some keybindings. This particular setup I'm showing allows us to do it with an autocommand. We can declare our keybindings anywhere in our config.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_create_autocmd</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>User</span><span style=color:#5fb3b3>&#39;, {
</span><span style=color:#69c>  </span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>LspAttached</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>LSP actions</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>    </span><span style=color:#c594c5>local </span><span style=color:#69c>bufmap </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>mode</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>lhs</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>rhs</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>local </span><span>opts </span><span style=color:#5fb3b3>= {</span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>}
</span><span style=color:#69c>      </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#69c>set</span><span style=color:#5fb3b3>(</span><span>mode</span><span style=color:#5fb3b3>, </span><span>lhs</span><span style=color:#5fb3b3>, </span><span>rhs</span><span style=color:#5fb3b3>, </span><span>opts</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>end
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Displays hover information about the symbol under the cursor
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>K</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.hover()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Jump to the definition
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>gd</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.definition()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Jump to declaration
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>gD</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.declaration()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Lists all the implementations for the symbol under the cursor
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>gi</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.implementation()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Jumps to the definition of the type symbol
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>go</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.type_definition()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Lists all the references 
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>gr</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.references()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Displays a function&#39;s signature information
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;C-k&gt;</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.signature_help()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Renames all references to the symbol under the cursor
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;F2&gt;</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.rename()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Selects a code action available at the current cursor position
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;F4&gt;</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.code_action()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>x</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;F4&gt;</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.lsp.buf.range_code_action()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Show diagnostics in a floating window
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>gl</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.diagnostic.open_float()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Move to the previous diagnostic
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>[d</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.diagnostic.goto_prev()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5f6364>-- Move to the next diagnostic
</span><span style=color:#69c>    bufmap</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>]d</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>&lt;cmd&gt;lua vim.diagnostic.goto_next()&lt;cr&gt;</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#69c>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Here is the complete code to configure <code>lspconfig</code>.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5f6364>---
</span><span style=color:#5f6364>-- Global Config
</span><span style=color:#5f6364>---
</span><span>
</span><span style=color:#c594c5>local </span><span>lsp_defaults </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#99c794>flags </span><span style=color:#5fb3b3>= {
</span><span>    </span><span style=color:#99c794>debounce_text_changes </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>150</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#5fb3b3>},
</span><span>  </span><span style=color:#99c794>capabilities </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>cmp_nvim_lsp</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>update_capabilities</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>protocol</span><span style=color:#5fb3b3>.</span><span style=color:#69c>make_client_capabilities</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>),
</span><span>  </span><span style=color:#69c>on_attach </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>client</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>bufnr</span><span style=color:#5fb3b3>)
</span><span>    vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_exec_autocmds</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>User</span><span style=color:#5fb3b3>&#39;, {</span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>LspAttached</span><span style=color:#5fb3b3>&#39;})
</span><span>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#c594c5>local </span><span>lspconfig </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>lspconfig</span><span style=color:#5fb3b3>&#39;)
</span><span>
</span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span>util</span><span style=color:#5fb3b3>.</span><span>default_config </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_deep_extend</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>force</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>  </span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span style=color:#69c>util</span><span style=color:#5fb3b3>.</span><span style=color:#69c>default_config</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span>lsp_defaults
</span><span style=color:#5fb3b3>)
</span><span>
</span><span style=color:#5f6364>---
</span><span style=color:#5f6364>-- LSP Servers
</span><span style=color:#5f6364>---
</span><span>
</span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span>sumneko_lua</span><span style=color:#5fb3b3>.</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>({})
</span></code></pre><h2 id=snippets>Snippets</h2><p>This is a good time to configure our snippet engine. The next bit is not related to language servers, LSP or whatever. We are just going to load the snippets we have installed.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>luasnip.loaders.from_vscode</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>lazy_load</span><span style=color:#5fb3b3>()
</span></code></pre><p>The <code>.lazy_load()</code> function will load any snippet we have in our <code>runtimepath</code>. And by that I mean the ones available in <code>friendly-snippets</code>.<h2 id=autocompletion>Autocompletion</h2><p>Before we start, <code>nvim-cmp</code>'s documentation says we should set <code>completeopt</code> with the following values:<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>completeopt </span><span style=color:#5fb3b3>= {&#39;</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>menuone</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>noselect</span><span style=color:#5fb3b3>&#39;}
</span></code></pre><p>To configure nvim-cmp we will use two modules <code>cmp</code> and <code>luasnip</code>.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#c594c5>local </span><span>cmp </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>cmp</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#c594c5>local </span><span>luasnip </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>luasnip</span><span style=color:#5fb3b3>&#39;)
</span></code></pre><p><code>cmp</code> is the one we will use to configure <code>nvim-cmp</code>. And this <code>luansnip</code>? Well, nvim-cmp doesn't "know" how to expand a snippet, that's why we need it.<p>We are going to spend some time exploring nvim-cmp's options. I want to explain all the things I do in my personal configuration. For now let's just add the setup function.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#c594c5>local </span><span>select_opts </span><span style=color:#5fb3b3>= {</span><span style=color:#99c794>behavior </span><span style=color:#5fb3b3>= </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>SelectBehavior</span><span style=color:#5fb3b3>.</span><span>Select</span><span style=color:#5fb3b3>}
</span><span>
</span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=snippet-expand>snippet.expand</h3><p>Callback function, it receives data from a snippet. This is where <code>nvim-cmp</code> expect us to provide a thing that can expand snippets, and we do that with <code>luasnip.lsp_expand</code>.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>snippet </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#69c>expand </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>args</span><span style=color:#5fb3b3>)
</span><span>    luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp_expand</span><span style=color:#5fb3b3>(</span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#69c>body</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>}</span><span>,
</span></code></pre><h3 id=sources>sources</h3><p>Here we can list all the data sources nvim-cmp will use to populate the completion list.<p>Each "source" is a lua table that must have a <code>name</code> property. That <code>name</code> is not the name of the plugin, it's the "id" the plugin used when creating the source. Each source should tell what name they have in their documentation.<p>Other properties you should be aware of are <code>priority</code> and <code>keyword_length</code>. <code>priority</code> allows nvim-cmp to sort the completion list. If you do not set a <code>priority</code> then the order of the sources will determine the priority. Now with <code>keyword_length</code> you can control how many characters are necesary to begin querying the source.<p>In my personal configuration I have the sources setup this way.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>sources </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>path</span><span style=color:#5fb3b3>&#39;},
</span><span>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>nvim_lsp</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>keyword_length </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>3</span><span style=color:#5fb3b3>},
</span><span>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>buffer</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>keyword_length </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>3</span><span style=color:#5fb3b3>},
</span><span>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>luasnip</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>keyword_length </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>2</span><span style=color:#5fb3b3>},
</span><span style=color:#5fb3b3>}</span><span>,
</span></code></pre><ul><li><code>path</code>: Autocomplete file paths.<li><code>nvim_lsp</code>: Shows suggestions based on the response of a language server.<li><code>buffer</code>: Suggests words found in the current buffer.<li><code>luasnip</code>: Shows available snippets and expands them if they are chosen.</ul><h3 id=window-documentation>window.documentation</h3><p>Controls the appearance and settings for the documentation window. To configure this quickly nvim-cmp offers a preset we can use to add some borders.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>window </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#99c794>documentation </span><span style=color:#5fb3b3>= </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>config</span><span style=color:#5fb3b3>.</span><span>window</span><span style=color:#5fb3b3>.</span><span style=color:#69c>bordered</span><span style=color:#5fb3b3>()
</span><span style=color:#5fb3b3>}</span><span>,
</span></code></pre><h3 id=formatting-fields>formatting.fields</h3><p>List of strings that determines the order of the elements in an item.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>formatting </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#99c794>fields </span><span style=color:#5fb3b3>= {&#39;</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>abbr</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>kind</span><span style=color:#5fb3b3>&#39;}
</span><span style=color:#5fb3b3>}</span><span>,
</span></code></pre><p><code>abbr</code> is the content of the suggestion. <code>kind</code> is the type of data, this can be text, class, function, etc. Finally, <code>menu</code> which apparently is empty by default.<h3 id=formatting-format>formatting.format</h3><p>Callback function that allows us to customize the appearance of the completion menu. A simple example I can show: assign an icon to a field based on the source name.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>formatting </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#99c794>fields </span><span style=color:#5fb3b3>= {&#39;</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>abbr</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>kind</span><span style=color:#5fb3b3>&#39;},
</span><span>  </span><span style=color:#69c>format </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>entry</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>item</span><span style=color:#5fb3b3>)
</span><span>    </span><span style=color:#c594c5>local </span><span>menu_icon </span><span style=color:#5fb3b3>= {
</span><span>      </span><span style=color:#99c794>nvim_lsp </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>λ</span><span style=color:#5fb3b3>&#39;,
</span><span>      </span><span style=color:#99c794>luasnip </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>⋗</span><span style=color:#5fb3b3>&#39;,
</span><span>      </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>Ω</span><span style=color:#5fb3b3>&#39;,
</span><span>      </span><span style=color:#99c794>path </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>🖫</span><span style=color:#5fb3b3>&#39;,
</span><span>    </span><span style=color:#5fb3b3>}
</span><span>
</span><span>    item</span><span style=color:#5fb3b3>.</span><span>menu </span><span style=color:#5fb3b3>= </span><span>menu_icon</span><span style=color:#5fb3b3>[</span><span>entry</span><span style=color:#5fb3b3>.</span><span>source</span><span style=color:#5fb3b3>.</span><span>name</span><span style=color:#5fb3b3>]
</span><span>    </span><span style=color:#c594c5>return </span><span>item
</span><span>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>}</span><span>,
</span></code></pre><h3 id=mapping>mapping</h3><p>List of keybindings. For this we need to declare a list of key/value pairs. Where the value is a function of the <code>cmp</code> module. Like this.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>mapping </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;CR&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>confirm</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>select </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>}),
</span><span style=color:#5fb3b3>}
</span></code></pre><p>In this example <code>['&lt;CR>']</code> is the key/shortcut we want to bind. The function on the other side of the assignment is the action we want to execute.<p>Here is a list of common keybindings:<ul><li>Move between completion items.</ul><pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;Up&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_prev_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)</span><span>,
</span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;Down&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_next_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)</span><span>,
</span><span>
</span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-p&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_prev_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)</span><span>,
</span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-n&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_next_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)</span><span>,
</span></code></pre><ul><li>Scroll text in the documentation window.</ul><pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-u&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>scroll_docs</span><span style=color:#5fb3b3>(-</span><span style=color:#f99157>4</span><span style=color:#5fb3b3>)</span><span>,
</span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-f&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>scroll_docs</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>4</span><span style=color:#5fb3b3>)</span><span>,
</span></code></pre><ul><li>Cancel completion.</ul><pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-e&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>abort</span><span style=color:#5fb3b3>()</span><span>,
</span></code></pre><ul><li>Confirm selection.</ul><pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;CR&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>confirm</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>select </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})</span><span>,
</span></code></pre><ul><li>Jump to the next placeholder in the snippet.</ul><pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-d&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>if </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jumpable</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>then
</span><span style=color:#69c>    </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jump</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>else
</span><span style=color:#69c>    fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#c594c5>end
</span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;})</span><span>,
</span></code></pre><ul><li>Jump to the previous placeholder in the snippet.</ul><pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-b&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>if </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jumpable</span><span style=color:#5fb3b3>(-</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>then
</span><span style=color:#69c>    </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jump</span><span style=color:#5fb3b3>(-</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>else
</span><span style=color:#69c>    fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#c594c5>end
</span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;})</span><span>,
</span></code></pre><ul><li>Autocomplete with tab.</ul><p>If the completion menu is visible, move to the next item. If the line is "empty", insert a <code>Tab</code> character. If the cursor is inside a word, trigger the completion menu.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;Tab&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>local </span><span>col </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>col</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>&#39;) - </span><span style=color:#f99157>1
</span><span style=color:#69c>
</span><span style=color:#69c>  </span><span style=color:#c594c5>if </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>visible</span><span style=color:#5fb3b3>() </span><span style=color:#c594c5>then
</span><span style=color:#69c>    </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_next_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>elseif </span><span>col </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>0 </span><span style=color:#5fb3b3>or </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>getline</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>&#39;):</span><span style=color:#69c>sub</span><span style=color:#5fb3b3>(</span><span>col</span><span style=color:#5fb3b3>, </span><span>col</span><span style=color:#5fb3b3>):</span><span style=color:#69c>match</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>%s</span><span style=color:#5fb3b3>&#39;) </span><span style=color:#c594c5>then
</span><span style=color:#69c>    fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#c594c5>else
</span><span style=color:#69c>    </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>complete</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#c594c5>end
</span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;})</span><span>,
</span></code></pre><ul><li>If the completion menu is visible, move to the previous item.</ul><pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;S-Tab&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>if </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>visible</span><span style=color:#5fb3b3>() </span><span style=color:#c594c5>then
</span><span style=color:#69c>    </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_prev_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>  </span><span style=color:#c594c5>else
</span><span style=color:#69c>    fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#c594c5>end
</span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;})</span><span>,
</span></code></pre><h3 id=complete-cmp-config>Complete cmp config</h3><p>Here is the entire configuration for <code>nvim-cmp</code> and <code>luansnip</code>.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>completeopt </span><span style=color:#5fb3b3>= {&#39;</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>menuone</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>noselect</span><span style=color:#5fb3b3>&#39;}
</span><span>
</span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>luasnip.loaders.from_vscode</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>lazy_load</span><span style=color:#5fb3b3>()
</span><span>
</span><span style=color:#c594c5>local </span><span>cmp </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>cmp</span><span style=color:#5fb3b3>&#39;)
</span><span style=color:#c594c5>local </span><span>luasnip </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>luasnip</span><span style=color:#5fb3b3>&#39;)
</span><span>
</span><span style=color:#c594c5>local </span><span>select_opts </span><span style=color:#5fb3b3>= {</span><span style=color:#99c794>behavior </span><span style=color:#5fb3b3>= </span><span>cmp</span><span style=color:#5fb3b3>.</span><span>SelectBehavior</span><span style=color:#5fb3b3>.</span><span>Select</span><span style=color:#5fb3b3>}
</span><span>
</span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>  </span><span style=color:#99c794>snippet </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>    expand </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>args</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp_expand</span><span style=color:#5fb3b3>(</span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#69c>body</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>    </span><span style=color:#c594c5>end
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>},
</span><span style=color:#69c>  </span><span style=color:#99c794>sources </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>path</span><span style=color:#5fb3b3>&#39;},
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>nvim_lsp</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>keyword_length </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>3</span><span style=color:#5fb3b3>},
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>buffer</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>keyword_length </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>3</span><span style=color:#5fb3b3>},
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>luasnip</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>keyword_length </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>2</span><span style=color:#5fb3b3>},
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>},
</span><span style=color:#69c>  </span><span style=color:#99c794>window </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>    </span><span style=color:#99c794>documentation </span><span style=color:#5fb3b3>= </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>config</span><span style=color:#5fb3b3>.</span><span style=color:#69c>window</span><span style=color:#5fb3b3>.</span><span style=color:#69c>bordered</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>},
</span><span style=color:#69c>  </span><span style=color:#99c794>formatting </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>    </span><span style=color:#99c794>fields </span><span style=color:#5fb3b3>= {&#39;</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>abbr</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>kind</span><span style=color:#5fb3b3>&#39;},
</span><span style=color:#69c>    format </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>entry</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>item</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>local </span><span>menu_icon </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>        </span><span style=color:#99c794>nvim_lsp </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>λ</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>        </span><span style=color:#99c794>luasnip </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>⋗</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>        </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>Ω</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>        </span><span style=color:#99c794>path </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>🖫</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>      </span><span style=color:#5fb3b3>}
</span><span style=color:#69c>
</span><span style=color:#69c>      </span><span>item</span><span style=color:#5fb3b3>.</span><span style=color:#69c>menu </span><span style=color:#5fb3b3>= </span><span>menu_icon</span><span style=color:#5fb3b3>[</span><span>entry</span><span style=color:#5fb3b3>.</span><span style=color:#69c>source</span><span style=color:#5fb3b3>.</span><span style=color:#69c>name</span><span style=color:#5fb3b3>]
</span><span style=color:#69c>      </span><span style=color:#c594c5>return </span><span>item
</span><span style=color:#69c>    </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>},
</span><span style=color:#69c>  </span><span style=color:#99c794>mapping </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;Up&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_prev_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>),
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;Down&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_next_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>),
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-p&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_prev_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>),
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-n&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_next_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>),
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-u&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>scroll_docs</span><span style=color:#5fb3b3>(-</span><span style=color:#f99157>4</span><span style=color:#5fb3b3>),
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-f&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>scroll_docs</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>4</span><span style=color:#5fb3b3>),
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-e&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>abort</span><span style=color:#5fb3b3>(),
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;CR&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>.</span><span style=color:#69c>confirm</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>select </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>}),
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-d&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>if </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jumpable</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>then
</span><span style=color:#69c>        </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jump</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>else
</span><span style=color:#69c>        fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>      </span><span style=color:#c594c5>end
</span><span style=color:#69c>    </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;}),
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;C-b&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>if </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jumpable</span><span style=color:#5fb3b3>(-</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>then
</span><span style=color:#69c>        </span><span>luasnip</span><span style=color:#5fb3b3>.</span><span style=color:#69c>jump</span><span style=color:#5fb3b3>(-</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>else
</span><span style=color:#69c>        fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>      </span><span style=color:#c594c5>end
</span><span style=color:#69c>    </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;}),
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;Tab&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>local </span><span>col </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>col</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>&#39;) - </span><span style=color:#f99157>1
</span><span style=color:#69c>
</span><span style=color:#69c>      </span><span style=color:#c594c5>if </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>visible</span><span style=color:#5fb3b3>() </span><span style=color:#c594c5>then
</span><span style=color:#69c>        </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_next_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>elseif </span><span>col </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>0 </span><span style=color:#5fb3b3>or </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>getline</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>&#39;):</span><span style=color:#69c>sub</span><span style=color:#5fb3b3>(</span><span>col</span><span style=color:#5fb3b3>, </span><span>col</span><span style=color:#5fb3b3>):</span><span style=color:#69c>match</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>%s</span><span style=color:#5fb3b3>&#39;) </span><span style=color:#c594c5>then
</span><span style=color:#69c>        fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>      </span><span style=color:#c594c5>else
</span><span style=color:#69c>        </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>complete</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>      </span><span style=color:#c594c5>end
</span><span style=color:#69c>    </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;}),
</span><span style=color:#69c>
</span><span style=color:#69c>    </span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>&lt;S-Tab&gt;</span><span style=color:#5fb3b3>&#39;] = </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>mapping</span><span style=color:#5fb3b3>(</span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>fallback</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>if </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>visible</span><span style=color:#5fb3b3>() </span><span style=color:#c594c5>then
</span><span style=color:#69c>        </span><span>cmp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>select_prev_item</span><span style=color:#5fb3b3>(</span><span>select_opts</span><span style=color:#5fb3b3>)
</span><span style=color:#69c>      </span><span style=color:#c594c5>else
</span><span style=color:#69c>        fallback</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>      </span><span style=color:#c594c5>end
</span><span style=color:#69c>    </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {&#39;</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>&#39;}),
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>},
</span><span style=color:#5fb3b3>})
</span></code></pre><h2 id=bonus-content>Bonus content</h2><p>Technically we are ready. All the code shown so far should get us a functional setup. We can now use our language servers and autocompletion. But there are still a couple of customizations we can make.<h3 id=change-diagnostic-icons>Change diagnostic icons</h3><p>We do this using a function called <code>sign_define</code>. Keep in mind this is not a lua function, it's vimscript. We access it using the prefix <code>vim.fn</code>. To know the details of this function check the documentation: <code>:help sign_define</code>.<p>Anyway, this is the code you'll need to change the sign icons.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#c594c5>local </span><span style=color:#69c>sign </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>opts</span><span style=color:#5fb3b3>)
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>sign_define</span><span style=color:#5fb3b3>(</span><span>opts</span><span style=color:#5fb3b3>.</span><span style=color:#69c>name</span><span style=color:#5fb3b3>, {
</span><span style=color:#69c>    </span><span style=color:#99c794>texthl </span><span style=color:#5fb3b3>= </span><span>opts</span><span style=color:#5fb3b3>.</span><span style=color:#69c>name</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= </span><span>opts</span><span style=color:#5fb3b3>.</span><span style=color:#69c>text</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>    </span><span style=color:#99c794>numhl </span><span style=color:#5fb3b3>= &#39;&#39;
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span style=color:#69c>sign</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>DiagnosticSignError</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>✘</span><span style=color:#5fb3b3>&#39;})
</span><span style=color:#69c>sign</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>DiagnosticSignWarn</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>▲</span><span style=color:#5fb3b3>&#39;})
</span><span style=color:#69c>sign</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>DiagnosticSignHint</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>⚑</span><span style=color:#5fb3b3>&#39;})
</span><span style=color:#69c>sign</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>DiagnosticSignInfo</span><span style=color:#5fb3b3>&#39;, </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794></span><span style=color:#5fb3b3>&#39;})
</span></code></pre><h3 id=diagnostics-config>Diagnostics config</h3><p>This time we must use the <code>vim.diagnostic</code> module, specifically the <code>.config()</code> function. It takes a lua table as an argument, and these are the defaults.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#99c794>virtual_text </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#99c794>signs </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#99c794>update_in_insert </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#99c794>underline </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#99c794>severity_sort </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#99c794>float </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>}
</span></code></pre><ul><li><p><code>virtual_text</code>: Show diagnostic message using virtual text.<li><p><code>signs</code>: Show a sign next to the line with a diagnostic.<li><p><code>update_in_insert</code>: Update diagnostics while editing in insert mode.<li><p><code>underline</code>: Use an underline to show a diagnostic location.<li><p><code>severity_sort</code>: Order diagnostics by severity.<li><p><code>float</code>: Show diagnostic messages in floating windows.</ul><p>Each one of these option can be either a boolean or a lua table. You can find more details about them in the documentation: <code>:help vim.diagnostic.config()</code>.<p>I prefer less distracting diagnostics. This is the setup I use.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#69c>config</span><span style=color:#5fb3b3>({
</span><span style=color:#69c>  </span><span style=color:#99c794>virtual_text </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#99c794>severity_sort </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#99c794>float </span><span style=color:#5fb3b3>= {
</span><span style=color:#69c>    </span><span style=color:#99c794>border </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>rounded</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>    </span><span style=color:#99c794>source </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>always</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>    </span><span style=color:#99c794>header </span><span style=color:#5fb3b3>= &#39;&#39;,
</span><span style=color:#69c>    </span><span style=color:#99c794>prefix </span><span style=color:#5fb3b3>= &#39;&#39;,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>},
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=help-windows-with-borders>Help windows with borders</h3><p>There are two lsp methods that use floating windows: <code>vim.lsp.buf.hover()</code> and <code>vim.lsp.buf.signature_help()</code>. By default these windows don't have any style, but we can change that by modifying the associated "handler" of each method. To achieve this we need to use <code>vim.lsp.with()</code>.<p>I don't want to bore you with the details so let me just show you the code.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span>handlers</span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>textDocument/hover</span><span style=color:#5fb3b3>&#39;] = </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>with</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>  </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>handlers</span><span style=color:#5fb3b3>.</span><span style=color:#69c>hover</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>border </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>rounded</span><span style=color:#5fb3b3>&#39;}
</span><span style=color:#5fb3b3>)
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span>handlers</span><span style=color:#5fb3b3>[&#39;</span><span style=color:#99c794>textDocument/signatureHelp</span><span style=color:#5fb3b3>&#39;] = </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>with</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>  </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>handlers</span><span style=color:#5fb3b3>.</span><span style=color:#69c>signature_help</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>border </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>rounded</span><span style=color:#5fb3b3>&#39;}
</span><span style=color:#5fb3b3>)
</span></code></pre><h3 id=install-language-servers-locally>Install language servers "locally"</h3><p>Sooner or later you are going to find out about this plugin: <a rel=noopener target=_blank href=https://github.com/williamboman/mason.nvim>mason.nvim</a>. With it you can manage your language servers using neovim. You'll be able to install, update and remove language server.<p>But the servers you install using this method will not be available globally. They are installed in the "data folder" of neovim. Now, some servers work fine in this setup others require extra configurations so it's recommended that you add <a rel=noopener target=_blank href=https://github.com/williamboman/mason-lspconfig.nvim>mason-lspconfig</a>.<p>Once you have both plugins you should setup mason.nvim using these functions.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>mason</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>mason-lspconfig</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>()
</span></code></pre><p>After doing that you should use <code>lspconfig</code> like you usually do. Pretend mason.nvim doesn't even exists.<p>Here is an example usage.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>mason</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>mason-lspconfig</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>()
</span><span>
</span><span style=color:#c594c5>local </span><span>lsp_defaults </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#99c794>flags </span><span style=color:#5fb3b3>= {
</span><span>    </span><span style=color:#99c794>debounce_text_changes </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>150</span><span style=color:#5fb3b3>,
</span><span>  </span><span style=color:#5fb3b3>},
</span><span>  </span><span style=color:#99c794>capabilities </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>cmp_nvim_lsp</span><span style=color:#5fb3b3>&#39;).</span><span style=color:#69c>update_capabilities</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#69c>protocol</span><span style=color:#5fb3b3>.</span><span style=color:#69c>make_client_capabilities</span><span style=color:#5fb3b3>()
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>),
</span><span>  </span><span style=color:#69c>on_attach </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>client</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>bufnr</span><span style=color:#5fb3b3>)
</span><span>    vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#69c>nvim_exec_autocmds</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>User</span><span style=color:#5fb3b3>&#39;, {</span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>LspAttached</span><span style=color:#5fb3b3>&#39;})
</span><span>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#c594c5>local </span><span>lspconfig </span><span style=color:#5fb3b3>= </span><span style=color:#69c>require</span><span style=color:#5fb3b3>(&#39;</span><span style=color:#99c794>lspconfig</span><span style=color:#5fb3b3>&#39;)
</span><span>
</span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span>util</span><span style=color:#5fb3b3>.</span><span>default_config </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>tbl_deep_extend</span><span style=color:#5fb3b3>(
</span><span style=color:#69c>  </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>force</span><span style=color:#5fb3b3>&#39;,
</span><span style=color:#69c>  </span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span style=color:#69c>util</span><span style=color:#5fb3b3>.</span><span style=color:#69c>default_config</span><span style=color:#5fb3b3>,
</span><span style=color:#69c>  </span><span>lsp_defaults
</span><span style=color:#5fb3b3>)
</span><span>
</span><span>lspconfig</span><span style=color:#5fb3b3>.</span><span>sumneko_lua</span><span style=color:#5fb3b3>.</span><span style=color:#69c>setup</span><span style=color:#5fb3b3>({})
</span></code></pre><p>Right now this is all I have to say about <code>mason.nvim</code>. If you want to know more about it you'll have read their documentation.<h2 id=conclusion>Conclusion</h2><p>We've learned the things <code>nvim-lspconfig</code> can do for us. We figure out how to make a global config for our servers. We setup a handful of lsp functions in our keybindings. Basically, we know everything we need to take advantage of the cool features a language server can provide.<p>We had the chance to assemble a configuration for <code>nvim-cmp</code> from scratch. We explored some common options step by step.<p>Finally, we made some additional customizations to diagnostics. Learned a little something about configuring lsp handlers, specifically the ones using floating windows. And we took a brief look at a method to install language servers locally.<p>You can find all the configuration code here: <a rel=noopener target=_blank href=https://github.com/VonHeikemen/nvim-starter/tree/03-lsp>nvim-starter - branch: 03-lsp</a><h2 id=sources-1>Sources</h2><ul><li><a rel=noopener target=_blank href=https://neovim.io/doc/user/lsp.html>:help lsp.txt</a><li><a rel=noopener target=_blank href=https://github.com/neovim/nvim-lspconfig/blob/9e6bcf5a8915e8423d5cc7f82c5069c11272184d/doc/lspconfig.txt#L240>:help lspconfig-global-defaults</a><li><a rel=noopener target=_blank href=https://github.com/neovim/nvim-lspconfig/blob/9e6bcf5a8915e8423d5cc7f82c5069c11272184d/doc/lspconfig.txt#L481>:help lspconfig-keybindings</a><li><a rel=noopener target=_blank href=https://github.com/hrsh7th/nvim-cmp/blob/6e1e3865158f340d6cd3936937eb56947b5a90f9/doc/cmp.txt#L360>:help cmp-config</a><li><a rel=noopener target=_blank href=https://github.com/hrsh7th/nvim-cmp/blob/6e1e3865158f340d6cd3936937eb56947b5a90f9/doc/cmp.txt#L227>:help cmp-mapping</a><li><a rel=noopener target=_blank href=https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.config()>:help vim.diagnostic.config()</a></ul><hr><p>Have any question? Feel free to leave a comment
in one of these platform where I have shared this:<ul><li><a rel=noopener target=_blank href=https://dev.to/vonheikemen/neovim-lsp-setup-nvim-lspconfig-nvim-cmp-4k8e>dev.to</a><li><a rel=noopener target=_blank href=https://vonheikemen.hashnode.dev/setup-nvim-lspconfig-nvim-cmp>Hashnode</a></ul><p>Or reach out to me on twitter
<a rel=noopener target=_blank href=https://twitter.com/VonHeikemen_>@VonHeikemen_</a><p>Thank you for reading. If you find this article useful and want to support my efforts, buy me a coffee ☕</p><a href=https://www.buymeacoffee.com/vonheikemen style=display:flex;justify-content:center target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-blue.png alt="Buy Me A Coffee" style=height:60px!important;width:217px!important></a></div></div>