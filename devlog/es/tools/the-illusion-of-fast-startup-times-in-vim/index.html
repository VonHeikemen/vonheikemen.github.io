<!doctype html><html lang=es><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"><meta http-equiv=permissions-policy content="interest-cohort=()"><title>La ilusión de un inicio rápido en vim | Devlog</title><link rel=stylesheet href=https://vonheikemen.github.io/devlog/print.css media=print><link rel=stylesheet href=https://vonheikemen.github.io/devlog/styles.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><meta name=keywords content="vim,neovim,shell,software,coding,development"><meta name=description content="Mejorando el tiempo de inicio de vim con un pequeño 'truco'"><body class=theme-base-custom><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vonheikemen.github.io/devlog/es/><h1>Devlog</h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>whoami</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/es/tags/>Explorar tags</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/>Devlog in english</a></ul>© 2020-2022 Heiker Curiel</div></div><div class="content container"><div class=post><h1 class=post-title>La ilusión de un inicio rápido en vim</h1><span class=post-date>2021-08-22
| 5 minutos
| <a href=https://vonheikemen.github.io/devlog/tools/the-illusion-of-fast-startup-times-in-vim/>Read in english</a></span><p>"Ilusión" es la palabra clave. Lo que voy a enseñarles no es ningún "truco mágico" que hará vim más rápido. Alejen ese pensamiento de sus mentes. Lo único que haremos hoy será retrasar lo inevitable.<h2 id=que-queremos-lograr>¿Qué queremos lograr?</h2><p>Quiero todos los plugins opcionales se inicialicen luego de que la interfaz esté totalmente cargada.<h2 id=por-que>¿Por qué?</h2><p>En mi caso, cuando veo que el editor ya está listo hay una pequeña ventana de tiempo de 2 o 3 segundos donde mi mente pasa de "¿Qué es lo que voy a hacer?" a "Ah, sí, esa cosa". Durante ese tiempo no estoy haciendo nada y es exactamente ahí donde quiero carguen todos los plugins. De esta manera ejecutamos sólo necesario para que vim pueda funcionar al inicio, y dejamos todo lo demás que es "opcional" en esa ventana de tiempo donde <strong>yo</strong> no estoy haciendo nada con el editor.<h2 id=manos-a-la-obra>Manos a la obra</h2><p>En vim tenemos un <a rel=noopener target=_blank href=https://vimhelp.org/autocmd.txt.html#autocmd-events>evento</a> que se llama <code>VimEnter</code>, este nos indica el momento cuando vim termina todo su ritual de inicialización. Pero no es suficiente para mí, yo quiero estar seguro de que todo está listo. Entonces lo que quiero hacer es esperar unos 20 milisegundos después de este evento, el cual debería ser tiempo suficiente para que vim presente la interfaz, y luego cargar los plugins.<p>Necesitamos un "autocomando" y la función <code>timer_start</code>. Hagamos una pequeña prueba. Vamos a imprimir un mensaje 5 segundos luego de que vim inicie. Colocaremos esto en nuestro <code>.vimrc</code>.<pre data-lang=vim style=background-color:#2b2c2f;color:#cccece class=language-vim><code class=language-vim data-lang=vim><span>function! </span><span style=color:#69c>s:load_plugins</span><span style=color:#5fb3b3>(</span><span>t) abort
</span><span>  echom </span><span style=color:#99c794>&quot;vim está listo&quot;
</span><span>endfunction
</span><span>
</span><span style=color:#c594c5>augroup</span><span> user_cmds
</span><span>  </span><span style=color:#69c>autocmd</span><span>!
</span><span>  </span><span style=color:#69c>autocmd</span><span> VimEnter * call </span><span style=color:#69c>timer_start</span><span>(</span><span style=color:#f99157>5000</span><span>, </span><span style=color:#69c>function</span><span>(</span><span style=color:#99c794>&#39;s:load_plugins&#39;</span><span>))
</span><span style=color:#c594c5>augroup</span><span> END
</span></code></pre><p>La próxima vez que inicien vim, deberían ver el mensaje <code>vim está listo</code> después de unos segundos. Si no vieron el mensaje o desapareció rápidamente, pueden revisar con el commando <code>:messages</code>.<p>Una vez que estamos seguros que nuestra función es ejecutada cambiamos el tiempo de <code>5000</code> a <code>20</code>. Y en <code>s:load_plugins</code> ya podemos colocar los comandos necesarios para cargar los plugins.<p>Esta siguiente parte va a depender de su manejador de plugins. Vamos a usar la funcionalidad nativa conocida como <a rel=noopener target=_blank href=https://vimhelp.org/repeat.txt.html#packages>packages</a>. Si no están seguros si la usan o no, revisen la documentación de su manejador plugins.<p>La última pieza del rompecabezas es el comando <code>packadd</code>, es el mecanismo que utiliza vim para cargar un plugin "opcional". Entonces nuestro código debería quedar así.<pre data-lang=vim style=background-color:#2b2c2f;color:#cccece class=language-vim><code class=language-vim data-lang=vim><span>function! </span><span style=color:#69c>s:load_plugins</span><span style=color:#5fb3b3>(</span><span>t) abort
</span><span style=color:#5f6364>  &quot; lista de plugins
</span><span>  packadd vim-surround
</span><span>  packadd vim-obsession
</span><span>
</span><span style=color:#5f6364>  &quot;(opcional) ejecutar scripts en el directorio `after`
</span><span>  runtime! OPT after</span><span style=color:#5fb3b3>/plugin/</span><span>*.vim
</span><span>
</span><span style=color:#5f6364>  &quot;(opcional) emitimos un &#39;evento&#39; propio
</span><span style=color:#5f6364>  &quot; para indicar que ya todo está listo
</span><span>  doautocmd User PluginsLoaded
</span><span>endfunction
</span><span>
</span><span style=color:#c594c5>augroup</span><span> user_cmds
</span><span>  </span><span style=color:#69c>autocmd</span><span>!
</span><span>  </span><span style=color:#69c>autocmd</span><span> VimEnter * call </span><span style=color:#69c>timer_start</span><span>(</span><span style=color:#f99157>20</span><span>, </span><span style=color:#69c>function</span><span>(</span><span style=color:#99c794>&#39;s:load_plugins&#39;</span><span>))
</span><span style=color:#c594c5>augroup</span><span> END
</span></code></pre><p>Eso es todo. Pero aún no termino.<h2 id=que-hay-de-lua>¿Qué hay de lua?</h2><p>En <code>neovim</code> (a partir de la versión 0.5) se ha incluido soporte para crear la configuración enteramente en lua, y mucha gente ha migrado su configuración a este lenguaje. En efecto también podemos hacer lo mismo en lua, pero las limitaciones actuales los obligará a escribir mucho vimscript.<p>He aquí lo que necesitan.<pre data-lang=lua style=background-color:#2b2c2f;color:#cccece class=language-lua><code class=language-lua data-lang=lua><span style=color:#c594c5>function </span><span style=color:#69c>load_plugins</span><span style=color:#5fb3b3>()
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>cmd </span><span style=color:#5fb3b3>[[
</span><span style=color:#99c794>    packadd vim-surround
</span><span style=color:#99c794>    packadd vim-obsession
</span><span style=color:#99c794>
</span><span style=color:#99c794>    runtime! OPT after/plugin/*.vim
</span><span style=color:#99c794>    doautocmd User PluginsLoaded
</span><span style=color:#99c794>  </span><span style=color:#5fb3b3>]]
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#69c>cmd </span><span style=color:#5fb3b3>[[
</span><span style=color:#99c794>  augroup user_cmds
</span><span style=color:#99c794>    autocmd!
</span><span style=color:#99c794>    autocmd VimEnter * lua vim.defer_fn(load_plugins, 20)
</span><span style=color:#99c794>  augroup END
</span><span style=color:#5fb3b3>]]
</span></code></pre><p>Aquí estoy creando una función global porque es lo más fácil. Por lo general deberían evitar ese tipo de funciones. Si saben cómo crear y usar un módulo en lua, les sugiero que hagan eso.<h2 id=advertencia>Advertencia</h2><p>Consideren qué plugins van a cargar de esta manera.<p>Vamos a tomar <code>NERDTree</code>(un gestor de archivos) como ejemplo. Si abren un directorio desde la terminal, algo como <code>vim .</code>, <code>NERDTree</code> puede activarse automáticamente para enseñarles los archivos del directorio. Pero si retrasan la carga inicial de <code>NERDTree</code> este no podrá cumplir su función en este caso específico.<p>Ocurre algo similar con los plugins de sintaxis, si los cargan tarde puede que noten cuando vim cambia los colores por defecto a los colores que declara el plugin. No es una experiencia agradable.<h2 id=conclusion>Conclusión</h2><p>Aprendimos sobre el evento <code>VimEnter</code>, que es emitido por vim al finalizar su proceso inicial. Llegamos a conocer las funciones <code>timer_start</code> y <code>vim.defer_fn</code>, que podemos usarlas para ejecutar una función en un momento que nos parezca más conveniente. Finalmente, unimos todas estas piezas para cargar nuestros plugins opcionales en un momento específico donde nosotros como usuarios no estamos interactuando con el editor.<p>Pero también deberíamos tener cuidado porque cargar un plugin fuera del proceso inicial de vim puede tener efectos no deseados. Entonces deberíamos evaluar la situación por plugin, decidir qué debería ser un plugin opcional y qué no.<h2 id=fuentes>Fuentes</h2><ul><li><a rel=noopener target=_blank href=https://vimhelp.org/eval.txt.html#timers>:help timers</a><li><a rel=noopener target=_blank href=https://vimhelp.org/autocmd.txt.html#%3Adoautocmd>:help :doautocmd</a><li><a rel=noopener target=_blank href=https://vimhelp.org/autocmd.txt.html#User>:help User</a><li><a rel=noopener target=_blank href=https://vimhelp.org/repeat.txt.html#%3Apackadd>:help :packadd</a><li><a rel=noopener target=_blank href=https://vimhelp.org/repeat.txt.html#%3Aruntime>:help :runtime</a><li><a rel=noopener target=_blank href=https://neovim.io/doc/user/lua.html#vim.defer_fn()>:help vim.defer_fn</a></ul><hr><p>¿Tienen alguna pregunta? Pueden dejar un comentario
en cualquiera de estas plataformas:<ul><li><a rel=noopener target=_blank href=https://dev.to/vonheikemen/la-ilusion-de-un-inicio-rapido-en-vim-5dmb>dev.to</a><li><a rel=noopener target=_blank href=https://vonheikemen.hashnode.dev/the-illusion-of-fast-startup-times-in-vim-es>Hashnode</a></ul><p>O puedes contactarme en twitter
<a rel=noopener target=_blank href=https://twitter.com/VonHeikemen_>@VonHeikemen_</a><p>Gracias por su tiempo. Si este artículo les pareció útil y quieren apoyar mis esfuerzos para crear más contenido, pueden dejar una propina en buy me a coffee ☕.</p><a href=https://www.buymeacoffee.com/vonheikemen style=display:flex;justify-content:center target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-blue.png alt="Buy Me A Coffee" style=height:60px!important;width:217px!important></a></div></div>