<!doctype html><html lang=es><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1,viewport-fit=cover" name=viewport><meta content="interest-cohort=()" http-equiv=Permissions-Policy><title>
  Guía de uso del cliente LSP de Neovim | Devlog
</title><link href=https://vonheikemen.github.io/devlog/print.css media=print rel=stylesheet><link href=https://vonheikemen.github.io/devlog/styles.css rel=stylesheet><link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" rel=stylesheet><link href=https://hachyderm.io/@vonheikemen rel=me><link href=https://twitter.com/VonHeikemen_ rel=me><meta content="neovim, shell, software, coding, development" name=keywords><meta content="Agrega funcionalidades dignas de un IDE a Neovim sin instalar plugins de terceros" name=description><body class=theme-base-custom><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vonheikemen.github.io/devlog/es/><h1>Devlog</h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>whoami</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/es/tags/>Explorar tags</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/>Devlog in english</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/atom.xml>RSS</a></ul> © 2020-2024 Heiker Curiel</div></div><div class="content container"><div class=post><h1 class=post-title>Guía de uso del cliente LSP de Neovim</h1><span class=post-date>2024-01-13 | 25 minutos | <a href=https://vonheikemen.github.io/devlog/tools/neovim-lsp-client-guide/> Read in english </a> </span><blockquote>Última actualización: 2024-10-05</blockquote><p>El título original para este post era "Cómo agregar funcionalidades como las de un IDE a Neovim sin instalar plugins de terceros." Suena más interesante pero tiene demasiadas palabras. Aún así, es básicamente lo que quiero enseñarles.<p>Okey, no necesitamos plugins de terceros. Pero entonces ¿qué debemos tener?<ol><li>Neovim en su versión v0.8 o mayor<li>Un servidor LSP<li>Paciencia/Energía para escribir un poco de lua por cada servidor LSP que se quiere configurar</ol><p>Si quieren implementar lo que voy a mostrar aquí en su configuración personal, consideren dedicar un poco de tiempo para aprender lua. Aquí les dejo algunos recursos.<ul><li><a href="https://www.youtube.com/watch?v=NneB6GX1Els" rel=noopener target=_blank>Lua crash course (video de 11 min)</a><li><a href=https://learnxinyminutes.com/docs/lua/ rel=noopener target=_blank>Learn X in Y minutes: Where X = lua</a><li><a href=https://neovim.io/doc/user/lua-guide.html rel=noopener target=_blank>Guía oficial de lua para Neovim</a></ul><h2 id=todo-comienza-con-el-servidor-lsp>Todo comienza con el servidor LSP</h2><p>Un servidor LSP es un programa externo que sigue el <a href=https://microsoft.github.io/language-server-protocol/ rel=noopener target=_blank>Protocolo de Servidor de Lenguajes</a> (Language Server Protocol). En este se definen los parámetros que puede recibir un servidor LSP, y también cómo debe responder. El propósito de todo esto es que <a href=https://microsoft.github.io/language-server-protocol/implementors/tools/ rel=noopener target=_blank>cualquier herramienta que implemente el protocolo</a> pueda comunicarse con un servidor LSP.<p>Entonces, el servidor LSP es el programa que va a analizar nuestro código y le dice a nuestro editor qué debe hacer.<p><em>¿Qué servidores LSP tenemos disponibles?</em><p>La página web del protocolo <a href=https://microsoft.github.io/language-server-protocol/implementors/servers/ rel=noopener target=_blank>tiene una lista de servidores</a>.<h3 id=en-este-caso-en-particular>En este caso en particular...</h3><p>Voy a mostrarles cómo configurar <a href=https://intelephense.com/ rel=noopener target=_blank>intelephense</a>, pero tengan en cuenta que sólo es un ejemplo. Todos los pasos/consejos que compartiré pueden aplicarse a cualquier servidor.<p>Si quieren usar intelephense deben instalar <a href=https://nodejs.org/en rel=noopener target=_blank>NodeJS</a>. Si ya tienen NodeJS pueden instalar intelephense usando este comando en su terminal.<pre class=language-sh data-lang=sh style=background:#2b2c2f;color:#cccece><code class=language-sh data-lang=sh><span style=color:#6699cc>npm install</span><span style=color:#5fb3b3> -</span><span style=color:#f99157>g</span><span style=color:#6699cc> intelephense
</span></code></pre><p>Para estar seguros de que todo está bien revisen si Neovim reconoce la ruta donde esta instalado intelephense. Ejecuten este comando en Neovim.<pre class=language-vim data-lang=vim style=background:#2b2c2f;color:#cccece><code class=language-vim data-lang=vim><span>:</span><span style=color:#6699cc>echo exepath</span><span>(</span><span style=color:#99c794>'intelephense'</span><span>)
</span></code></pre><p>Debería mostrarles la ruta donde está el ejecutable de intelephense. Si no muestra nada quiere decir que algo salió mal durante la instalación.<p>Si llegaron aquí y no le dieron click al enlace de intelephense: deben saber que es un servidor LSP para php. Si sólo quieren probar el código que voy a mostrar no necesitan instalar el intérprete de php. Sólo necesitan un proyecto de php. Pueden clonar repositorio de <a href=https://github.com/minicli/minicli rel=noopener target=_blank>minicli</a>. Tiene una buena cantidad de código y no tiene dependencias.<h2 id=uso-basico>Uso básico</h2><p>Antes de empezar a escribir código deberíamos aprender cómo usar el servidor LSP. Lo primero que debemos saber es cómo ejecutarlo. Es decir, cuál es el comando que inicia el servidor. Esta información debería estar en la documentación oficial del servidor.<p>Si no podemos encontrar la información básica en la documentación del servidor, podemos ir al <a href=https://github.com/neovim/nvim-lspconfig rel=noopener target=_blank>repositorio de nvim-lspconfig</a> y buscamos la carpeta que se llama <a href=https://github.com/neovim/nvim-lspconfig/tree/master/lua/lspconfig/configs rel=noopener target=_blank>configs</a>. Ahí podemos encontrar archivos de lua que contienen la configuración para muchos servidores.<p>En este momento queremos configurar intelephense, entonces deberíamos revisar el contenido de <a href=https://github.com/neovim/nvim-lspconfig/blob/16666f1bc40f69ce05eb1883fd8c0d076284d8a5/lua/lspconfig/configs/intelephense.lua rel=noopener target=_blank>intelephense.lua</a>. El código que estamos buscando se encuentra en una propiedad llamada <code>default_config</code>. Esto:<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>default_config </span><span style=color:#5fb3b3>= {
</span><span>  </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= { '</span><span style=color:#99c794>intelephense</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>--stdio</span><span style=color:#5fb3b3>' },
</span><span>  </span><span style=color:#99c794>filetypes </span><span style=color:#5fb3b3>= { '</span><span style=color:#99c794>php</span><span style=color:#5fb3b3>' },
</span><span>  </span><span style=color:#6699cc>root_dir </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>pattern</span><span style=color:#5fb3b3>)
</span><span>    </span><span style=color:#c594c5>local </span><span>cwd </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>uv</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>cwd</span><span style=color:#5fb3b3>()
</span><span>    </span><span style=color:#c594c5>local </span><span>root </span><span style=color:#5fb3b3>= </span><span>util</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>root_pattern</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>composer.json</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>.git</span><span style=color:#5fb3b3>')(</span><span>pattern</span><span style=color:#5fb3b3>)
</span><span>
</span><span>    </span><span style=color:#5f6364>-- prefer cwd if root is a descendant
</span><span>    </span><span style=color:#c594c5>return </span><span>util</span><span style=color:#5fb3b3>.</span><span>path</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>is_descendant</span><span style=color:#5fb3b3>(</span><span>cwd</span><span style=color:#5fb3b3>, </span><span>root</span><span style=color:#5fb3b3>) and </span><span>cwd </span><span style=color:#5fb3b3>or </span><span>root
</span><span>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>}</span><span>,
</span></code></pre><p>Aquí la propiedad <code>cmd</code> es el comando que necesitamos para iniciar el servidor. <code>filetypes</code> es la lista de lenguajes que el servidor puede analizar. Y en un momento les cuento sobre <code>root_dir</code>.<h2 id=cuando-debe-ejecutarse>¿Cúando debe ejecutarse?</h2><p>En el caso de intelephense sólo lo necesitamos en archivos php, esta es la oportunidad perfecta para usar algo llamado "filetype plugin," que es básicamente un script que Neovim ejecuta después de que determina qué tipo de archivo estamos editando.<p>¿Cómo creamos un filetype plugin? Primero debemos ir a la carpeta de configuración de Neovim, y ahí debemos crear una carpeta llamada <code>ftplugin</code>. Podemos ejecutar este comando en Neovim.<pre class=language-vim data-lang=vim style=background:#2b2c2f;color:#cccece><code class=language-vim data-lang=vim><span>:call </span><span style=color:#6699cc>mkdir</span><span>(</span><span style=color:#99c794>'./ftplugin'</span><span>, </span><span style=color:#99c794>'p'</span><span>)
</span></code></pre><p>Dentro de esta carpeta debemos crear un script con el mismo nombre de un tipo de archivo.<p>Necesitamos un filetype plugin para php entonces debemos crear un archivo llamado <code>php.lua</code>.<pre class=language-vim data-lang=vim style=background:#2b2c2f;color:#cccece><code class=language-vim data-lang=vim><span>:edit ftplugin/php.</span><span style=color:#6699cc>lua</span><span> | write
</span></code></pre><p>En este script es donde vamos a ejecutar la función que "conectará" intelephense con Neovim.<h2 id=directorio-raiz>Directorio raíz</h2><p>La última pieza del rompecabezas es el <code>root_dir</code>. Simplemente debemos decirle al servidor LSP en qué ruta se encuentra el código fuente de nuestro proyecto.<p>Ahora bien, en nuestro filetype plugin vamos a usar una función llamada <a href=https://neovim.io/doc/user/lua.html#vim.fs.find() rel=noopener target=_blank>vim.fs.find()</a>. A esta función le vamos a dar una lista de nombres de archivos y nos devolverá una ruta que podemos usar.<p>¿Pero qué vamos a buscar? Archivos de configuración, los que usualmente colocamos en la carpeta raíz de un proyecto. En proyectos de php normalmente hay un <code>composer.json</code>. En proyectos de javascript siempre hay un <code>package.json</code>. En rust está el <code>cargo.toml</code>. Este es el tipo de información que vamos a darle a <code>vim.fs.find()</code> para que nos devuelva la ruta correcta.<p>Ya podemos empezar a escribir un poco de código. En <code>php.lua</code> podemos hacer una prueba con <code>vim.fs.find()</code>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- ftplugin/php.lua
</span><span>
</span><span style=color:#c594c5>local </span><span>root_files </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>composer.json</span><span style=color:#5fb3b3>'}
</span><span style=color:#c594c5>local </span><span>paths </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>find</span><span style=color:#5fb3b3>(</span><span>root_files</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>stop </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>env</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>HOME</span><span style=color:#5fb3b3>})
</span><span>
</span><span style=color:#6699cc>print</span><span style=color:#5fb3b3>(</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>fs</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>dirname</span><span style=color:#5fb3b3>(</span><span>paths</span><span style=color:#5fb3b3>[</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>]))
</span></code></pre><p>Por defecto <code>vim.fs.find()</code> comenzará a buscar en la carpeta actual y luego comenzará a buscar en la carpeta padre, y seguirá buscando "hacia arriba" hasta encontrar algo. Con el argumento <code>stop</code> le decimos que debe detener la búsqueda cuando llegue a nuestra carpeta de usuario (no queremos que el servidor empieze a analizar esta carpeta ni por accidente).<p>Debido a que <code>vim.fs.find()</code> retorna una lista nosotros debemos elegir el primer elemento. Y para asegurarnos de obtener la ruta a una carpeta usamos la función <code>vim.fs.dirname()</code>.<p>Si quieren probar este código pueden navegar a un proyecto de php con un archivo <code>composer.json</code> y revisar la ruta que detecta.<h2 id=creando-el-cliente>Creando el cliente</h2><p>Estamos listos para conectar Neovim con el servidor LSP. Ya tenemos todo lo necesario para usar la función <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.start() rel=noopener target=_blank>vim.lsp.start()</a>.<p>Esto es lo que deben saber, la primera vez que ejecutamos <code>vim.lsp.start()</code> Neovim iniciará nuestro servidor LSP como un proceso externo. Cuando se ejecuta nuevamente Neovim simplemente le enviará información al proceso del servidor LSP.<p>Entonces, nuestro filetype plugin para php debería tener este código.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- ftplugin/php.lua
</span><span>
</span><span style=color:#c594c5>local </span><span>root_files </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>composer.json</span><span style=color:#5fb3b3>'}
</span><span style=color:#c594c5>local </span><span>paths </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>find</span><span style=color:#5fb3b3>(</span><span>root_files</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>stop </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>env</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>HOME</span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>local </span><span>root_dir </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>dirname</span><span style=color:#5fb3b3>(</span><span>paths</span><span style=color:#5fb3b3>[</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>])
</span><span>
</span><span style=color:#c594c5>if </span><span>root_dir </span><span style=color:#c594c5>then
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>start</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>    </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>intelephense</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>--stdio</span><span style=color:#5fb3b3>'},
</span><span style=color:#6699cc>    </span><span style=color:#99c794>root_dir </span><span style=color:#5fb3b3>= </span><span>root_dir</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span></code></pre><p>Con esta configuración ya podremos utilizar algunas funcionalidades. Por ejemplo, si editamos un archivo php y este tiene un error, Neovim nos dirá en qué línea se encuentra el error. Debería mostrarnos algo como esto.<p><img alt="Fragmento de código php que usa el framework slimphp" src=https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xcdxdx9kj3xh90o2369u.png><p>Aquí la letra <code>E</code> que está en la línea 8 es un "diagnostic sign" que nos indica dónde está el error. El texto que se encuentra después del símbolo <code>■</code> es un "texto virtual" que nos muestra el mensaje del error.<h3 id=la-configuracion-del-servidor>La configuración del servidor</h3><p>Cada servidor LSP puede tener parámetros únicos y específicos, este tipo de parámetros debe colocarse en una propiedad llamada <code>settings</code> en la función <code>vim.lsp.start()</code>. Ahora bien, algunas veces nos encontramos que la documentación del servidor nos enseña ejemplos en este formato:<pre style=background:#2b2c2f;color:#cccece><code><span>intelephense.files.maxSize: 1000000
</span></code></pre><p>Para que funcione con el cliente LSP de Neovim debemos adaptar este formato a algo que sea compatible con lua. Les mostraré cómo se hace en este caso.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>start</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>  </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>intelephense</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>--stdio</span><span style=color:#5fb3b3>'},
</span><span style=color:#6699cc>  </span><span style=color:#99c794>root_dir </span><span style=color:#5fb3b3>= </span><span>root_dir</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#99c794>settings </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>intelephense </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>      </span><span style=color:#99c794>files </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>        </span><span style=color:#99c794>maxSize </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>1000000</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>      </span><span style=color:#5fb3b3>},
</span><span style=color:#6699cc>    </span><span style=color:#5fb3b3>}
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>}
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Básicamente cada punto es una "tabla de lua" anidada.<p>Y si hay otra configuración con el mismo prefijo <code>intelephense.files</code> simplemente la añadimos a la tabla que ya existe.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>start</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>  </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>intelephense</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>--stdio</span><span style=color:#5fb3b3>'},
</span><span style=color:#6699cc>  </span><span style=color:#99c794>root_dir </span><span style=color:#5fb3b3>= </span><span>root_dir</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#99c794>settings </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>intelephense </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>      </span><span style=color:#99c794>files </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>        </span><span style=color:#99c794>maxSize </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>1000000</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>        </span><span style=color:#99c794>otroEjemplo </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>      </span><span style=color:#5fb3b3>},
</span><span style=color:#6699cc>    </span><span style=color:#5fb3b3>}
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>}
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=donde-empezamos-a-buscar-si-algo-sale-mal>¿Dónde empezamos a buscar si algo sale mal?</h3><p>Si Neovim no fue capaz de iniciar el proceso del servidor LSP pueden revisar el log. Ejecuten este comando en Neovim:<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5fb3b3>:</span><span>lua vim</span><span style=color:#5fb3b3>.</span><span>cmd</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>edit</span><span style=color:#5fb3b3>(</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>get_log_path</span><span style=color:#5fb3b3>())
</span></code></pre><p>Cuando algo sale mal habrá unas líneas que comienzan con <code>[ERROR]</code>. Tal vez ahí pueden encontrar alguna información útil.<p>Si quieren un log con más detalles pueden agregar esto a su archivo <code>init.lua</code>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set_log_level</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>debug</span><span style=color:#5fb3b3>')
</span></code></pre><h2 id=diagnostics>Diagnostics</h2><p>"Diagnostic" es el término que se usa en Neovim para los errores que se encuentran en nuestro código fuente.<p>Un diagnóstico puede tener un signo al inicio de la línea para indicarnos que hay un error. Este es el diagnostic sign. El espacio que necesita este signo está escondido por defecto, y cuando Neovim va a mostrarlo toda la "pantalla" se mueve a la derecha. Este comportamiento puede configurarse en nuestro <code>init.lua</code>.<p>Si configuramos la opción <code>signcolumn</code> con la cadena de texto <code>yes</code>, Neovim reserva el espacio para el signo. Tendremos un espacio en blanco al inicio de la línea en todo momento.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>signcolumn </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>yes</span><span style=color:#5fb3b3>'
</span></code></pre><p>Por otro lado si asignamos la cadena de texto <code>no</code>, Neovim no mostrará ningún signo. No recomiendo esta opción, especialmente si no están al tanto de las consecuencias. Si quieren esconder los signos de diagnósticos hay una alternativa mejor.<h3 id=vim-diagnostic>vim.diagnostic</h3><p>En lua tenemos acceso al módulo <a href=https://neovim.io/doc/user/diagnostic.html rel=noopener target=_blank>vim.diagnostic</a>, y dentro de este módulo está una función llamada <a href=https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.config() rel=noopener target=_blank>.config()</a>. Si usamos esta función en nuestro archivo <code>init.lua</code> podremos configurar el comportamiento de los diagnósticos.<ul><li>Esconder los signos</ul><p>Esta es la forma segura de deshabilitar los signos de los diagnósticos.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>config</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>  </span><span style=color:#99c794>signs </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><ul><li>Deshabilitar texto virtual</ul><pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>config</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>  </span><span style=color:#99c794>virtual_text </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Si tienen <strong>Neovim v0.10 o mayor</strong> pueden leer el diagnóstico de la línea actual usando <code>&LTC-w>d</code> (control + w luego d). Este atajo ejecuta la función <a href=https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.open_float() rel=noopener target=_blank>vim.diagnostic.open_float()</a>.<p>Si están usando <strong>Neovim v0.9.5 o menor</strong> tendrán que crear un atajo de teclado.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTC-w>d</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.open_float()&LTcr></span><span style=color:#5fb3b3>')
</span></code></pre><p>Ahora bien, me gustaría poder explicarles con más detalle cada opción en <code>vim.diagnostic.config()</code> pero no tenemos tiempo. Si quieren explorar las demás opciones pueden <a href=https://neovim.io/doc/user/diagnostic.html#vim.diagnostic.config() rel=noopener target=_blank>leer la documentación</a>.<h2 id=funcionalidades-gratis>Funcionalidades gratis</h2><p>Hablemos de las funcionalidades que Neovim nos ofrece con la configuración que tenemos hasta ahora, que es básicamente lo mínimo.<p>Cuando un servidor LSP está activo en un archivo Neovim habilita ciertas funcionalidades.<p><strong>Desde Neovim v0.8</strong><ul><li><p>A la opción <code>tagfunc</code> se le asigna una función que usa el servidor LSP activo. En otras palabras, podemos saltar a la definición de una función o clase usando el atajo <code>&LTC-]></code> (Control + ]). Y podemos volver a la posición anterior usando <code>&LTC-t></code> (Control + t).</p><li><p>La opción <code>formatexpr</code> se le asigna una función que usa el servidor LSP activo. Esto quiere decir que podemos usar el operador <code>gq</code> para formatear un fragmento de código. Ejemplo: podemos ir al modo visual, seleccionamos un pedazo de código, presionamos <code>gq</code> y Neovim le pedirá al servidor LSP activo que formatee el código.</p><li><p>La opción <code>omnifunc</code> también es configurada. Esta nos permite obtener completado de código. En modo de inserción el atajo <code>&LTC-x>&LTC-o></code> (control + x y luego control + o) nos presentará sugerencias que el servidor LSP cree que son relevantes.</p></ul><p><strong>Desde Neovim v0.9</strong><ul><li>Se agrega soporte para el "resaltado semántico." Resulta que algunos servidores proporcionan información acerca de los símbolos que se encuentran en el archivo actual, y Neovim puede usar esta información para crear un resaltado de código más preciso.</ul><p><strong>Desde Neovim v0.10</strong><ul><li><p>Si estamos en modo normal y no tenemos ningún atajo vinculado a <code>K</code>, podremos usarlo para leer la documentación del símbolo que está debajo del cursor.</p><li><p>En modo normal, el atajo <code>&LTC-w>d</code> muestra los diagnósticos de la línea debajo del cursor.</p><li><p>En modo normal, el atajo <code>]d</code> mueve el cursor hacia siguiente diagnóstico más cercano.</p><li><p>En modo normal, el atajo <code>[d</code> mueve el cursor hacia diagnóstico previo.</p></ul><p><strong>Desde Neovim v0.11</strong><blockquote><p>v0.11 es la versión que está en desarrollo actualmente. La información en esta sección puede cambiar en cualquier momento.</blockquote><ul><li><p>En modo normal, el atajo <code>grn</code> renombra todas las referencias del símbolo debajo del cursor.</p><li><p>En modo normal, el atajo <code>gra</code> muestra una lista de "code actions" disponibles para la línea actual.</p><li><p>En modo normal, el atajo <code>grr</code> muestra todas las referencias del símbolo debajo del cursor.</p><li><p>En modo de inserción, el atajo <code>&LTCtrl-s></code> (Control + s) muestra documentación de los argumentos de la función debajo del cursor.</p></ul><h2 id=funciones-disponibles>Funciones disponibles</h2><p>Ahora voy a mostrarles una lista de funcionalidades que podremos usar sin mucho esfuerzo, lo único que debemos hacer es ejecutar una función de lua.<ul><li>Saltar a declaración<li>Mostrar implementaciones<li>Saltar a definición de tipo<li>Listar referencias<li>Mostrar argumentos de función<li>Renombrar referencias del símbolo debajo del cursor<li>Formatear archivo (o rango seleccionado)<li>Listar "code actions" disponibles</ul><p>Para aprovechar estas funciones podemos vincularlas a atajos de teclado.<h3 id=atajos>Atajos</h3><p>Para los atajos de teclado es muy común seguir el mismo patrón que Neovim usa en otras funcionalidades, es decir configurar funciones sólo cuando hay un servidor LSP activo. Para lograr esto podemos usar un autocomando con el evento <code>LspAttach</code>. Si no están al tanto, Neovim emite el evento <code>LspAttach</code> cada vez que activa un servidor LSP en un archivo. Y con la función <code>nvim_create_autocmd</code> podremos ejecutar una función de lua cada vez que Neovim emite ese evento.<blockquote><p>Pueden encontrar más detalles sobre autocomandos aquí: <a href=https://neovim.io/doc/user/lua-guide.html#lua-guide-autocommands rel=noopener target=_blank>lua-guide-autocommands</a>.</blockquote><p>Aquí les muestro una manera de crear atajos de teclado para las funcionalidades vinculadas a un servidor LSP.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- pueden agregar esto en su archivo `init.lua`
</span><span>
</span><span style=color:#5f6364>-- Mostrar diagnósticos de la línea actual
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gl</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.open_float()&LTcr></span><span style=color:#5fb3b3>')
</span><span>
</span><span style=color:#5f6364>-- Saltar al diagnóstico anterior
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>[d</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.goto_prev()&LTcr></span><span style=color:#5fb3b3>')
</span><span>
</span><span style=color:#5f6364>-- Saltar al siguiente diagnóstico
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>]d</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.diagnostic.goto_next()&LTcr></span><span style=color:#5fb3b3>')
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Acciones LSP</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>local </span><span style=color:#6699cc>bufmap </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>mode</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>lhs</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>rhs</span><span style=color:#5fb3b3>)
</span><span style=color:#6699cc>      </span><span style=color:#c594c5>local </span><span>opts </span><span style=color:#5fb3b3>= {</span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>}
</span><span style=color:#6699cc>      </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>(</span><span>mode</span><span style=color:#5fb3b3>, </span><span>lhs</span><span style=color:#5fb3b3>, </span><span>rhs</span><span style=color:#5fb3b3>, </span><span>opts</span><span style=color:#5fb3b3>)
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>end
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Para más información de estas funciones usen el comando :help
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- ver por ejemplo, :help vim.lsp.buf.hover()
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Muestra información sobre símbolo debajo del cursor
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>K</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.hover()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Saltar a definición
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gd</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.definition()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Saltar a declaración
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gD</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.declaration()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Mostrar implementaciones
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gi</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.implementation()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Saltar a definición de tipo
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>go</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.type_definition()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Listar referencias
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>gr</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.references()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Mostrar argumentos de función
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTC-k></span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.signature_help()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Renombrar símbolo
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTF2></span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.rename()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Listar "code actions" disponibles en la posición del cursor
</span><span style=color:#6699cc>    bufmap</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>n</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTF4></span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.buf.code_action()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>})
</span></code></pre><h2 id=advertencia>Advertencia</h2><p>No todos los servidores implementan el protocolo LSP en su totalidad. Y no todas las funcionalidades son consistentes entre servidores.<p>Por ejemplo, intelephense puede mostrar errores en nuestro código en tiempo real, sin necesidad de guardar los cambios en el archivo. Pero <a href=https://github.com/rust-lang/rust-analyzer rel=noopener target=_blank>rust-analyzer</a>, el servidor LSP para rust, sólo puede mostrar errores una vez que se guardan cambios en el archivo.<p>Otro ejemplo. <a href=https://github.com/astral-sh/ruff-lsp rel=noopener target=_blank>ruff-lsp</a>, un servidor LSP para python, en su descripción menciona que su especialidad es reportar errores y formatear código. Hasta donde pude ver este servidor no ofrece completado de código o resaltado de código semántico.<p>Lo que intento decir es esto: lean la documentación del servidor LSP para que estén informados de las funcionalidades que ofrece.<h2 id=contenido-extra>Contenido extra</h2><p>A estas alturas me atrevería a decir que ya tienen el conocimento esencial para usar el cliente LSP de Neovim y ser productivos. Lo que sigue son consejos, ajustes y funcionalidades que pueden implementar agregando un bloque de código a su configuración personal.<h3 id=configurar-un-servidor-lsp-para-multiples-tipos-de-archivo>Configurar un servidor LSP para múltiples tipos de archivo</h3><p>Para esto aún podríamos usar un filetype plugin pero existe una alternativa mejor. Tenemos la opción de crear un "plugin global" y configurar el servidor usando un autocomando con el evento <code>FileType</code>.<p>En esta ocasión vamos a utilizar <a href=https://github.com/typescript-language-server/typescript-language-server rel=noopener target=_blank>tsserver</a> como ejemplo. Y si no lo saben, <code>tsserver</code> es el servidor LSP para typescript y javascript.<p>Si quieren probar el código que les voy a mostrar, deben instalar tsserver usando este comando.<pre class=language-sh data-lang=sh style=background:#2b2c2f;color:#cccece><code class=language-sh data-lang=sh><span style=color:#6699cc>npm install</span><span style=color:#5fb3b3> -</span><span style=color:#f99157>g</span><span style=color:#6699cc> typescript typescript-language-server
</span></code></pre><p>Para crear un plugin global simplemente tenemos que crear un archivo en el lugar correcto. Vamos a la carpeta de configuración de Neovim, abrimos Neovim, y luego creamos una carpeta llamada <code>plugin</code>.<pre class=language-vim data-lang=vim style=background:#2b2c2f;color:#cccece><code class=language-vim data-lang=vim><span>:call </span><span style=color:#6699cc>mkdir</span><span>(</span><span style=color:#99c794>'./plugin'</span><span>, </span><span style=color:#99c794>'p'</span><span>)
</span></code></pre><p>Dentro de esta carpeta podemos crear un script de lua. A este script podemos darle cualquier nombre. Pero en este caso vamos a llamarlo <code>tsserver.lua</code>.<pre class=language-vim data-lang=vim style=background:#2b2c2f;color:#cccece><code class=language-vim data-lang=vim><span>:edit plugin/tsserver.</span><span style=color:#6699cc>lua</span><span> | write
</span></code></pre><p>En este script vamos a adaptar la configuración que se encuentra en el <a href=https://github.com/neovim/nvim-lspconfig/blob/16666f1bc40f69ce05eb1883fd8c0d076284d8a5/lua/lspconfig/configs/ts_ls.lua rel=noopener target=_blank>repositorio de nvim-lspconfig</a>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- plugin/tsserver.lua
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#6699cc>start_tsserver</span><span style=color:#5fb3b3>()
</span><span>  </span><span style=color:#c594c5>local </span><span>root_files </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>package.json</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>tsconfig.json</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>jsconfig.json</span><span style=color:#5fb3b3>'}
</span><span>  </span><span style=color:#c594c5>local </span><span>paths </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>find</span><span style=color:#5fb3b3>(</span><span>root_files</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>stop </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>env</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>HOME</span><span style=color:#5fb3b3>})
</span><span>  </span><span style=color:#c594c5>local </span><span>root_dir </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fs</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>dirname</span><span style=color:#5fb3b3>(</span><span>paths</span><span style=color:#5fb3b3>[</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>])
</span><span>
</span><span>  </span><span style=color:#c594c5>if </span><span>root_dir </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>start</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>    </span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>tsserver</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>    </span><span style=color:#99c794>cmd </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>typescript-language-server</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>--stdio</span><span style=color:#5fb3b3>'},
</span><span style=color:#6699cc>    </span><span style=color:#99c794>root_dir </span><span style=color:#5fb3b3>= </span><span>root_dir</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>init_options </span><span style=color:#5fb3b3>= {</span><span style=color:#99c794>hostInfo </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>neovim</span><span style=color:#5fb3b3>'},
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>FileType</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>javascript</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>javascriptreact</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>javascript.jsx</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>typescript</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>typescriptreact</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>typescript.tsx</span><span style=color:#5fb3b3>'},
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Iniciar tsserver</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>start_tsserver</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Este autocomando funciona de manera similar a un filetype plugin, la diferencia es que aquí sólo ejecutamos una función de lua y no un archivo completo. La ventaja de esto es que podemos listar varios tipos de archivos en el argumento <code>pattern</code>.<p>Antes de que se me olvide, este ejemplo no tiene que estar en la carpeta plugin. Podemos colocar este código en el archivo <code>init.lua</code>.<h3 id=agregar-bordes-a-ventanas-flotantes>Agregar bordes a ventanas flotantes</h3><p>Desafortunadamente no hay forma de colocar bordes a todas las ventanas flotantes que crea Neovim. Esto es algo que debemos configurar en cada funcionalidad que queremos usar.<p>Podemos colocar los siguientes ejemplos en el archivo <code>init.lua</code>.<ul><li>Detalles de diagnósticos</ul><p>Para la ventana que muestra el mensaje de error de un diagnóstico.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>config</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>  </span><span style=color:#99c794>float </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>border </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>rounded</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>},
</span><span style=color:#5fb3b3>})
</span></code></pre><ul><li>Documentación de símbolo</ul><p>Para la ventana que desplega la función <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.buf.hover() rel=noopener target=_blank>vim.lsp.buf.hover()</a>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span>handlers</span><span style=color:#5fb3b3>['</span><span style=color:#99c794>textDocument/hover</span><span style=color:#5fb3b3>'] = </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>with</span><span style=color:#5fb3b3>(
</span><span style=color:#6699cc>  </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>handlers</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>hover</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>border </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>rounded</span><span style=color:#5fb3b3>'}
</span><span style=color:#5fb3b3>)
</span></code></pre><ul><li>Documentación de funciones</ul><p>Para la ventana que desplega la función <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.buf.signature_help() rel=noopener target=_blank>vim.lsp.buf.signature_help()</a>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span>handlers</span><span style=color:#5fb3b3>['</span><span style=color:#99c794>textDocument/signatureHelp</span><span style=color:#5fb3b3>'] = </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>with</span><span style=color:#5fb3b3>(
</span><span style=color:#6699cc>  </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>handlers</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>signature_help</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>{</span><span style=color:#99c794>border </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>rounded</span><span style=color:#5fb3b3>'}
</span><span style=color:#5fb3b3>)
</span></code></pre><h3 id=formatear-al-guardar>Formatear al guardar</h3><p>Lo que haremos aquí es ejecutar la función <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.buf.format() rel=noopener target=_blank>vim.lsp.buf.format()</a> antes de que Neovim guarde los cambios a un archivo. Y por supuesto, esto sólo lo haremos cuando hay un servidor LSP activo.<p>Importante: los servidores LSP con capacidades para formatear código tienen su propia configuración. Por ejemplo, puede que nosotros tengamos la indentación configurada a 2 espacios pero el servidor LSP puede formatear el código con 4 espacios. Entonces, siempre es buena idea indagar en la documentación del servidor LSP para saber cómo configurar el estilo del formateo.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span style=color:#c594c5>local </span><span>fmt_group </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_augroup</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>autoformat_cmds</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>clear </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#6699cc>setup_autoformat</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>local </span><span>id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span>  </span><span style=color:#c594c5>local </span><span>client </span><span style=color:#5fb3b3>= </span><span>id </span><span style=color:#5fb3b3>and </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>get_client_by_id</span><span style=color:#5fb3b3>(</span><span>id</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>if </span><span>client </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_clear_autocmds</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>fmt_group</span><span style=color:#5fb3b3>, </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>})
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span style=color:#6699cc>buf_format </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>e</span><span style=color:#5fb3b3>)
</span><span>    vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span>buf</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>format</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>      </span><span style=color:#99c794>bufnr </span><span style=color:#5fb3b3>= </span><span>e</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>      </span><span style=color:#99c794>async </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>      </span><span style=color:#99c794>timeout_ms </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>10000</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#5fb3b3>})
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>BufWritePre</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>fmt_group</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Formatear archivo</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>    </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>buf_format</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Configurar formatear al guardar</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>setup_autoformat</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=cambiar-texto-de-signos-de-diagnosticos>Cambiar texto de signos de diagnósticos</h3><p>Si estamos usando Neovim en su <strong>versión v0.9.5 o menor</strong>, debemos usar la función <a href=https://neovim.io/doc/user/builtin.html#sign_define() rel=noopener target=_blank>vim.fn.sign_define()</a>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#6699cc>sign_define</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>args</span><span style=color:#5fb3b3>)
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>sign_define</span><span style=color:#5fb3b3>(</span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>name</span><span style=color:#5fb3b3>, {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>texthl </span><span style=color:#5fb3b3>= </span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>name</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= </span><span>args</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>text</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>numhl </span><span style=color:#5fb3b3>= ''
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span style=color:#6699cc>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignError</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>✘</span><span style=color:#5fb3b3>'})
</span><span style=color:#6699cc>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignWarn</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>▲</span><span style=color:#5fb3b3>'})
</span><span style=color:#6699cc>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignHint</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>⚑</span><span style=color:#5fb3b3>'})
</span><span style=color:#6699cc>sign_define</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>name </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>DiagnosticSignInfo</span><span style=color:#5fb3b3>', </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>»</span><span style=color:#5fb3b3>'})
</span></code></pre><p>Si estamos usando Neovim en su <strong>versión v0.10 o mayor</strong>, debemos usar la función <code>vim.diagnostic.config()</code>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>config</span><span style=color:#5fb3b3>({
</span><span style=color:#6699cc>  </span><span style=color:#99c794>signs </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>text </span><span style=color:#5fb3b3>= {
</span><span style=color:#6699cc>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>severity</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>ERROR</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>✘</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>severity</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>WARN</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>▲</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>severity</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>HINT</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>⚑</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>      </span><span style=color:#5fb3b3>[</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>severity</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>INFO</span><span style=color:#5fb3b3>] = '</span><span style=color:#99c794>»</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>    </span><span style=color:#5fb3b3>},
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>},
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=deshabilitar-diagnosticos-al-entrar-en-modo-de-insercion>Deshabilitar diagnósticos al entrar en modo de inserción</h3><p>Neovim ya lo hace por defecto pero hay problema... no un problema como tal, es un detalle: los diagnósticos sólo desaparecen cuando empezamos a editar el código.<p>Esta es la configuración que <strong>yo uso</strong> para deshabilitar immediatamente los diagnósticos al entrar en modo de inserción (o modo de selección).<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>ModeChanged</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>n:i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>v:s</span><span style=color:#5fb3b3>'},
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Deshabilitar diagnósticos</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>e</span><span style=color:#5fb3b3>) </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>disable</span><span style=color:#5fb3b3>(</span><span>e</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>})
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>ModeChanged</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>pattern </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>i:n</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Habilitar diagnósticos</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>e</span><span style=color:#5fb3b3>) </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>diagnostic</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>enable</span><span style=color:#5fb3b3>(</span><span>e</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=deshabilitar-resaltado-semantico>Deshabilitar resaltado semántico</h3><p>La documentación de Neovim sugiere "despejar" los grupos de resaltado con el prefijo <code>@lsp</code>. Entonces, deberíamos hacer algo como esto.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- este código debe ejecutarse antes de configurar el tema del editor
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>ColorScheme</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Deshabilitar resaltado semántico</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>()
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>for </span><span>_</span><span style=color:#5fb3b3>, </span><span>group </span><span style=color:#c594c5>in </span><span style=color:#6699cc>ipairs</span><span style=color:#5fb3b3>(</span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>fn</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>getcompletion</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>@lsp</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>highlight</span><span style=color:#5fb3b3>')) </span><span style=color:#c594c5>do
</span><span style=color:#6699cc>      </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_set_hl</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span>group</span><span style=color:#5fb3b3>, {})
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>end
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Debemos crear el autocomando <code>ColorScheme</code> antes de configurar el tema del editor. De esta manera Neovim puede deshabilitar el resaltado incluso si cambiamos de tema en medio de una sesión.<h3 id=resaltar-simbolo-debajo-del-cursor>Resaltar símbolo debajo del cursor</h3><p>Para esto vamos a usar la función <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.buf.document_highlight() rel=noopener target=_blank>vim.lsp.buf.document_highlight()</a>. Cuando el cursor pase una cantidad de tiempo sobre un símbolo vamos a ejecutar esa función. Y luego vamos desactivar el resaltado cuando el cursor se mueva de lugar.<p>Para que esto funcione de manera apropiada el tema del editor debe soportar los siguientes grupos:<ul><li>LspReferenceRead<li>LspReferenceText<li>LspReferenceWrite</ul><p>Si el tema que tenemos no define ningún color para esos grupos podemos hacer un "vinculo" con un grupo que ya existe. Este es un ejemplo que muestra cómo vincular al grupo <code>Search</code>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_set_hl</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>LspReferenceRead</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>link </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Search</span><span style=color:#5fb3b3>'})
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_set_hl</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>LspReferenceText</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>link </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Search</span><span style=color:#5fb3b3>'})
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_set_hl</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>LspReferenceWrite</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>link </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Search</span><span style=color:#5fb3b3>'})
</span></code></pre><pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span style=color:#5f6364>-- tiempo en milisegundos para emitir el event `CursorHold`
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>updatetime </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>400
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#6699cc>highlight_symbol</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>local </span><span>id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span>  </span><span style=color:#c594c5>local </span><span>client </span><span style=color:#5fb3b3>= </span><span>id </span><span style=color:#5fb3b3>and </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>get_client_by_id</span><span style=color:#5fb3b3>(</span><span>id</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>if </span><span>client </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#5fb3b3>or not </span><span>client</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>supports_method</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>textDocument/documentHighlight</span><span style=color:#5fb3b3>') </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span>group </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_augroup</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>highlight_symbol</span><span style=color:#5fb3b3>', {</span><span style=color:#99c794>clear </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>})
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_clear_autocmds</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>, </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>group</span><span style=color:#5fb3b3>})
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>CursorHold</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>CursorHoldI</span><span style=color:#5fb3b3>'}, {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>group</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>document_highlight</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>})
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>CursorMoved</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>CursorMovedI</span><span style=color:#5fb3b3>'}, {
</span><span style=color:#6699cc>    </span><span style=color:#99c794>group </span><span style=color:#5fb3b3>= </span><span>group</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>buffer </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>    </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>clear_references</span><span style=color:#5fb3b3>,
</span><span style=color:#6699cc>  </span><span style=color:#5fb3b3>})
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Resaltar símbolo debajo del cursor</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>highlight_symbol</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=tab-para-completar>Tab para completar</h3><p>Para mantener una implementación simple vamos a hacer lo siguiente: Si el menú de sugerencias es visible, usaremos Tab y Shift + Tab para navegar entre las sugerencias. Si el cursor está sobre un espacio en blanco, insertaremos el caracter <code>&LTTab></code>. Si no, mostraremos el menú de sugerencias.<p>Ahora bien, si tenemos un servidor LSP activo que puede proveer sugerencias usamos eso. De lo contrario le pediremos a Neovim que sugiera palabras que se encuentran en el archivo actual.<p>Nota: recuerden que pueden confirmar una sugerencia usando <code>Enter</code> o <code>&LTC-y></code> (Control + y).<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>completeopt </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>menuone</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noselect</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noinsert</span><span style=color:#5fb3b3>'}
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>shortmess</span><span style=color:#5fb3b3>:</span><span style=color:#6699cc>append</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>c</span><span style=color:#5fb3b3>')
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#6699cc>tab_complete</span><span style=color:#5fb3b3>()
</span><span>  </span><span style=color:#c594c5>if </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>pumvisible</span><span style=color:#5fb3b3>() == </span><span style=color:#f99157>1 </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- navega al siguiente elemento en la lista
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTDown></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span>c </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>col</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>') - </span><span style=color:#f99157>1
</span><span>  </span><span style=color:#c594c5>local </span><span>is_whitespace </span><span style=color:#5fb3b3>= </span><span>c </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>0 </span><span style=color:#5fb3b3>or </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>getline</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>.</span><span style=color:#5fb3b3>'):</span><span style=color:#6699cc>sub</span><span style=color:#5fb3b3>(</span><span>c</span><span style=color:#5fb3b3>, </span><span>c</span><span style=color:#5fb3b3>):</span><span style=color:#6699cc>match</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>%s</span><span style=color:#5fb3b3>')
</span><span>
</span><span>  </span><span style=color:#c594c5>if </span><span>is_whitespace </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- inserta el caracter tab
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTTab></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span>lsp_completion </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>bo</span><span style=color:#5fb3b3>.</span><span>omnifunc </span><span style=color:#5fb3b3>== '</span><span style=color:#99c794>v:lua.vim.lsp.omnifunc</span><span style=color:#5fb3b3>'
</span><span>
</span><span>  </span><span style=color:#c594c5>if </span><span>lsp_completion </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- activa el completado con el servidor LSP
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTC-x>&LTC-o></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#5f6364>-- sugiere palabras en el archivo actual
</span><span>  </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTC-x>&LTC-n></span><span style=color:#5fb3b3>'
</span><span style=color:#c594c5>end
</span><span>
</span><span style=color:#c594c5>local function </span><span style=color:#6699cc>tab_prev</span><span style=color:#5fb3b3>()
</span><span>  </span><span style=color:#c594c5>if </span><span>vim</span><span style=color:#5fb3b3>.</span><span>fn</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>pumvisible</span><span style=color:#5fb3b3>() == </span><span style=color:#f99157>1 </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#5f6364>-- navega al elemento anterior en la lista
</span><span>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTUp></span><span style=color:#5fb3b3>'
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#5f6364>-- inserta el caracter tab
</span><span>  </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTTab></span><span style=color:#5fb3b3>'
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTTab></span><span style=color:#5fb3b3>', </span><span>tab_complete</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>expr </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTS-Tab></span><span style=color:#5fb3b3>', </span><span>tab_prev</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>expr </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=expandir-snippets>Expandir snippets</h3><p>En <strong>Neovim v0.11</strong> tenemos acceso a un módulo llamado <a href=https://neovim.io/doc/user/lsp.html#lsp-completion rel=noopener target=_blank>vim.lsp.completion</a>, con esto podremos extender las funcionalidades del mecanismo de completado de código. Para ser más específico, Neovim podrá responder a más "comandos de edición" que retorne un servidor LSP. Por ejemplo, podremos expandir snippets de código.<p>Por el momento las funcionalidades de <code>vim.lsp.completion</code> son opcionales, debemos usar la función <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.completion.enable() rel=noopener target=_blank>vim.lsp.completion.enable()</a> para habilitarlas.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>opt</span><span style=color:#5fb3b3>.</span><span>completeopt </span><span style=color:#5fb3b3>= {'</span><span style=color:#99c794>menu</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>menuone</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noinsert</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>noselect</span><span style=color:#5fb3b3>'}
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Habilitar vim.lsp.completion</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>local </span><span>client_id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>if </span><span>client_id </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#c594c5>then
</span><span style=color:#6699cc>      </span><span style=color:#c594c5>return
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>end
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- advertencia: api inestable
</span><span style=color:#6699cc>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>completion</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>enable</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>true</span><span style=color:#5fb3b3>, </span><span>client_id</span><span style=color:#5fb3b3>, </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>autotrigger </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>false</span><span style=color:#5fb3b3>})
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- advertencia: api inestable
</span><span style=color:#6699cc>    </span><span style=color:#5f6364>-- Activar el menú de sugerencias manualmente
</span><span style=color:#6699cc>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTC-Space></span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>&LTcmd>lua vim.lsp.completion.trigger()&LTcr></span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>end
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Noten que el último argumento en <code>.enable()</code> tiene la propiedad <code>autotrigger</code>. <code>false</code> es el valor por defecto entonces yo lo dejo así. Si cambian ese valor a <code>true</code> Neovim podrá activar el completado de código cuando encuentre un "trigger character". Por ejemplo, con el servidor LSP de lua Neovim mostrará sugerencias cuando se encuentre con el caracter <code>.</code> o <code>:</code>.<p>Si están usando <strong>Neovim v0.10</strong> no tendrán acceso al módulo <code>vim.lsp.completion</code>, pero sí podrań usar un módulo llamado <a href=https://neovim.io/doc/user/lua.html#vim.snippet rel=noopener target=_blank>vim.snippet</a>. Con esto podrán implementar un autocomando para expandir snippets.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span style=color:#5f6364>-- Nota: esta funcion sólo expande snippets
</span><span style=color:#5f6364>-- no maneja "comandos de edición extra"
</span><span style=color:#c594c5>local function </span><span style=color:#6699cc>expand_snippet</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>local </span><span>comp </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>v</span><span style=color:#5fb3b3>.</span><span>completed_item
</span><span>  </span><span style=color:#c594c5>local </span><span>kind </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>lsp</span><span style=color:#5fb3b3>.</span><span>protocol</span><span style=color:#5fb3b3>.</span><span>CompletionItemKind
</span><span>  </span><span style=color:#c594c5>local </span><span>item </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>tbl_get</span><span style=color:#5fb3b3>(</span><span>comp</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>user_data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>nvim</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>lsp</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>completion_item</span><span style=color:#5fb3b3>')
</span><span>
</span><span>  </span><span style=color:#5f6364>-- Verifica que el item es un snippet
</span><span>  </span><span style=color:#c594c5>if </span><span style=color:#5fb3b3>(
</span><span>    </span><span style=color:#5fb3b3>not </span><span>item
</span><span>    </span><span style=color:#5fb3b3>or not </span><span>item</span><span style=color:#5fb3b3>.</span><span>insertTextFormat
</span><span>    </span><span style=color:#5fb3b3>or </span><span>item</span><span style=color:#5fb3b3>.</span><span>insertTextFormat </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>1
</span><span>    </span><span style=color:#5fb3b3>or not (
</span><span>      item</span><span style=color:#5fb3b3>.</span><span>kind </span><span style=color:#5fb3b3>== </span><span>kind</span><span style=color:#5fb3b3>.</span><span>Snippet
</span><span>      </span><span style=color:#5fb3b3>or </span><span>item</span><span style=color:#5fb3b3>.</span><span>kind </span><span style=color:#5fb3b3>== </span><span>kind</span><span style=color:#5fb3b3>.</span><span>Keyword
</span><span>    </span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#5f6364>-- Eliminar texto inicial
</span><span>  </span><span style=color:#c594c5>local </span><span>cursor </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_win_get_cursor</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>)
</span><span>  </span><span style=color:#c594c5>local </span><span>line </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_get_current_line</span><span style=color:#5fb3b3>()
</span><span>  </span><span style=color:#c594c5>local </span><span>lnum </span><span style=color:#5fb3b3>= </span><span>cursor</span><span style=color:#5fb3b3>[</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>] - </span><span style=color:#f99157>1
</span><span>  </span><span style=color:#c594c5>local </span><span>start_col </span><span style=color:#5fb3b3>= </span><span>cursor</span><span style=color:#5fb3b3>[</span><span style=color:#f99157>2</span><span style=color:#5fb3b3>] - #</span><span>comp</span><span style=color:#5fb3b3>.</span><span>word
</span><span>
</span><span>  </span><span style=color:#c594c5>if </span><span>start_col </span><span style=color:#5fb3b3>< </span><span style=color:#f99157>0 </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#c594c5>local </span><span>set_text </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span>nvim_buf_set_text
</span><span>  </span><span style=color:#c594c5>local </span><span>ok </span><span style=color:#5fb3b3>= </span><span style=color:#6699cc>pcall</span><span style=color:#5fb3b3>(</span><span>set_text</span><span style=color:#5fb3b3>, </span><span>bufnr</span><span style=color:#5fb3b3>, </span><span>lnum</span><span style=color:#5fb3b3>, </span><span>start_col</span><span style=color:#5fb3b3>, </span><span>lnum</span><span style=color:#5fb3b3>, #</span><span>line</span><span style=color:#5fb3b3>, {''})
</span><span>
</span><span>  </span><span style=color:#c594c5>if </span><span style=color:#5fb3b3>not </span><span>ok </span><span style=color:#c594c5>then
</span><span>    </span><span style=color:#c594c5>return
</span><span>  </span><span style=color:#c594c5>end
</span><span>
</span><span>  </span><span style=color:#5f6364>-- Insertar snippet
</span><span>  </span><span style=color:#c594c5>local </span><span>snip_text </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>tbl_get</span><span style=color:#5fb3b3>(</span><span>item</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>textEdit</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>newText</span><span style=color:#5fb3b3>') or </span><span>item</span><span style=color:#5fb3b3>.</span><span>insertText
</span><span>
</span><span>  </span><span style=color:#6699cc>assert</span><span style=color:#5fb3b3>(</span><span>snip_text</span><span style=color:#5fb3b3>, "</span><span style=color:#99c794>El servidor LSP dice que nos ha proporcionado un snippet, pero el campo donde debe estar el texto está vacío</span><span style=color:#5fb3b3>")
</span><span>
</span><span>  vim</span><span style=color:#5fb3b3>.</span><span>snippet</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>expand</span><span style=color:#5fb3b3>(</span><span>snip_text</span><span style=color:#5fb3b3>)
</span><span style=color:#c594c5>end
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>CompleteDone</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Expandir snippet</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  </span><span style=color:#99c794>callback </span><span style=color:#5fb3b3>= </span><span>expand_snippet
</span><span style=color:#5fb3b3>})
</span></code></pre><p>Con el módulo <code>vim.snippet</code> también podemos saltar entre placeholders dentro del snippet. En <strong>Neovim v0.11</strong> podrán usar <code>&LTTab></code> y <code>&LTShift-Tab></code> para navegar entre placeholders.<p>Si están usando <strong>Neovim v0.10</strong>, tendrán que crear sus propios atajos. Aquí les dejo una sugerencia:<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span>
</span><span style=color:#5f6364>-- Control + f: Saltar al siguiente placeholder
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>'}, '</span><span style=color:#99c794>&LTC-f></span><span style=color:#5fb3b3>', </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>()
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>if </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>snippet</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>active</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>direction </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>1</span><span style=color:#5fb3b3>}) </span><span style=color:#c594c5>then
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTcmd>lua vim.snippet.jump(1)&LTcr></span><span style=color:#5fb3b3>'
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>else
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTC-f></span><span style=color:#5fb3b3>'
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>end
</span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>expr </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span><span>
</span><span style=color:#5f6364>-- Control + b: Saltar al placeholder anterior
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>'}, '</span><span style=color:#99c794>&LTC-b></span><span style=color:#5fb3b3>', </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>()
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>if </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>snippet</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>active</span><span style=color:#5fb3b3>({</span><span style=color:#99c794>direction </span><span style=color:#5fb3b3>= -</span><span style=color:#f99157>1</span><span style=color:#5fb3b3>}) </span><span style=color:#c594c5>then
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTcmd>lua vim.snippet.jump(-1)&LTcr></span><span style=color:#5fb3b3>'
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>else
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTC-b></span><span style=color:#5fb3b3>'
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>end
</span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>expr </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span><span>
</span><span style=color:#5f6364>-- Control + l: "Salir" del snippet activo
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>keymap</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>set</span><span style=color:#5fb3b3>({'</span><span style=color:#99c794>i</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>s</span><span style=color:#5fb3b3>'}, '</span><span style=color:#99c794>&LTC-l></span><span style=color:#5fb3b3>', </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>()
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>if </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>snippet</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>active</span><span style=color:#5fb3b3>() </span><span style=color:#c594c5>then
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTcmd>lua vim.snippet.exit()&LTcr></span><span style=color:#5fb3b3>'
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>else
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>return </span><span style=color:#5fb3b3>'</span><span style=color:#99c794>&LTC-l></span><span style=color:#5fb3b3>'
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>end
</span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>expr </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>true</span><span style=color:#5fb3b3>})
</span></code></pre><h3 id=habilitar-inlay-hints>Habilitar "inlay hints"</h3><p>Inlay hints es parecido al texto virtual. Estos son fragmento de texto que Neovim agrega a lo que estamos editando, pero que en realidad no es parte del archivo. En este caso se usa para mostrar el tipo/clase de una variable o argumento de una función.<p>En este caso debemos usar la función <a href=https://neovim.io/doc/user/lsp.html#vim.lsp.inlay_hint.enable() rel=noopener target=_blank>vim.lsp.inlay_hint.enable()</a> en el archivo donde queremos habilitar esta funcionalidad. Como siempre, podemos usar un autocomando con el evento <code>LspAttach</code>.<p>Nota: la mayoría de los servidores que tienen soporte para esta funcionalidad la deshabilitan por defecto. Esto quiere decir que activar los inlay hints en Neovim no es suficiente, también debemos buscar las opciones específicas del servidor LSP y configurarlas en la función <code>vim.lsp.start()</code>.<pre class=language-lua data-lang=lua style=background:#2b2c2f;color:#cccece><code class=language-lua data-lang=lua><span style=color:#5f6364>-- Pueden agregar esto en su archivo `init.lua`
</span><span style=color:#5f6364>-- o un script en la carpeta plugin
</span><span>
</span><span>vim</span><span style=color:#5fb3b3>.</span><span>api</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>nvim_create_autocmd</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>LspAttach</span><span style=color:#5fb3b3>', {
</span><span style=color:#6699cc>  </span><span style=color:#99c794>desc </span><span style=color:#5fb3b3>= '</span><span style=color:#99c794>Habilitar inlay hints</span><span style=color:#5fb3b3>',
</span><span style=color:#6699cc>  callback </span><span style=color:#5fb3b3>= </span><span style=color:#c594c5>function</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>event</span><span style=color:#5fb3b3>)
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>local </span><span>id </span><span style=color:#5fb3b3>= </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>tbl_get</span><span style=color:#5fb3b3>(</span><span>event</span><span style=color:#5fb3b3>, '</span><span style=color:#99c794>data</span><span style=color:#5fb3b3>', '</span><span style=color:#99c794>client_id</span><span style=color:#5fb3b3>')
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>local </span><span>client </span><span style=color:#5fb3b3>= </span><span>id </span><span style=color:#5fb3b3>and </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>get_client_by_id</span><span style=color:#5fb3b3>(</span><span>id</span><span style=color:#5fb3b3>)
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>if </span><span>client </span><span style=color:#5fb3b3>== </span><span style=color:#f99157>nil </span><span style=color:#5fb3b3>or not </span><span>client</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>supports_method</span><span style=color:#5fb3b3>('</span><span style=color:#99c794>textDocument/inlayHint</span><span style=color:#5fb3b3>') </span><span style=color:#c594c5>then
</span><span style=color:#6699cc>      </span><span style=color:#c594c5>return
</span><span style=color:#6699cc>    </span><span style=color:#c594c5>end
</span><span style=color:#6699cc>
</span><span style=color:#6699cc>    </span><span>vim</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>lsp</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>inlay_hint</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>enable</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>true</span><span style=color:#5fb3b3>, {</span><span style=color:#99c794>bufnr </span><span style=color:#5fb3b3>= </span><span>event</span><span style=color:#5fb3b3>.</span><span style=color:#6699cc>buf</span><span style=color:#5fb3b3>})
</span><span style=color:#6699cc>  </span><span style=color:#c594c5>end</span><span style=color:#5fb3b3>,
</span><span style=color:#5fb3b3>})
</span></code></pre><h2 id=conclusion>Conclusión</h2><p>Les mostré cómo "conectar" un servidor LSP con Neovim. Tuvimos que ejecutar 1 comando en la terminal y agregar 9 líneas de código a un archivo de lua. ¿No fue tan difícil, verdad?<p>La parte que realmente requiere esfuerzo es aprender todo el contexto necesario. ¿Qué significa LSP? ¿Qué es un servidor LSP? ¿Filetype plugin? Pero una vez que tienen conocimiento de todas las piezas involucradas todo se hace más fácil.<p>Una cosa más... por favor no ignoren el "conocimento básico." Dediquen un poco de tiempo para aprender la sintaxis de lua. Aprendan sobre el comando <code>:help</code> en Neovim. Investiguen un poco sobre la API de lua que ofrece Neovim. Les aconsejo leer <a href=https://neovim.io/doc/user/lua-guide.html rel=noopener target=_blank>la guía oficial de lua</a> que está en la documentación de Neovim, es buen punto de partida.<hr><p>Si tienen alguna pregunta pueden contactarme por las redes sociales:<ul><li>Twitter <a rel="noopener me" href=https://twitter.com/VonHeikemen_ target=_blank> @VonHeikemen_ </a><li>Mastodon <a rel="noopener me" href=https://hachyderm.io/@vonheikemen target=_blank> @vonheikemen@hachyderm.io </a></ul><p>Gracias por su tiempo. Si este artículo les pareció útil y quieren apoyar mis esfuerzos para crear más contenido, pueden dejar una propina en buy me a coffee ☕.</p><a href=https://ko-fi.com/vonheikemen style=display:flex;justify-content:center target=_blank> <img alt="Buy Me A Coffee" src="https://storage.ko-fi.com/cdn/kofi2.png?v=3" style=height:60px!important;width:217px!important> </a></div></div>