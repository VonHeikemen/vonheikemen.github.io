<!doctype html><html lang=es><meta http-equiv=x-ua-compatible content="IE=edge"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"><meta http-equiv=permissions-policy content="interest-cohort=()"><title>Un vistazo a las máquinas de estados finitos | Devlog</title><link rel=stylesheet href=https://vonheikemen.github.io/devlog/print.css media=print><link rel=stylesheet href=https://vonheikemen.github.io/devlog/styles.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><meta name=keywords content="javascript,aprendizaje,software,coding,development"><meta name=monetization content="$ilp.uphold.com/dFQbFZ49nJdQ"><meta name=description content="Veamos si las máquinas de estados son útiles"><link rel=canonical href=https://dev.to/vonheikemen/un-vistazo-a-las-maquinas-de-estados-finitos-1181><body class=theme-base-custom><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://vonheikemen.github.io/devlog/es/><h1>Devlog</h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>whoami</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/es/tags/>Explorar tags</a><li class=sidebar-nav-item><a href=https://vonheikemen.github.io/devlog/>Devlog in english</a></ul>© 2020-2021 Heiker Curiel</div></div><div class="content container"><div class=post><h1 class=post-title>Un vistazo a las máquinas de estados finitos</h1><span class=post-date>2019-11-14
| Originalmente publicado en
<a href=https://dev.to/vonheikemen/un-vistazo-a-las-maquinas-de-estados-finitos-1181>dev.to</a>
| 9 minutos
| <a href=https://vonheikemen.github.io/devlog/web-development/taking-a-look-at-finite-state-machine/>Read in english</a></span><h2 id=maquinas-de-que-quien>¿Máquinas de qué-- quién?</h2><p>Las máquinas de estados finitos son una manera de modelar el comportamiento de un sistema. La idea es que tu "sistema" sólo puede encontrarse en un estado a la vez, y una entrada (evento) puede activar la transición a otro estado.<h2 id=que-tipo-de-problemas-resuelven>¿Qué tipo de problemas resuelven?</h2><p>Estados inválidos. ¿Cuántas veces han tenido que usar una variable con un booleano o un atributo como "disabled" para evitar que un usuario haga algo indebido? Al marcar las reglas de comportamiento por adelantado podemos evitar este tipo de cosas.<h2 id=como-se-hace-eso-en-javascript>¿Cómo se hace eso en javascript?</h2><p>Me alegra que preguntaran. La verdadera razón por la escribo esto es para mostrar una librería que vi el otro día. Vamos a usar <a rel=noopener target=_blank href=https://thisrobot.life/>robot3</a> para crear un máquina de frases semi-famosas.<p>Lo que haremos será mostrar una "carta" con una frase y debajo de tendremos un botón que podremos usar para mostrar otra frase.<p>Haremos esto un paso a la vez. Primero preparemos los posibles estados de la aplicación.<p>Nuestra carta estará en estado <code>idle</code> (algo así como 'esperando') o <code>loading</code> (cargando) Crearemos nuestra máquina a partir de eso.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{
</span><span>  createMachine</span><span style=color:#5fb3b3>,
</span><span>  state</span><span style=color:#5fb3b3>,
</span><span>  interpret
</span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>https://unpkg.com/robot3@0.2.9/machine.js</span><span style=color:#5fb3b3>&#39;;
</span><span>
</span><span style=color:#c594c5>const </span><span>mr_robot </span><span style=color:#5fb3b3>= </span><span style=color:#69c>createMachine</span><span>(</span><span style=color:#5fb3b3>{
</span><span>  idle</span><span style=color:#5fb3b3>: </span><span style=color:#69c>state</span><span>()</span><span style=color:#5fb3b3>,
</span><span>  loading</span><span style=color:#5fb3b3>: </span><span style=color:#69c>state</span><span>()
</span><span style=color:#5fb3b3>}</span><span>)</span><span style=color:#5fb3b3>;
</span></code></pre><p>Aquí cada <code>estado</code> es un índice del "objeto de configuración" que le pasamos a <code>createMachine</code>, vean que cada uno de estos índices deben ser el resultado de llamar la función <code>state</code>.<p>Ahora necesitamos transiciones. El estado <code>idle</code> cambiará a estado <code>loading</code> si ocurre un evento <code>fetch</code> (buscar), <code>loading</code> volverá a <code>idle</code> cuando el evento <code>done</code> (terminado) sea despachado.<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span> import {
</span><span>  createMachine,
</span><span>  state,
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794> transition,
</span><span>  interpret
</span><span> } from &#39;https://unpkg.com/robot3@0.2.9/machine.js&#39;;
</span><span>
</span><span>const mr_robot = createMachine({
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  idle: state(),
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  loading: state()
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;)),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  loading: state(transition(&#39;done&#39;, &#39;idle&#39;))
</span><span> });
</span></code></pre><p><code>transition</code> es lo que conecta los estados. El primer parámetro que recibe es el nombre del evento que lo activará, el segundo parámetro es el "evento destino" al cual cambiará. El resto de los parámetros consiste en una de funciones que serán ejecutadas cuando ocurra la transición.<p>Luce bien y todo pero... uhm... ¿cómo hacemos pruebas? Por sí sola la máquina no hace nada. Necesitamos que nuestra máquina sea interpretada y para ello se la pasamos a la función <code>interpret</code>, esta función nos devuelve un "servicio" con el cual podemos despachar eventos. Para asegurarnos que de verdad estamos haciendo algo vamos a usar el segundo parámetro de <code>interpret</code> el cual será una función que "escuchará" los cambios de estado.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>const </span><span style=color:#69c>handler </span><span style=color:#5fb3b3>= ({ </span><span style=color:#f99157>machine </span><span style=color:#5fb3b3>}) </span><span style=color:#c594c5>=&gt; </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>console</span><span style=color:#5fb3b3>.</span><span style=color:#69c>log</span><span>(machine</span><span style=color:#5fb3b3>.</span><span>current)</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#c594c5>const </span><span style=color:#5fb3b3>{ </span><span>send </span><span style=color:#5fb3b3>} = </span><span style=color:#69c>interpret</span><span>(mr_robot</span><span style=color:#5fb3b3>, </span><span>handler)</span><span style=color:#5fb3b3>;
</span></code></pre><p>Ahora veamos si está viva.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>fetch</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>fetch</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>fetch</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>done</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span>
</span><span style=color:#5f6364>// Deberían ver en la cónsola
</span><span style=color:#5f6364>// loading (3)
</span><span style=color:#5f6364>// idle
</span></code></pre><p>Despachar <code>fetch</code> hace que el estado actual se convierta en <code>loading</code> y despachar<code>done</code> lo regresa a <code>idle</code>. Veo que no están impresionados. Bien. Intentemos algo más. Agregemos otro estado <code>end</code> y hagamos que <code>loading</code> cambie a ese, luego despachamos <code>done</code> y vemos qué pasa.<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span> const mr_robot = createMachine({
</span><span>   idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;)),
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>   loading: state(transition(&#39;done&#39;, &#39;idle&#39;))
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>   loading: state(transition(&#39;done&#39;, &#39;end&#39;)),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>   end: state()
</span><span> });
</span></code></pre><pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>done</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span>
</span><span style=color:#5f6364>// Deberían ver en la cónsola
</span><span style=color:#5f6364>// idle
</span></code></pre><p>Enviar <code>done</code> mientras el estado es <code>idle</code> no activa el estado <code>loading</code>, se queda en <code>idle</code> porque ese estado no tiene un evento <code>done</code>. Y ahora...<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#5f6364>// El curso normal de eventos.
</span><span>
</span><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>fetch</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>done</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span>
</span><span style=color:#5f6364>// Deberían ver en la cónsola
</span><span style=color:#5f6364>// loading
</span><span style=color:#5f6364>// end
</span><span>
</span><span style=color:#5f6364>// Intenten con `fetch`
</span><span style=color:#69c>send</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>fetch</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span>
</span><span style=color:#5f6364>// Ahora...
</span><span style=color:#5f6364>// end
</span></code></pre><p>Si enviamos <code>fetch</code> (o cualquier otro evento) mientras el estado es <code>end</code> resultará en <code>end</code> siempre. ¿Por qué? Porque no hay a dónde ir, <code>end</code> no tiene transiciones.<p>Espero que les haya sido útil, si no fue así me disculpo por tanto <code>console.log</code>.<p>Volvamos a nuestra máquina. Esto es lo que tenemos hasta ahora.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span> </span><span style=color:#c594c5>import </span><span style=color:#5fb3b3>{
</span><span>  createMachine</span><span style=color:#5fb3b3>,
</span><span>  state</span><span style=color:#5fb3b3>,
</span><span>  transition</span><span style=color:#5fb3b3>,
</span><span>  interpret
</span><span style=color:#5fb3b3>} </span><span style=color:#c594c5>from </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>https://unpkg.com/robot3@0.2.9/machine.js</span><span style=color:#5fb3b3>&#39;;
</span><span>
</span><span style=color:#c594c5>const </span><span>mr_robot </span><span style=color:#5fb3b3>= </span><span style=color:#69c>createMachine</span><span>(</span><span style=color:#5fb3b3>{
</span><span>  idle</span><span style=color:#5fb3b3>: </span><span style=color:#69c>state</span><span>(</span><span style=color:#69c>transition</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>fetch</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>loading</span><span style=color:#5fb3b3>&#39;</span><span>))</span><span style=color:#5fb3b3>,
</span><span>  loading</span><span style=color:#5fb3b3>: </span><span style=color:#69c>state</span><span>(</span><span style=color:#69c>transition</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>done</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>idle</span><span style=color:#5fb3b3>&#39;</span><span>))
</span><span style=color:#5fb3b3>}</span><span>)</span><span style=color:#5fb3b3>;
</span><span>
</span><span style=color:#c594c5>const </span><span style=color:#69c>handler </span><span style=color:#5fb3b3>= ({ </span><span style=color:#f99157>machine </span><span style=color:#5fb3b3>}) </span><span style=color:#c594c5>=&gt; </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>console</span><span style=color:#5fb3b3>.</span><span style=color:#69c>log</span><span>(machine</span><span style=color:#5fb3b3>.</span><span>current)</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#c594c5>const </span><span style=color:#5fb3b3>{ </span><span>send </span><span style=color:#5fb3b3>} = </span><span style=color:#69c>interpret</span><span>(mr_robot</span><span style=color:#5fb3b3>, </span><span>handler)</span><span style=color:#5fb3b3>;
</span></code></pre><p>Pero aún no es suficiente, ahora debemos extraer datos de alguna parte cuando el estado sea <code>loading</code>. Vamos a fingir que buscamos los datos en nuestra función.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>function </span><span style=color:#69c>get_quote</span><span style=color:#5fb3b3>() {
</span><span style=color:#5fb3b3>  </span><span style=color:#5f6364>// crea un retraso de 3 a 5 segundos.
</span><span>  </span><span style=color:#c594c5>const </span><span>delay </span><span style=color:#5fb3b3>= </span><span style=color:#69c>random_number</span><span>(</span><span style=color:#f99157>3</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>5</span><span>) </span><span style=color:#5fb3b3>* </span><span style=color:#f99157>1000</span><span style=color:#5fb3b3>;
</span><span>
</span><span>  </span><span style=color:#c594c5>const </span><span>promise </span><span style=color:#5fb3b3>= new </span><span>Promise(</span><span style=color:#f99157>res </span><span style=color:#c594c5>=&gt; </span><span style=color:#5fb3b3>{
</span><span>    </span><span style=color:#69c>setTimeout</span><span>(</span><span style=color:#5fb3b3>() </span><span style=color:#c594c5>=&gt; </span><span style=color:#69c>res</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>&lt;quote&gt;</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>, </span><span>delay)</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#5fb3b3>}</span><span>)</span><span style=color:#5fb3b3>;
</span><span>  
</span><span style=color:#5fb3b3>  </span><span style=color:#5f6364>// nomás pa&#39; ver
</span><span>  promise</span><span style=color:#5fb3b3>.</span><span style=color:#69c>then</span><span>(</span><span style=color:#f99157>res </span><span style=color:#c594c5>=&gt; </span><span>(</span><span style=color:#fac863>console</span><span style=color:#5fb3b3>.</span><span style=color:#69c>log</span><span>(res)</span><span style=color:#5fb3b3>, </span><span>res))</span><span style=color:#5fb3b3>;
</span><span>
</span><span>  </span><span style=color:#c594c5>return </span><span>promise</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>Para integrar esta función a nuestra máquina vamos a usar la función <code>invoke</code>, esta nos ayuda a manejar "funciones asíncronas" (una función que devuelve una promesa) cuando se active el estado, luego cuando la promesa se resuelve envía el evento <code>done</code> (si algo falla envía el evento <code>error</code>).<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span>  import {
</span><span>   createMachine,
</span><span>   state,
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  invoke,
</span><span>   transition,
</span><span>   interpret
</span><span> } from &#39;https://unpkg.com/robot3@0.2.9/machine.js&#39;;
</span><span>
</span><span> const mr_robot = createMachine({
</span><span>   idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;)),
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  loading: state(transition(&#39;done&#39;, &#39;idle&#39;)),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  loading: invoke(get_quote, transition(&#39;done&#39;, &#39;idle&#39;)),
</span><span> });
</span></code></pre><p>Si prueban <code>send('fetch')</code> deberían ver en la cónsola.<pre style=background-color:#2b2c2f;color:#cccece><code><span>loading
</span><span>
</span><span>// Esperen unos segundos...
</span><span>
</span><span>&lt;quote&gt;
</span><span>idle
</span></code></pre><p>Espero que estas alturas se estén preguntando ¿Y dónde guardamos los datos? <code>createMachine</code> nos deja definir un "contexto" que estará disponible para nosotros en las función que apliquemos en las transiciones.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>const </span><span style=color:#69c>context </span><span style=color:#5fb3b3>= </span><span style=color:#f99157>ev </span><span style=color:#c594c5>=&gt; </span><span>(</span><span style=color:#5fb3b3>{
</span><span>  data</span><span style=color:#5fb3b3>: {},
</span><span style=color:#5fb3b3>}</span><span>)</span><span style=color:#5fb3b3>;
</span></code></pre><pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span>  const mr_robot = createMachine({
</span><span>    idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;)),
</span><span>    loading: invoke(get_quote, transition(&#39;done&#39;, &#39;idle&#39;)),
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67> });
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794> }, context);
</span></code></pre><p>Ahora agregaremos una función a nuestra transición <code>loading</code>. Será el lugar donde modificaremos el context. Esta función es llamada <code>reduce</code> y luce así.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#69c>reduce</span><span>(</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>ctx</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>ev</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>=&gt; </span><span>(</span><span style=color:#5fb3b3>{ ...</span><span>ctx</span><span style=color:#5fb3b3>, </span><span>data</span><span style=color:#5fb3b3>: </span><span>ev</span><span style=color:#5fb3b3>.</span><span>data </span><span style=color:#5fb3b3>}</span><span>))
</span></code></pre><p>Recibe el context actual, una carga (aquí la llamamos <code>ev</code>) y lo que sea que devuelva se convertirá en tu nuevo contexto.<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span>  import {
</span><span>   createMachine,
</span><span>   state,
</span><span>   invoke,
</span><span>   transition,
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  reduce,
</span><span>   interpret
</span><span> } from &#39;https://unpkg.com/robot3@0.2.9/machine.js&#39;;
</span><span>
</span><span> const mr_robot = createMachine({
</span><span>   idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;)),
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  loading: invoke(get_quote, transition(&#39;done&#39;, &#39;idle&#39;)), 
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  loading: invoke(
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    get_quote, 
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    transition(
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>      &#39;done&#39;,
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>      &#39;idle&#39;,
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>      reduce((ctx, ev) =&gt; ({ ...ctx, data: ev.data }))
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    )
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  ),
</span><span> }, context);
</span></code></pre><p>Hora de probar. ¿Cómo lo hacemos? Modificamos el callback de <code>interpret</code>.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>const </span><span style=color:#69c>handler </span><span style=color:#5fb3b3>= ({ </span><span style=color:#f99157>machine</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>context </span><span style=color:#5fb3b3>}) </span><span style=color:#c594c5>=&gt; </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>console</span><span style=color:#5fb3b3>.</span><span style=color:#69c>log</span><span>(</span><span style=color:#f99157>JSON</span><span style=color:#5fb3b3>.</span><span style=color:#69c>stringify</span><span>(</span><span style=color:#5fb3b3>{ 
</span><span>    state</span><span style=color:#5fb3b3>: </span><span>machine</span><span style=color:#5fb3b3>.</span><span>current</span><span style=color:#5fb3b3>,
</span><span>    context
</span><span>  </span><span style=color:#5fb3b3>}</span><span>))</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>Deberían ver esto.<pre style=background-color:#2b2c2f;color:#cccece><code><span>{&#39;state&#39;:&#39;loading&#39;,&#39;context&#39;:{&#39;data&#39;:{}}}
</span><span>
</span><span>// esperen unos segundos...
</span><span>
</span><span>{&#39;state&#39;:&#39;idle&#39;,&#39;context&#39;:{&#39;data&#39;:&#39;&lt;quote&gt;&#39;}}
</span></code></pre><p>Estamos listos. Mostremos algo en el navegador.<pre data-lang=html style=background-color:#2b2c2f;color:#cccece class=language-html><code class=language-html data-lang=html><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>main </span><span style=color:#bb80b3>id</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>app</span><span style=color:#5fb3b3>&quot; </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>card</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>  </span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>section </span><span style=color:#bb80b3>id</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>card</span><span style=color:#5fb3b3>&quot; </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>card__content</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>     </span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>div </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>card__body</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>        </span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>div </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>card__quote</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>          quote
</span><span>        </span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>div</span><span style=color:#5fb3b3>&gt;
</span><span>
</span><span>        </span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>div </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>card__author</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>          -- author
</span><span>        </span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>div</span><span style=color:#5fb3b3>&gt;
</span><span>      </span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>div</span><span style=color:#5fb3b3>&gt;
</span><span>      </span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>div </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>card__footer</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>        </span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>button </span><span style=color:#bb80b3>id</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>load_btn</span><span style=color:#5fb3b3>&quot; </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>btn btn--new</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>          More
</span><span>        </span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>button</span><span style=color:#5fb3b3>&gt;
</span><span>        </span><span style=color:#5fb3b3>&lt;</span><span style=color:#eb606b>a </span><span style=color:#bb80b3>href</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>#</span><span style=color:#5fb3b3>&quot; </span><span style=color:#bb80b3>target</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>_blank</span><span style=color:#5fb3b3>&quot; </span><span style=color:#bb80b3>class</span><span style=color:#5fb3b3>=&quot;</span><span style=color:#99c794>btn btn--tweet</span><span style=color:#5fb3b3>&quot;&gt;
</span><span>          Tweet
</span><span>        </span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>a</span><span style=color:#5fb3b3>&gt;
</span><span>      </span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>div</span><span style=color:#5fb3b3>&gt; 
</span><span>  </span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>section</span><span style=color:#5fb3b3>&gt; 
</span><span style=color:#5fb3b3>&lt;/</span><span style=color:#eb606b>main</span><span style=color:#5fb3b3>&gt;
</span></code></pre><pre data-lang=css style=background-color:#2b2c2f;color:#cccece class=language-css><code class=language-css data-lang=css><span style=color:#eb606b>body </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>display</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>flex</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>justify-content</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>center</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>align-items</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>center</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>min-height</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>95vh</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>background</span><span style=color:#5fb3b3>: #ddd;
</span><span>  </span><span style=color:#fac863>font-size</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>1em</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>color</span><span style=color:#5fb3b3>: #212121;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>card </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>width</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>600px</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>background</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>white</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>box-shadow</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>0 2px 5px 0 </span><span style=color:#69c>rgba</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>.</span><span style=color:#f99157>16</span><span style=color:#5fb3b3>)</span><span>, </span><span style=color:#f99157>0 2px 10px 0 </span><span style=color:#69c>rgba</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>.</span><span style=color:#f99157>12</span><span style=color:#5fb3b3>);
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>card__content </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>color</span><span style=color:#5fb3b3>: #212121;
</span><span>  </span><span style=color:#fac863>padding</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>20px</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>card__content--loader </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>height</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>95px</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>display</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>flex</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>align-items</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>center</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>justify-content</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>center
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>card__body </span><span style=color:#5fb3b3>{
</span><span> </span><span style=color:#fac863>padding-bottom</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>15px</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>card__author </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>padding-top</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>10px</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>font-style</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>italic</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>card__footer </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>width</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>100%</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>display</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>flex</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>justify-content</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>space-between</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>btn </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>color</span><span style=color:#5fb3b3>: #fff;
</span><span>  </span><span style=color:#fac863>cursor</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>pointer</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>margin-top</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>10px</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>margin-left</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>10px</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>border-radius</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>.</span><span style=color:#f99157>4rem</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>text-decoration</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>none</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>display</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>inline-block</span><span style=color:#5fb3b3>;
</span><span>  </span><span style=color:#fac863>padding</span><span style=color:#5fb3b3>: .</span><span style=color:#f99157>3rem </span><span style=color:#5fb3b3>.</span><span style=color:#f99157>9rem</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>btn--new </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>background-color</span><span style=color:#5fb3b3>: #2093be;
</span><span>  </span><span style=color:#fac863>border</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>.</span><span style=color:#f99157>1rem solid </span><span style=color:#5fb3b3>#2093be;
</span><span>  
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>btn--tweet </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>background-color</span><span style=color:#5fb3b3>: #0074d9;
</span><span>  </span><span style=color:#fac863>border</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>.</span><span style=color:#f99157>1rem solid </span><span style=color:#5fb3b3>#0074d9;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>btn</span><span style=color:#5fb3b3>:</span><span>hover </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>background</span><span style=color:#5fb3b3>: #3cb0fd;
</span><span>  </span><span style=color:#fac863>border</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>0</span><span style=color:#5fb3b3>.</span><span style=color:#f99157>1rem solid </span><span style=color:#5fb3b3>#3cb0fd;
</span><span>  </span><span style=color:#fac863>text-decoration</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>none</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#5fb3b3>.</span><span style=color:#bb80b3>hide </span><span style=color:#5fb3b3>{
</span><span>  </span><span style=color:#fac863>display</span><span style=color:#5fb3b3>: </span><span style=color:#f99157>none</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>La última pieza del rompecabezas, los efectos secundarios. Necesitamos agregar otra función a la transición <code>loading</code> para poder actualizar el DOM. Podríamos usar <code>reduce</code> nuevamente pero es de mala educación hacer eso en algo que se llame <code>reduce</code>. Utilizaremos otra función, una llamada <code>action</code>.<p>Pero primero debemos preprarnos. Modificaremos el contexto con las dependencias necesarias. (Este paso es innecesario, esto es sólo por mi alergia a las variables globales)<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span> const context = ev =&gt; ({
</span><span>   data: {},
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  dom: {
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    quote: document.querySelector(&#39;.card__quote&#39;),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    author: document.querySelector(&#39;.card__author&#39;),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    load_btn: window.load_btn,
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    tweet_btn: document.querySelector(&#39;.btn--tweet&#39;),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    card: window.card
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  }
</span><span> });
</span></code></pre><p>Ahora sí, efectos secundarios. En este punto deberían asegurarse que <code>get_quote</code> devuelva un objeto con las propiedades <code>quote</code> y <code>author</code>.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>function </span><span style=color:#69c>update_card</span><span style=color:#5fb3b3>({ </span><span style=color:#f99157>dom</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>data </span><span style=color:#5fb3b3>}) {
</span><span>  dom</span><span style=color:#5fb3b3>.</span><span>load_btn</span><span style=color:#5fb3b3>.</span><span>textContent </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>More</span><span style=color:#5fb3b3>&#39;;
</span><span>  dom</span><span style=color:#5fb3b3>.</span><span>quote</span><span style=color:#5fb3b3>.</span><span>textContent </span><span style=color:#5fb3b3>= </span><span>data</span><span style=color:#5fb3b3>.</span><span>quote</span><span style=color:#5fb3b3>;
</span><span>  dom</span><span style=color:#5fb3b3>.</span><span>author</span><span style=color:#5fb3b3>.</span><span>textContent </span><span style=color:#5fb3b3>= </span><span>data</span><span style=color:#5fb3b3>.</span><span>author</span><span style=color:#5fb3b3>;
</span><span>
</span><span>  </span><span style=color:#c594c5>const </span><span>web_intent </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>https://twitter.com/intent/tweet?text=</span><span style=color:#5fb3b3>&#39;;
</span><span>  </span><span style=color:#c594c5>const </span><span>tweet </span><span style=color:#5fb3b3>= `${</span><span>data</span><span style=color:#5fb3b3>.</span><span>quote</span><span style=color:#5fb3b3>}</span><span style=color:#99c794> -- </span><span style=color:#5fb3b3>${</span><span>data</span><span style=color:#5fb3b3>.</span><span>author</span><span style=color:#5fb3b3>}`;
</span><span>  dom</span><span style=color:#5fb3b3>.</span><span>tweet_btn</span><span style=color:#5fb3b3>.</span><span style=color:#69c>setAttribute</span><span>(
</span><span>    </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>href</span><span style=color:#5fb3b3>&#39;, </span><span>web_intent </span><span style=color:#5fb3b3>+ </span><span style=color:#69c>encodeURIComponent</span><span>(tweet)
</span><span>  )</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span><span>
</span><span style=color:#c594c5>function </span><span style=color:#69c>show_loading</span><span style=color:#5fb3b3>({ </span><span style=color:#f99157>dom </span><span style=color:#5fb3b3>}) {
</span><span>  dom</span><span style=color:#5fb3b3>.</span><span>load_btn</span><span style=color:#5fb3b3>.</span><span>textContent </span><span style=color:#5fb3b3>= &#39;</span><span style=color:#99c794>Loading...</span><span style=color:#5fb3b3>&#39;;
</span><span style=color:#5fb3b3>}
</span></code></pre><p>Juntamos todo.<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span>  import {
</span><span>   createMachine,
</span><span>   state,
</span><span>   invoke,
</span><span>   transition,
</span><span>   reduce,
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  action,
</span><span>   interpret
</span><span> } from &#39;https://unpkg.com/robot3@0.2.9/machine.js&#39;;
</span><span>
</span><span> const mr_robot = createMachine({
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;)),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;, action(show_loading))),
</span><span>   loading: invoke(
</span><span>     get_quote, 
</span><span>     transition(
</span><span>       &#39;done&#39;,
</span><span>       &#39;idle&#39;,
</span><span>       reduce((ctx, ev) =&gt; ({ ...ctx, data: ev.data })),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>      action(update_card)
</span><span>     )
</span><span>   ),
</span><span> }, context);
</span></code></pre><p>Funciona. Pero se ve mal cuando carga por primera vez. Hagamos otra transición de carga, una que esconda la carta mientras se carga la primera frase.<p>Empecemos por el HTML.<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span> &lt;main id=&quot;app&quot; class=&quot;card&quot;&gt;
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  &lt;section class=&quot;card__content card__content--loader&quot;&gt; 
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    &lt;p&gt;Loading&lt;/p&gt; 
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  &lt;/section&gt;
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  &lt;section id=&quot;card&quot; class=&quot;card__content&quot;&gt;
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  &lt;section id=&quot;card&quot; class=&quot;hide card__content&quot;&gt;
</span><span>     &lt;div class=&quot;card__body&quot;&gt;
</span><span>       &lt;div class=&quot;card__quote&quot;&gt;
</span><span>         quote
</span><span>       &lt;/div&gt;
</span><span>
</span><span>       &lt;div class=&quot;card__author&quot;&gt;
</span><span>          -- author
</span><span>       &lt;/div&gt;
</span><span>     &lt;/div&gt;
</span><span>     &lt;div class=&quot;card__footer&quot;&gt;
</span><span>       &lt;button id=&quot;load_btn&quot; class=&quot;btn btn--new&quot;&gt;
</span><span>         More
</span><span>       &lt;/button&gt;
</span><span>       &lt;a href=&quot;#&quot; target=&quot;_blank&quot; class=&quot;btn btn--tweet&quot;&gt;
</span><span>         Tweet
</span><span>       &lt;/a&gt;
</span><span>     &lt;/div&gt; 
</span><span>   &lt;/section&gt; 
</span><span> &lt;/main&gt;
</span></code></pre><p>Creamos otro estado, <code>empty</code>. Podemos reusar la lógica del estado <code>loading</code> para esto. Creamos una función que crea transiciones.<pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>const </span><span style=color:#69c>load_quote </span><span style=color:#5fb3b3>= (...</span><span style=color:#f99157>args</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>=&gt;
</span><span>  </span><span style=color:#69c>invoke</span><span>(
</span><span>    get_quote</span><span style=color:#5fb3b3>,
</span><span>    </span><span style=color:#69c>transition</span><span>(
</span><span>      </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>done</span><span style=color:#5fb3b3>&#39;,
</span><span>      </span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>idle</span><span style=color:#5fb3b3>&#39;,
</span><span>      </span><span style=color:#69c>reduce</span><span>(</span><span style=color:#5fb3b3>(</span><span style=color:#f99157>ctx</span><span style=color:#5fb3b3>, </span><span style=color:#f99157>ev</span><span style=color:#5fb3b3>) </span><span style=color:#c594c5>=&gt; </span><span>(</span><span style=color:#5fb3b3>{ ...</span><span>ctx</span><span style=color:#5fb3b3>, </span><span>data</span><span style=color:#5fb3b3>: </span><span>ev</span><span style=color:#5fb3b3>.</span><span>data </span><span style=color:#5fb3b3>}</span><span>))</span><span style=color:#5fb3b3>,
</span><span>      </span><span style=color:#5fb3b3>...</span><span>args
</span><span>    )</span><span style=color:#5fb3b3>,
</span><span>    </span><span style=color:#69c>transition</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>error</span><span style=color:#5fb3b3>&#39;, &#39;</span><span style=color:#99c794>idle</span><span style=color:#5fb3b3>&#39;</span><span>)
</span><span>  )</span><span style=color:#5fb3b3>;
</span></code></pre><pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span> const mr_robot = createMachine({
</span><span>   idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;, action(show_loading))),
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  loading: invoke(
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>    get_quote, 
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>    transition(
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>      &#39;done&#39;,
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>      &#39;idle&#39;,
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>      reduce((ctx, ev) =&gt; ({ ...ctx, data: ev.data })),
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>      action(update_card)
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>    )
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  ),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  loading: load_quote(action(update_card))
</span><span> }, context);
</span></code></pre><p>Ahora la usamos para esconder el esqueleto de la carta en la primera carga y muestre la frase cuando esté lista.<pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span> const context = ev =&gt; ({
</span><span>   data: {},
</span><span>   dom: {
</span><span>     quote: document.querySelector(&#39;.card__quote&#39;),
</span><span>     author: document.querySelector(&#39;.card__author&#39;),
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>    loader: document.querySelector(&#39;.card__content--loader&#39;),
</span><span>     load_btn: window.load_btn,
</span><span>     tweet_btn: document.querySelector(&#39;.btn--tweet&#39;),
</span><span>     card: window.card
</span><span>   }
</span><span> });
</span></code></pre><pre data-lang=js style=background-color:#2b2c2f;color:#cccece class=language-js><code class=language-js data-lang=js><span style=color:#c594c5>function </span><span style=color:#69c>hide_loader</span><span style=color:#5fb3b3>({ </span><span style=color:#f99157>dom </span><span style=color:#5fb3b3>}) {
</span><span>  dom</span><span style=color:#5fb3b3>.</span><span>loader</span><span style=color:#5fb3b3>.</span><span>classList</span><span style=color:#5fb3b3>.</span><span style=color:#69c>add</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>hide</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span>  dom</span><span style=color:#5fb3b3>.</span><span>card</span><span style=color:#5fb3b3>.</span><span>classList</span><span style=color:#5fb3b3>.</span><span style=color:#69c>remove</span><span>(</span><span style=color:#5fb3b3>&#39;</span><span style=color:#99c794>hide</span><span style=color:#5fb3b3>&#39;</span><span>)</span><span style=color:#5fb3b3>;
</span><span style=color:#5fb3b3>}
</span></code></pre><pre data-lang=diff style=background-color:#2b2c2f;color:#cccece class=language-diff><code class=language-diff data-lang=diff><span> const mr_robot = createMachine({
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794>  empty: load_quote(action(update_card), action(hide_loader)),
</span><span>   idle: state(transition(&#39;fetch&#39;, &#39;loading&#39;, action(show_loading))),
</span><span>   loading: load_quote(action(update_card))
</span><span> }, context);
</span><span style=color:#5fb3b3>-
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67> const handler = ({ machine, context }) =&gt; {
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  console.log(JSON.stringify({ 
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>    state: machine.current,
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>    context
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67>  }));
</span><span style=color:#5fb3b3>-</span><span style=color:#ec5f67> }
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794> const handler = () =&gt; {};
</span><span>
</span><span> const { send } = interpret(mr_robot, handler);
</span><span style=color:#5fb3b3>+
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794> const fetch_quote = () =&gt; send(&#39;fetch&#39;);
</span><span style=color:#5fb3b3>+
</span><span style=color:#5fb3b3>+</span><span style=color:#99c794> window.load_btn.addEventListener(&#39;click&#39;, fetch_quote);
</span></code></pre><p>Veamos cómo quedó.<p class=codepen data-height=600 data-theme-id=dark data-default-tab=js,result data-user=VonHeikemen data-slug-hash=OJJvQzR data-preview=true style="height:600px;box-sizing:border-box;display:flex;align-items:center;justify-content:center;border:2px solid;margin:1em 0;padding:1em" data-pen-title="Finite Random Quote Machine"><span>See the Pen <a href=https://codepen.io/VonHeikemen/pen/OJJvQzR>Finite Random Quote Machine</a> by Heiker (<a href=https://codepen.io/VonHeikemen>@VonHeikemen</a>) on <a href=https://codepen.io>CodePen</a>.</span></p><script async src=https://static.codepen.io/assets/embed/ei.js></script><h2 id=entonces-esto-de-la-maquina-de-estados-finitos-fue-util>¿Entonces esto de la máquina de estados finitos fue útil?</h2><p>Eso espero. ¿Notaron que nos permitió hacer un montón de pruebas y planear el comportamiento incluso antes de crear el HTML? Me parece que eso es genial.<p>¿Intentaron darle click al botón 'loading' mientras cargaba? ¿Causó llamadas repetidas a <code>get_quote</code>? Eso es porque hicimos que fuera (casi) imposible que el evento <code>fetch</code> ocurriera durante <code>loading</code>.<p>No sólo eso, el comportamiento de la máquina y sus efectos en el mundo exterior están separados. Esto puede ser bueno o malo para ustedes pero eso depende de su tendencia filosófica.<h2 id=quieren-saber-mas>¿Quieren saber más?</h2><p>(me perdonan que todo estos sean en inglés.)<ul><li><a rel=noopener target=_blank href=https://xstate.js.org/docs/about/concepts.html>XState (concepts)</a><li><a rel=noopener target=_blank href=https://thisrobot.life/>robot3 - docs</a><li><a rel=noopener target=_blank href=https://www.freecodecamp.org/news/state-machines-basics-of-computer-science-d42855debc66/>Understanding State Machines</a></ul><hr><p>Gracias por su tiempo. Si este artículo les pareció útil y quieren apoyar mis esfuerzos para crear más contenido, pueden dejar una propina en buy me a coffee ☕.</p><a href=https://www.buymeacoffee.com/vonheikemen style=display:flex;justify-content:center target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-blue.png alt="Buy Me A Coffee" style=height:60px!important;width:217px!important></a></div></div>